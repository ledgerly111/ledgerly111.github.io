<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ledgerly - Business Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Dark Theme Colors
                        'primary': '#4f46e5',
                        'primary-hover': '#4338ca',
                        'secondary': '#1f2937',
                        'secondary-hover': '#374151',
                        'background': '#111827',
                        'surface': '#1f2937',
                        'text-primary': '#f9fafb',
                        'text-secondary': '#d1d5db',
                        'accent': '#34d399',
                        'danger': '#ef4444',
                        // Sepia Light Theme Colors
                        'sepia-bg': '#fdf6e3',
                        'sepia-surface': '#fbf1c7',
                        'sepia-text': '#654321', // Dark Brown
                        'sepia-text-secondary': '#8b5e34', // Lighter Brown
                        'sepia-primary': '#a16207', // Amber-700
                        'sepia-primary-hover': '#854d0e', // Amber-800
                        'sepia-border': '#d7c095',
                        'sepia-accent': '#16a34a', // Green-600
                        'sepia-danger': '#dc2626', // Red-600
                    },
                    keyframes: {
                        'fade-in-out': {
                            '0%': { opacity: '0', transform: 'translateY(-20px)' },
                            '10%': { opacity: '1', transform: 'translateY(0)' },
                            '90%': { opacity: '1', transform: 'translateY(0)' },
                            '100%': { opacity: '0', transform: 'translateY(-20px)' },
                        }
                    },
                    animation: {
                        'fade-in-out': 'fade-in-out 4s ease-in-out forwards',
                    }
                }
            }
        }
    </script>
    <style>
        /* Base styles are for Sepia Light Theme */
        body {
            background-color: #fdf6e3; /* sepia-bg */
            color: #654321; /* sepia-text */
        }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); }
        .tab-button.active { background-color: #a16207; /* sepia-primary */ color: white; }
        .task-completed { text-decoration: line-through; color: #a3a3a3; } /* Neutral grey for both themes */
        .prose { color: #654321; /* sepia-text */ }

        /* Dark Theme Overrides */
        .dark body { background-color: #111827; /* background */ color: #f9fafb; /* text-primary */ }
        .dark .tab-button.active { background-color: #4f46e5; /* primary */ }
        .dark .prose { color: #f9fafb; /* text-primary */ }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #fbf1c7; } /* sepia-surface */
        .dark ::-webkit-scrollbar-track { background: #1f2937; } /* surface */
        ::-webkit-scrollbar-thumb { background: #d7c095; border-radius: 4px; } /* sepia-border */
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
        ::-webkit-scrollbar-thumb:hover { background: #8b5e34; } /* sepia-text-secondary */
        .dark ::-webkit-scrollbar-thumb:hover { background: #718096; }
    </style>
</head>
<body class="antialiased font-sans">

    <div id="notification" class="fixed top-5 right-5 z-[100] text-white py-2 px-4 rounded-md shadow-lg opacity-0">
        <span id="notification-message"></span>
    </div>

    <div id="app" class="h-screen flex flex-col">
        <header id="main-header" class="bg-sepia-surface dark:bg-surface shadow-md p-4 flex justify-between items-center z-20 flex-shrink-0 hidden">
            <div class="flex items-center space-x-4">
                <i class="fas fa-book-open text-sepia-primary dark:text-primary text-2xl"></i>
                <h1 class="text-2xl font-bold text-sepia-text dark:text-text-primary">Ledgerly</h1>
                <button id="theme-toggle" class="text-sepia-text dark:text-text-primary text-xl px-2 py-1 rounded-md hover:bg-sepia-border dark:hover:bg-secondary">
                    <i id="theme-icon" class="fas"></i>
                </button>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sepia-text-secondary dark:text-text-secondary hidden md:inline">Current Employee:</span>
                <select id="employee-switcher" class="bg-sepia-bg dark:bg-secondary text-sepia-text dark:text-text-primary border border-sepia-border dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-sepia-primary dark:focus:ring-primary focus:outline-none"></select>
            </div>
        </header>

        <main id="main-content" class="flex-grow flex flex-col md:flex-row overflow-hidden hidden">
            <div class="w-full md:w-1/3 lg:w-1/4 bg-sepia-surface dark:bg-surface p-4 overflow-y-auto flex-shrink-0 border-r border-sepia-border dark:border-gray-700">
                <div id="company-overview-panel" class="mb-6">
                    <h2 class="text-xl font-semibold mb-3 text-sepia-text dark:text-text-primary flex items-center justify-between cursor-pointer" onclick="app.togglePanel('company-overview')">
                        <span><i class="fas fa-building mr-2 text-sepia-primary dark:text-primary"></i>Company Overview</span>
                        <i id="company-overview-toggle-icon" class="fas fa-chevron-down"></i>
                    </h2>
                    <div id="company-overview-content" class="space-y-4 hidden">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-sepia-text-secondary dark:text-text-secondary">Employees</h3>
                                <button class="bg-sepia-primary text-white px-2 py-1 rounded-md text-sm hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover" onclick="app.openModal('addEmployeeModal')">+ Add</button>
                            </div>
                            <ul id="employee-list" class="space-y-2 text-sm"></ul>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-sepia-text-secondary dark:text-text-secondary">Master Inventory</h3>
                                <div>
                                    <button class="bg-sepia-primary text-white px-2 py-1 rounded-md text-sm hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover mr-2" onclick="app.openModal('addProductModal')">+ Add</button>
                                    <button class="bg-green-600 text-white px-2 py-1 rounded-md text-sm hover:bg-green-700" onclick="app.openModal('delegateStockModal')">Delegate</button>
                                </div>
                            </div>
                            <div id="master-inventory-list" class="space-y-1 text-sm"></div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-sepia-text-secondary dark:text-text-secondary">All Tasks</h3>
                                <button class="bg-sepia-primary text-white px-2 py-1 rounded-md text-sm hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover" onclick="app.openModal('createTaskModal')">+ Create</button>
                            </div>
                            <ul id="all-tasks-list" class="space-y-2 text-sm"></ul>
                        </div>
                    </div>
                </div>

                <div id="ai-advisor-panel">
                    <h2 class="text-xl font-semibold mb-3 text-sepia-text dark:text-text-primary flex items-center justify-between cursor-pointer" onclick="app.togglePanel('ai-advisor')">
                        <span><i class="fas fa-brain mr-2 text-sepia-primary dark:text-primary"></i>Accura AI Advisor</span>
                        <i id="ai-advisor-toggle-icon" class="fas fa-chevron-down"></i>
                    </h2>
                    <div id="ai-advisor-content" class="space-y-4 hidden">
                        <div>
                            <label for="ai-employee-select" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary mb-1">Select Employee to Analyze</label>
                            <select id="ai-employee-select" class="w-full bg-sepia-bg dark:bg-secondary text-sepia-text dark:text-text-primary border border-sepia-border dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-sepia-primary dark:focus:ring-primary focus:outline-none"></select>
                        </div>
                        <button id="generate-plan-btn" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover flex items-center justify-center" onclick="app.generateAIPlan()">
                            <span id="generate-plan-text">Generate Plan</span>
                            <i id="generate-plan-loader" class="fas fa-spinner fa-spin hidden ml-2"></i>
                        </button>
                        <div id="ai-plan-output" class="mt-4 p-3 bg-sepia-bg dark:bg-secondary rounded-md text-sm prose max-w-none">
                            <p class="text-sepia-text-secondary dark:text-gray-400">Your generated profit improvement plan will appear here.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="employee-view" class="flex-grow p-2 md:p-6 overflow-y-auto">
                <div class="mb-6 border-b border-sepia-border dark:border-gray-700">
                    <nav class="flex flex-wrap -mb-px" id="tabs-container">
                        </nav>
                </div>
                <div id="tab-content-container">
                    <div id="dashboard-content" class="tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                           <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
                               <h3 class="text-lg font-medium text-sepia-text-secondary dark:text-text-secondary">Total Revenue</h3>
                               <p id="dashboard-revenue" class="text-3xl font-bold text-sepia-accent dark:text-accent mt-2">$0.00</p>
                           </div>
                           <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
                               <h3 class="text-lg font-medium text-sepia-text-secondary dark:text-text-secondary">Total Expenses</h3>
                               <p id="dashboard-expenses" class="text-3xl font-bold text-sepia-danger dark:text-danger mt-2">$0.00</p>
                           </div>
                           <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
                               <h3 class="text-lg font-medium text-sepia-text-secondary dark:text-text-secondary">Net Profit</h3>
                               <p id="dashboard-profit" class="text-3xl font-bold text-sepia-text dark:text-text-primary mt-2">$0.00</p>
                           </div>
                        </div>
                    </div>
                    <div id="my-tasks-content" class="tab-content hidden">
                        <h2 class="text-2xl font-bold mb-4">My Assigned Tasks</h2>
                        <ul id="employee-tasks-list" class="space-y-3"></ul>
                    </div>
                    <div id="my-inventory-content" class="tab-content hidden">
                        <h2 class="text-2xl font-bold mb-4">My Delegated Inventory</h2>
                        <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow overflow-hidden">
                           <table class="min-w-full">
                               <thead class="bg-sepia-bg dark:bg-secondary">
                                   <tr>
                                       <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Product Name</th>
                                       <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Stock</th>
                                   </tr>
                               </thead>
                               <tbody id="employee-inventory-list" class="divide-y divide-sepia-border dark:divide-gray-700"></tbody>
                           </table>
                        </div>
                    </div>
                    <div id="sales-expenses-content" class="tab-content hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-bold mb-4">Record a Sale</h2>
                            <form id="record-sale-form" class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="sale-store" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Store</label>
                                        <select id="sale-store" name="storeId" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary"></select>
                                    </div>
                                    <div>
                                        <label for="sale-type" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Sale Type</label>
                                        <select id="sale-type" name="saleType" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary"></select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="sale-product" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Product</label>
                                        <select id="sale-product" name="productId" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary"></select>
                                    </div>
                                    <div>
                                        <label for="sale-quantity" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Quantity</label>
                                        <input type="number" id="sale-quantity" name="quantity" value="1" min="1" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary">
                                    </div>
                                </div>
                                <div id="discount-container" class="hidden">
                                    <label for="sale-discount" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Discount ($)</label>
                                    <input type="number" id="sale-discount" name="discount" step="0.01" min="0" class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary">
                                </div>
                                <div class="p-3 bg-sepia-bg dark:bg-secondary rounded-md space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-sepia-text-secondary dark:text-text-secondary">Total Price:</span>
                                        <span id="sale-total-price" class="font-medium text-sepia-text dark:text-text-primary">$0.00</span>
                                    </div>
                                    <div>
                                        <label for="sale-amount" class="block text-sm font-bold text-sepia-text-secondary dark:text-text-secondary">Final Amount ($)</label>
                                        <input type="number" id="sale-amount" name="amount" step="0.01" required readonly class="mt-1 block w-full bg-sepia-border/50 dark:bg-gray-700 border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary font-bold focus:outline-none">
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Record Sale</button>
                            </form>
                        </div>
                        <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-bold mb-4">Record an Expense</h2>
                            <form id="record-expense-form" class="space-y-4">
                                <div>
                                    <label for="expense-description" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Description</label>
                                    <input type="text" id="expense-description" name="description" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                                </div>
                                <div>
                                    <label for="expense-amount" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Amount ($)</label>
                                    <input type="number" id="expense-amount" name="amount" step="0.01" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                                </div>
                                <button type="submit" class="w-full bg-sepia-danger text-white py-2 rounded-md hover:bg-red-700 dark:bg-danger">Record Expense</button>
                            </form>
                        </div>
                    </div>
                     <div id="stores-content" class="tab-content hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
                                <h2 class="text-2xl font-bold mb-4">Add a New Store</h2>
                                <form id="employee-add-store-form" class="space-y-4">
                                    <div>
                                        <label for="employee-new-store-name" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Store Name / Location</label>
                                        <input type="text" id="employee-new-store-name" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                                    </div>
                                    <div>
                                        <label for="employee-new-store-credit" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Store Credit ($) (Optional)</label>
                                        <input type="number" id="employee-new-store-credit" step="0.01" min="0" class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                                    </div>
                                    <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Add Store</button>
                                </form>
                            </div>
                            <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
                                <h2 class="text-2xl font-bold mb-4">All Stores</h2>
                                <div id="employee-view-store-list" class="space-y-3 max-h-96 overflow-y-auto">
                                    </div>
                            </div>
                        </div>
                    </div>
                     <div id="invoices-content" class="tab-content hidden">
                        <h2 class="text-2xl font-bold mb-4">Generate Sales Receipt</h2>
                        <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
                            <form id="invoice-form" class="grid grid-cols-1 gap-6">
                                <div>
                                    <h3 class="text-lg font-semibold mb-3">Select Uninvoiced Sales</h3>
                                    <div id="uninvoiced-sales-list" class="space-y-2 max-h-60 overflow-y-auto p-2 bg-sepia-bg dark:bg-secondary rounded-md border border-sepia-border dark:border-gray-600">
                                        <p class="text-sepia-text-secondary dark:text-gray-400">No uninvoiced sales found.</p>
                                    </div>
                                </div>
                                <div>
                                     <button id="generate-pdf-btn" type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover flex items-center justify-center">
                                        <span id="generate-pdf-text">Generate & Download PDF Receipt</span>
                                        <i id="generate-pdf-loader" class="fas fa-spinner fa-spin hidden ml-2"></i>
                                     </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div id="ledger-content" class="tab-content hidden">
                        <h2 class="text-2xl font-bold mb-4">Transaction Ledger</h2>
                        <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow overflow-hidden">
                           <table class="min-w-full">
                               <thead class="bg-sepia-bg dark:bg-secondary">
                                   <tr>
                                       <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Date</th>
                                       <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Type</th>
                                       <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Description</th>
                                       <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Amount</th>
                                   </tr>
                               </thead>
                               <tbody id="ledger-list" class="divide-y divide-sepia-border dark:divide-gray-700"></tbody>
                           </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-container">
        <div id="firstTimeModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
            <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md">
                <h2 class="text-2xl font-bold mb-2 text-sepia-text dark:text-text-primary">Welcome to Ledgerly!</h2>
                <p class="text-sepia-text-secondary dark:text-text-secondary mb-6">Let's set up your first employee profile to get started.</p>
                <form id="first-employee-form">
                    <div class="mb-4">
                        <label for="first-employee-name" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Employee Name</label>
                        <input type="text" id="first-employee-name" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <div class="mb-6">
                        <label for="first-employee-position" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Position / Role</label>
                        <input type="text" id="first-employee-position" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Create Profile & Start</button>
                </form>
            </div>
        </div>

        <div id="addEmployeeModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
            <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
                <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('addEmployeeModal')"><i class="fas fa-times"></i></button>
                <h2 class="text-2xl font-bold mb-6 text-sepia-text dark:text-text-primary">Add New Employee</h2>
                <form id="add-employee-form">
                     <div class="mb-4">
                        <label for="new-employee-name" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Employee Name</label>
                        <input type="text" id="new-employee-name" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <div class="mb-6">
                        <label for="new-employee-position" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Position / Role</label>
                        <input type="text" id="new-employee-position" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Add Employee</button>
                </form>
            </div>
        </div>
        
        <div id="editEmployeeModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
            <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
                <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('editEmployeeModal')"><i class="fas fa-times"></i></button>
                <h2 class="text-2xl font-bold mb-6 text-sepia-text dark:text-text-primary">Edit Employee</h2>
                <form id="edit-employee-form" class="space-y-4">
                    <input type="hidden" id="edit-employee-id">
                     <div class="mb-4">
                        <label for="edit-employee-name" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Employee Name</label>
                        <input type="text" id="edit-employee-name" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <div class="mb-6">
                        <label for="edit-employee-position" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Position / Role</label>
                        <input type="text" id="edit-employee-position" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Save Changes</button>
                </form>
            </div>
        </div>

        <div id="editStoreModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
            <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
                <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('editStoreModal')"><i class="fas fa-times"></i></button>
                <h2 class="text-2xl font-bold mb-6 text-sepia-text dark:text-text-primary">Edit Store</h2>
                <form id="edit-store-form" class="space-y-4">
                    <input type="hidden" id="edit-store-id">
                    <div>
                        <label for="edit-store-name" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Store Name / Location</label>
                        <input type="text" id="edit-store-name" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <div>
                        <label for="edit-store-credit" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Store Credit ($)</label>
                        <input type="number" id="edit-store-credit" step="0.01" min="0" class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Save Changes</button>
                </form>
            </div>
        </div>
        
        <div id="addProductModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
            <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
                <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('addProductModal')"><i class="fas fa-times"></i></button>
                <h2 class="text-2xl font-bold mb-6 text-sepia-text dark:text-text-primary">Add New Product</h2>
                <form id="add-product-form">
                     <div class="mb-4">
                        <label for="new-product-name" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Product Name</label>
                        <input type="text" id="new-product-name" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <div class="mb-4">
                        <label for="new-product-price" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Price ($)</label>
                        <input type="number" step="0.01" id="new-product-price" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                     <div class="mb-6">
                        <label for="new-product-stock" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Initial Stock</label>
                        <input type="number" id="new-product-stock" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Add Product</button>
                </form>
            </div>
        </div>

        <div id="delegateStockModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
            <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
                <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('delegateStockModal')"><i class="fas fa-times"></i></button>
                <h2 class="text-2xl font-bold mb-6 text-sepia-text dark:text-text-primary">Delegate Stock to Employee</h2>
                <form id="delegate-stock-form">
                     <div class="mb-4">
                        <label for="delegate-employee" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Employee</label>
                        <select id="delegate-employee" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary"></select>
                    </div>
                    <div class="mb-4">
                        <label for="delegate-product" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Product</label>
                         <select id="delegate-product" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary"></select>
                    </div>
                     <div class="mb-6">
                        <label for="delegate-quantity" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Quantity</label>
                        <input type="number" id="delegate-quantity" min="1" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Delegate Stock</button>
                </form>
            </div>
        </div>
        
        <div id="createTaskModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
            <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
                <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('createTaskModal')"><i class="fas fa-times"></i></button>
                <h2 class="text-2xl font-bold mb-6 text-sepia-text dark:text-text-primary">Create New Task</h2>
                <form id="create-task-form">
                     <div class="mb-4">
                        <label for="new-task-description" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Task Description</label>
                        <input type="text" id="new-task-description" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <div class="mb-6">
                        <label for="new-task-assignee" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Assign To</label>
                        <select id="new-task-assignee" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary"></select>
                    </div>
                    <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Create Task</button>
                </form>
            </div>
        </div>
    </div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {

    const app = {
        // --- STATE ---
        state: {
            theme: 'dark',
            currentEmployeeId: null,
            employees: [],
            stores: [],
            masterInventory: [],
            tasks: [],
        },
        
        // --- API KEYS ---
        pdfShiftApiKey: 'Sk_4e4b1acfcab0c0454d642ef6701891a8d318d648',

        // --- INITIALIZATION ---
        init() {
            this.loadState();
            this.applyTheme();
            this.addEventListeners();

            if (this.state.employees.length === 0) {
                this.showFirstTimeSetup();
            } else {
                this.showMainApp();
                if (!this.state.currentEmployeeId || !this.getEmployee(this.state.currentEmployeeId)?.isActive) {
                    const firstActiveEmployee = this.state.employees.find(e => e.isActive);
                    this.state.currentEmployeeId = firstActiveEmployee ? firstActiveEmployee.id : null;
                }
                this.render();
            }
        },
        
        showFirstTimeSetup() {
            document.getElementById('firstTimeModal').classList.remove('hidden');
        },
        
        showMainApp() {
            document.getElementById('firstTimeModal').classList.add('hidden');
            document.getElementById('main-header').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('main-content').classList.add('flex');
        },

        // --- STATE MANAGEMENT ---
        saveState() {
            localStorage.setItem('ledgerlyState', JSON.stringify(this.state));
        },

        loadState() {
            const savedState = localStorage.getItem('ledgerlyState');
            if (savedState) {
                this.state = Object.assign({}, this.state, JSON.parse(savedState));
                // Backwards compatibility for old data
                this.state.stores.forEach(store => {
                    if (store.credit === undefined) store.credit = 0;
                });
                this.state.employees.forEach(emp => {
                    if (emp.isActive === undefined) emp.isActive = true;
                });
            }
        },
        
        // --- DATA HELPERS ---
        getEmployee(employeeId) {
            return this.state.employees.find(e => e.id === employeeId);
        },
        getActiveEmployees() {
            return this.state.employees.filter(e => e.isActive);
        },
        getProduct(productId) {
            return this.state.masterInventory.find(p => p.id === productId);
        },
        getStore(storeId) {
            return this.state.stores.find(s => s.id === storeId);
        },
        
        // --- EVENT LISTENERS ---
        addEventListeners() {
            document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());
            document.getElementById('first-employee-form').addEventListener('submit', e => this.handleFirstEmployee(e));
            document.getElementById('employee-switcher').addEventListener('change', e => this.handleEmployeeSwitch(e));
            document.getElementById('tabs-container').addEventListener('click', e => this.handleTabClick(e));
            document.getElementById('add-employee-form').addEventListener('submit', e => this.handleAddEmployee(e));
            document.getElementById('edit-employee-form').addEventListener('submit', e => this.handleUpdateEmployee(e));
            document.getElementById('employee-add-store-form').addEventListener('submit', e => this.handleAddStore(e));
            document.getElementById('edit-store-form').addEventListener('submit', e => this.handleUpdateStore(e));
            document.getElementById('add-product-form').addEventListener('submit', e => this.handleAddProduct(e));
            document.getElementById('delegate-stock-form').addEventListener('submit', e => this.handleDelegateStock(e));
            document.getElementById('create-task-form').addEventListener('submit', e => this.handleCreateTask(e));
            document.getElementById('record-sale-form').addEventListener('submit', e => this.handleRecordSale(e));
            document.getElementById('record-expense-form').addEventListener('submit', e => this.handleRecordExpense(e));
            document.getElementById('invoice-form').addEventListener('submit', e => this.handleGenerateInvoice(e));

            // Listeners for dynamic sale form
            document.getElementById('sale-type').addEventListener('change', () => this.handleSaleTypeChange());
            document.getElementById('sale-product').addEventListener('change', () => this.updateFinalSaleAmount());
            document.getElementById('sale-quantity').addEventListener('input', () => this.updateFinalSaleAmount());
            document.getElementById('sale-discount').addEventListener('input', () => this.updateFinalSaleAmount());
        },

        handleFirstEmployee(e) {
            e.preventDefault();
            const name = document.getElementById('first-employee-name').value;
            const position = document.getElementById('first-employee-position').value;
            if (!name || !position) return;
            const newEmployee = this.createEmployee(name, position);
            this.state.employees.push(newEmployee);
            this.state.currentEmployeeId = newEmployee.id;
            this.saveState();
            this.showMainApp();
            this.render();
            this.showNotification(`Welcome, ${name}! Your profile is ready.`, 'success');
        },
        handleEmployeeSwitch(e) {
            this.state.currentEmployeeId = e.target.value;
            this.saveState();
            this.render();
        },
        handleTabClick(e) {
            const button = e.target.closest('.tab-button');
            if (button) {
                this.setActiveTab(button.dataset.tab);
            }
        },

        // --- UI RENDERING ---
        render() {
            if (this.getActiveEmployees().length === 0 && this.state.employees.length > 0) {
                 document.getElementById('main-header').classList.remove('hidden');
                 document.getElementById('main-content').innerHTML = `<div class="p-8 text-center w-full"><h2 class="text-2xl font-bold mb-4">All employees are inactive.</h2><p class="text-sepia-text-secondary dark:text-text-secondary">Please reactivate an employee or clear localStorage to restart.</p></div>`;
                 document.getElementById('main-content').classList.remove('hidden');
                 this.renderEmployeeSwitcher(); // Still render switcher to show inactive ones
                 return;
            } else if (this.state.employees.length === 0) {
                 this.showFirstTimeSetup();
                 return;
            }

            this.showMainApp();
            this.renderEmployeeSwitcher();
            this.renderCompanyOverview();
            this.renderAIAdvisorPanel();
            this.renderTabs();
            this.setActiveTab(document.querySelector('.tab-button.active')?.dataset.tab || 'dashboard');
        },

        renderEmployeeSwitcher() {
            const switcher = document.getElementById('employee-switcher');
            const activeEmployees = this.getActiveEmployees();
            if(activeEmployees.length > 0) {
                switcher.innerHTML = activeEmployees.map(emp => 
                    `<option value="${emp.id}" ${emp.id === this.state.currentEmployeeId ? 'selected' : ''}>${emp.name}</option>`
                ).join('');
                switcher.disabled = false;
            } else {
                switcher.innerHTML = `<option>No active employees</option>`;
                switcher.disabled = true;
            }
        },
        
        renderCompanyOverview() {
            const employeeList = document.getElementById('employee-list');
            employeeList.innerHTML = this.getActiveEmployees().map(emp => 
                `<li class="flex justify-between items-center bg-sepia-bg dark:bg-secondary p-2 rounded">
                    <div>
                        <span class="text-sepia-text dark:text-text-primary">${emp.name}</span>
                        <em class="text-sepia-text-secondary dark:text-gray-400 text-xs ml-1">(${emp.position})</em>
                    </div>
                    <div class="flex space-x-3">
                        <button class="text-sm text-sepia-text-secondary hover:text-sepia-primary dark:text-text-secondary dark:hover:text-primary" onclick="app.startEditEmployee('${emp.id}')"><i class="fas fa-pencil-alt"></i></button>
                        <button class="text-sm text-sepia-text-secondary hover:text-sepia-danger dark:text-text-secondary dark:hover:text-danger" onclick="app.deactivateEmployee('${emp.id}')"><i class="fas fa-user-slash"></i></button>
                    </div>
                </li>`
            ).join('') || `<p class="text-sepia-text-secondary dark:text-gray-400 text-sm">No active employees yet.</p>`;

            const inventoryList = document.getElementById('master-inventory-list');
            inventoryList.innerHTML = this.state.masterInventory.map(prod => `
                <div class="flex justify-between items-center bg-sepia-bg dark:bg-secondary p-2 rounded">
                    <span class="text-sepia-text dark:text-text-primary">${prod.name}</span>
                    <span class="font-mono text-xs bg-sepia-border dark:bg-gray-700 px-2 py-1 rounded">${prod.stock}</span>
                </div>`
            ).join('') || `<p class="text-sepia-text-secondary dark:text-gray-400 text-sm">No products in inventory.</p>`;

            const allTasksList = document.getElementById('all-tasks-list');
            allTasksList.innerHTML = this.state.tasks.map(task => {
                const assignee = this.getEmployee(task.assigneeId);
                return `<li class="bg-sepia-bg dark:bg-secondary p-2 rounded text-sepia-text dark:text-gray-300 ${task.status === 'Completed' ? 'task-completed' : ''}">
                    <p>${task.description}</p>
                    <small class="text-sepia-text-secondary dark:text-gray-400">Assigned to: ${assignee ? assignee.name : 'Unassigned'}</small>
                </li>`
            }).join('') || `<p class="text-sepia-text-secondary dark:text-gray-400 text-sm">No tasks created.</p>`;
        },
        
        renderAIAdvisorPanel() {
             const aiSwitcher = document.getElementById('ai-employee-select');
             aiSwitcher.innerHTML = this.getActiveEmployees().map(emp => 
                `<option value="${emp.id}">${emp.name}</option>`
            ).join('');
        },

        renderTabs() {
            const tabs = [
                { id: 'dashboard', name: 'Dashboard', icon: 'fa-chart-line' },
                { id: 'my-tasks', name: 'My Tasks', icon: 'fa-tasks' },
                { id: 'my-inventory', name: 'My Inventory', icon: 'fa-boxes' },
                { id: 'sales-expenses', name: 'Sales & Expenses', icon: 'fa-exchange-alt' },
                { id: 'stores', name: 'Manage Stores', icon: 'fa-store' },
                { id: 'invoices', name: 'Invoices', icon: 'fa-file-invoice-dollar' },
                { id: 'ledger', name: 'Ledger', icon: 'fa-history' },
            ];
            document.getElementById('tabs-container').innerHTML = tabs.map(tab => `
                <button data-tab="${tab.id}" class="tab-button text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary hover:bg-sepia-surface dark:hover:bg-secondary py-3 px-4 font-medium text-sm rounded-t-lg">
                    <i class="fas ${tab.icon} mr-2 hidden md:inline"></i>${tab.name}
                </button>
            `).join('');
        },
        
        renderDashboard() {
            const employee = this.getEmployee(this.state.currentEmployeeId);
            if (!employee) return;
            const revenue = employee.transactions.filter(t => t.type === 'sale').reduce((sum, t) => sum + t.amount, 0);
            const expenses = employee.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const profit = revenue - expenses;
            document.getElementById('dashboard-revenue').textContent = `$${revenue.toFixed(2)}`;
            document.getElementById('dashboard-expenses').textContent = `$${expenses.toFixed(2)}`;
            document.getElementById('dashboard-profit').textContent = `$${profit.toFixed(2)}`;
            document.getElementById('dashboard-profit').classList.toggle('text-sepia-danger', profit < 0);
            document.getElementById('dashboard-profit').classList.toggle('dark:text-danger', profit < 0);
        },
        
        renderMyTasks() {
            const employeeTasks = this.state.tasks.filter(t => t.assigneeId === this.state.currentEmployeeId);
            document.getElementById('employee-tasks-list').innerHTML = employeeTasks.map(task => `
                <li class="bg-sepia-surface dark:bg-surface p-4 rounded-lg shadow flex justify-between items-center ${task.status === 'Completed' ? 'task-completed' : ''}">
                    <span class="text-sepia-text dark:text-text-primary">${task.description}</span>
                    <button class="text-white px-3 py-1 rounded-md text-sm ${task.status === 'Completed' ? 'bg-gray-500' : 'bg-green-600 hover:bg-green-700'}" onclick="app.toggleTaskStatus('${task.id}')">
                        ${task.status === 'Completed' ? 'Reopen' : 'Complete'}
                    </button>
                </li>
            `).join('') || `<p class="text-sepia-text-secondary dark:text-gray-400">You have no assigned tasks.</p>`;
        },
        
        renderMyInventory() {
            const employee = this.getEmployee(this.state.currentEmployeeId);
            const listEl = document.getElementById('employee-inventory-list');
            if (!employee || !employee.inventory || employee.inventory.length === 0) {
                 listEl.innerHTML = `<tr><td colspan="2" class="px-6 py-4 text-center text-sepia-text-secondary dark:text-gray-400">No inventory delegated to you.</td></tr>`;
                 return;
            }
            listEl.innerHTML = employee.inventory.map(item => {
                const product = this.getProduct(item.productId);
                return `
                    <tr class="hover:bg-sepia-bg dark:hover:bg-secondary">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text dark:text-text-primary">${product ? product.name : 'Unknown Product'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text-secondary dark:text-text-secondary">${item.stock}</td>
                    </tr>
                `;
            }).join('');
        },
        
        renderSalesAndExpenses() {
            const employee = this.getEmployee(this.state.currentEmployeeId);
            const saleProductSelect = document.getElementById('sale-product');
            const saleStoreSelect = document.getElementById('sale-store');
            const saleTypeSelect = document.getElementById('sale-type');

            saleTypeSelect.innerHTML = `<option>Cash</option><option>Credit</option><option>Deal</option>`;
            
            if (this.state.stores.length === 0) {
                saleStoreSelect.innerHTML = `<option disabled selected>Add a store first</option>`;
                saleStoreSelect.disabled = true;
            } else {
                saleStoreSelect.innerHTML = this.state.stores.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                saleStoreSelect.disabled = false;
            }

            if (!employee || !employee.inventory || employee.inventory.length === 0) {
                saleProductSelect.innerHTML = `<option disabled selected>No inventory to sell</option>`;
                saleProductSelect.disabled = true;
            } else {
                 saleProductSelect.innerHTML = employee.inventory.filter(item => item.stock > 0).map(item => {
                    const product = this.getProduct(item.productId);
                    return `<option value="${product.id}">${product.name} (Stock: ${item.stock})</option>`;
                 }).join('');
                saleProductSelect.disabled = false;
            }
            document.querySelector('#record-sale-form button').disabled = !(this.state.stores.length > 0 && employee?.inventory?.some(i => i.stock > 0));
            this.updateFinalSaleAmount();
        },
        
        renderStoresTab() {
            const listEl = document.getElementById('employee-view-store-list');
            if (this.state.stores.length === 0) {
                listEl.innerHTML = `<p class="text-sepia-text-secondary dark:text-gray-400">No stores have been added yet.</p>`;
                return;
            }
            const sortedStores = [...this.state.stores].sort((a, b) => (b.credit || 0) - (a.credit || 0));
            listEl.innerHTML = sortedStores.map(store =>
                `<div class="flex justify-between items-center bg-sepia-bg dark:bg-secondary p-3 rounded">
                    <div>
                        <span class="text-sepia-text dark:text-text-primary font-medium">${store.name}</span>
                        <div class="font-mono text-sm text-sepia-accent dark:text-accent">Credit: $${(store.credit || 0).toFixed(2)}</div>
                    </div>
                    <div class="flex space-x-3">
                        <button class="text-sepia-text-secondary hover:text-sepia-primary dark:text-text-secondary dark:hover:text-primary" onclick="app.startEditStore('${store.id}')"><i class="fas fa-pencil-alt"></i></button>
                        <button class="text-sepia-text-secondary hover:text-sepia-danger dark:text-text-secondary dark:hover:text-danger" onclick="app.deleteStore('${store.id}')"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>`
            ).join('');
        },

        renderInvoices() {
            const employee = this.getEmployee(this.state.currentEmployeeId);
            const listEl = document.getElementById('uninvoiced-sales-list');
            if (!employee) return;
            const uninvoicedSales = employee.transactions.filter(t => t.type === 'sale' && !t.invoiced);
            if (uninvoicedSales.length === 0) {
                listEl.innerHTML = `<p class="text-sepia-text-secondary dark:text-gray-400 p-2">No uninvoiced sales found.</p>`;
                document.getElementById('generate-pdf-btn').disabled = true;
            } else {
                 document.getElementById('generate-pdf-btn').disabled = false;
                 listEl.innerHTML = uninvoicedSales.map(sale => {
                    const product = this.getProduct(sale.productId);
                    return `
                        <label class="flex items-center space-x-3 p-2 bg-sepia-surface dark:bg-gray-700 rounded-md hover:bg-sepia-border dark:hover:bg-gray-600 cursor-pointer">
                            <input type="checkbox" name="invoice-sale" value="${sale.id}" class="form-checkbox h-5 w-5 text-sepia-primary dark:text-primary bg-sepia-bg dark:bg-secondary border-sepia-border dark:border-gray-600 rounded focus:ring-sepia-primary dark:focus:ring-primary">
                            <span class="text-sm text-sepia-text dark:text-text-primary">${new Date(sale.date).toLocaleDateString()}: ${product.name} - $${sale.amount.toFixed(2)}</span>
                        </label>`;
                 }).join('');
            }
        },

        renderLedger() {
            const employee = this.getEmployee(this.state.currentEmployeeId);
            const listEl = document.getElementById('ledger-list');
            if (!employee || employee.transactions.length === 0) {
                listEl.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-sepia-text-secondary dark:text-gray-400">No transactions recorded yet.</td></tr>`;
                return;
            }
            const sortedTransactions = [...employee.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            listEl.innerHTML = sortedTransactions.map(t => {
                const isSale = t.type === 'sale';
                let description = '';
                if(isSale) {
                    const product = this.getProduct(t.productId);
                    const store = this.getStore(t.storeId);
                    let discountInfo = t.discount > 0 ? `($${t.discount.toFixed(2)} off)` : '';
                    description = `${t.quantity}x ${product?.name || 'N/A'} at ${store?.name || 'Deleted Store'} (${t.saleType}) ${discountInfo}`;
                } else {
                    description = t.description;
                }
                const amountClass = isSale ? 'text-sepia-accent dark:text-accent' : 'text-sepia-danger dark:text-danger';
                return `
                    <tr class="hover:bg-sepia-bg dark:hover:bg-secondary">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text-secondary dark:text-text-secondary">${new Date(t.date).toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text-secondary dark:text-text-secondary capitalize">${t.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text dark:text-text-primary">${description}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${amountClass}">${isSale ? '+' : '-'}$${t.amount.toFixed(2)}</td>
                    </tr>`;
            }).join('');
        },

        // --- UI LOGIC ---
        applyTheme() {
            const themeIcon = document.getElementById('theme-icon');
            if (this.state.theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                document.documentElement.classList.remove('dark');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        },
        toggleTheme() {
            this.state.theme = this.state.theme === 'dark' ? 'light' : 'dark';
            this.applyTheme();
            this.saveState();
        },
        setActiveTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            switch(tabName) {
                case 'dashboard': this.renderDashboard(); break;
                case 'my-tasks': this.renderMyTasks(); break;
                case 'my-inventory': this.renderMyInventory(); break;
                case 'sales-expenses': this.renderSalesAndExpenses(); break;
                case 'stores': this.renderStoresTab(); break;
                case 'invoices': this.renderInvoices(); break;
                case 'ledger': this.renderLedger(); break;
            }
        },
        openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            const activeEmployees = this.getActiveEmployees();
            if (modalId === 'delegateStockModal') {
                document.getElementById('delegate-employee').innerHTML = activeEmployees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
                document.getElementById('delegate-product').innerHTML = this.state.masterInventory.map(p => `<option value="${p.id}">${p.name} (Stock: ${p.stock})</option>`).join('');
            } else if (modalId === 'createTaskModal') {
                document.getElementById('new-task-assignee').innerHTML = activeEmployees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            }
            modal.classList.remove('hidden');
        },
        closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        },
        togglePanel(panelName) {
            const content = document.getElementById(`${panelName}-content`);
            const icon = document.getElementById(`${panelName}-toggle-icon`);
            content.classList.toggle('hidden');
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-up');
        },
        showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            document.getElementById('notification-message').textContent = message;
            notification.className = 'fixed top-5 right-5 z-[100] text-white py-2 px-4 rounded-md shadow-lg';
            notification.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
            void notification.offsetWidth; 
            notification.classList.add('animate-fade-in-out');
        },
        handleSaleTypeChange() {
            const saleType = document.getElementById('sale-type').value;
            const discountContainer = document.getElementById('discount-container');
            if (saleType === 'Deal') {
                discountContainer.classList.remove('hidden');
            } else {
                discountContainer.classList.add('hidden');
                document.getElementById('sale-discount').value = '';
            }
            this.updateFinalSaleAmount();
        },
        updateFinalSaleAmount() {
            const productId = document.getElementById('sale-product').value;
            const quantity = parseInt(document.getElementById('sale-quantity').value, 10) || 0;
            const discount = parseFloat(document.getElementById('sale-discount').value) || 0;
            const product = this.getProduct(productId);

            if (!product || quantity <= 0) {
                document.getElementById('sale-total-price').textContent = '$0.00';
                document.getElementById('sale-amount').value = '0.00';
                return;
            }

            const totalPrice = product.price * quantity;
            const finalAmount = totalPrice - discount;

            document.getElementById('sale-total-price').textContent = `$${totalPrice.toFixed(2)}`;
            document.getElementById('sale-amount').value = finalAmount.toFixed(2);
        },
        
        // --- ACTION HANDLERS ---
        createEmployee(name, position) {
            return { id: `emp_${Date.now()}`, name, position, isActive: true, inventory: [], transactions: [] };
        },
        handleAddEmployee(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.querySelector('#new-employee-name').value;
            const position = form.querySelector('#new-employee-position').value;
            if (!name || !position) return;
            this.state.employees.push(this.createEmployee(name, position));
            this.saveState();
            this.render();
            form.reset();
            this.closeModal('addEmployeeModal');
            this.showNotification(`Employee '${name}' added.`, 'success');
        },
        startEditEmployee(employeeId) {
            const employee = this.getEmployee(employeeId);
            if (!employee) return;
            document.getElementById('edit-employee-id').value = employee.id;
            document.getElementById('edit-employee-name').value = employee.name;
            document.getElementById('edit-employee-position').value = employee.position;
            this.openModal('editEmployeeModal');
        },
        handleUpdateEmployee(e) {
            e.preventDefault();
            const employeeId = document.getElementById('edit-employee-id').value;
            const employee = this.getEmployee(employeeId);
            if (!employee) return;
            employee.name = document.getElementById('edit-employee-name').value;
            employee.position = document.getElementById('edit-employee-position').value;
            this.saveState();
            this.render();
            this.closeModal('editEmployeeModal');
            this.showNotification('Employee details updated.', 'success');
        },
        deactivateEmployee(employeeId) {
            if (confirm('Deactivate this employee? Their data will be saved, but they will be hidden.')) {
                const employee = this.getEmployee(employeeId);
                if (employee) {
                    employee.isActive = false;
                    if (this.state.currentEmployeeId === employeeId) {
                        const firstActive = this.getActiveEmployees()[0];
                        this.state.currentEmployeeId = firstActive ? firstActive.id : null;
                    }
                    this.saveState();
                    this.render();
                    this.showNotification(`${employee.name} has been deactivated.`, 'success');
                }
            }
        },
        handleAddStore(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.querySelector('#employee-new-store-name').value;
            const credit = parseFloat(form.querySelector('#employee-new-store-credit').value) || 0;
            if (!name) return;
            this.state.stores.push({ id: `store_${Date.now()}`, name, credit });
            this.saveState();
            this.renderStoresTab();
            this.renderSalesAndExpenses(); 
            form.reset();
            this.showNotification(`Store '${name}' added.`, 'success');
        },
        startEditStore(storeId) {
            const store = this.getStore(storeId);
            if (!store) return;
            document.getElementById('edit-store-id').value = store.id;
            document.getElementById('edit-store-name').value = store.name;
            document.getElementById('edit-store-credit').value = store.credit || 0;
            this.openModal('editStoreModal');
        },
        handleUpdateStore(e) {
            e.preventDefault();
            const storeId = document.getElementById('edit-store-id').value;
            const store = this.getStore(storeId);
            if (!store) return;
            store.name = document.getElementById('edit-store-name').value;
            store.credit = parseFloat(document.getElementById('edit-store-credit').value) || 0;
            this.saveState();
            this.renderStoresTab();
            this.renderSalesAndExpenses();
            this.closeModal('editStoreModal');
            this.showNotification('Store details updated.', 'success');
        },
        deleteStore(storeId) {
            if (confirm('Delete this store? This action cannot be undone.')) {
                this.state.stores = this.state.stores.filter(s => s.id !== storeId);
                this.saveState();
                this.renderStoresTab();
                this.renderSalesAndExpenses();
                this.showNotification('Store deleted.', 'success');
            }
        },
        handleAddProduct(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.querySelector('#new-product-name').value;
            const price = parseFloat(form.querySelector('#new-product-price').value);
            const stock = parseInt(form.querySelector('#new-product-stock').value, 10);
            if (!name || isNaN(price) || isNaN(stock)) return;
            this.state.masterInventory.push({ id: `prod_${Date.now()}`, name, price, stock });
            this.saveState();
            this.render();
            form.reset();
            this.closeModal('addProductModal');
            this.showNotification(`Product '${name}' added.`, 'success');
        },
        handleDelegateStock(e) {
            e.preventDefault();
            const form = e.target;
            const employeeId = form.querySelector('#delegate-employee').value;
            const productId = form.querySelector('#delegate-product').value;
            const quantity = parseInt(form.querySelector('#delegate-quantity').value, 10);
            const masterProduct = this.getProduct(productId);
            if (!employeeId || !productId || isNaN(quantity) || quantity <= 0 || !masterProduct) return;
            if (masterProduct.stock < quantity) {
                this.showNotification('Not enough stock in master inventory.', 'error');
                return;
            }
            masterProduct.stock -= quantity;
            const employee = this.getEmployee(employeeId);
            let employeeProduct = employee.inventory.find(item => item.productId === productId);
            if (employeeProduct) {
                employeeProduct.stock += quantity;
            } else {
                employee.inventory.push({ productId, stock: quantity });
            }
            this.saveState();
            this.render();
            form.reset();
            this.closeModal('delegateStockModal');
            this.showNotification(`${quantity} x ${masterProduct.name} delegated to ${employee.name}.`, 'success');
        },
        handleCreateTask(e) {
            e.preventDefault();
            const form = e.target;
            const description = form.querySelector('#new-task-description').value;
            const assigneeId = form.querySelector('#new-task-assignee').value;
            if (!description || !assigneeId) return;
            this.state.tasks.push({ id: `task_${Date.now()}`, description, assigneeId, status: 'In Progress' });
            this.saveState();
            this.render();
            form.reset();
            this.closeModal('createTaskModal');
            const assignee = this.getEmployee(assigneeId);
            this.showNotification(`Task assigned to ${assignee.name}.`, 'success');
        },
        toggleTaskStatus(taskId) {
            const task = this.state.tasks.find(t => t.id === taskId);
            if (task) {
                task.status = task.status === 'Completed' ? 'In Progress' : 'Completed';
                this.saveState();
                this.render();
                this.setActiveTab('my-tasks');
                this.showNotification(`Task status updated to ${task.status}.`, 'success');
            }
        },
        handleRecordSale(e) {
            e.preventDefault();
            const form = e.target;
            const storeId = form.querySelector('#sale-store').value;
            const productId = form.querySelector('#sale-product').value;
            const saleType = form.querySelector('#sale-type').value;
            const quantity = parseInt(form.querySelector('#sale-quantity').value, 10);
            const discount = parseFloat(form.querySelector('#sale-discount').value) || 0;
            const amount = parseFloat(form.querySelector('#sale-amount').value);

            const employee = this.getEmployee(this.state.currentEmployeeId);
            const employeeInventoryItem = employee.inventory.find(i => i.productId === productId);
            const store = this.getStore(storeId);

            if (!storeId || !productId || isNaN(amount) || isNaN(quantity) || quantity <= 0) {
                this.showNotification('Invalid sale data. Please check all fields.', 'error');
                return;
            }
            if (!employeeInventoryItem || employeeInventoryItem.stock < quantity) {
                this.showNotification('Not enough stock to complete sale.', 'error');
                return;
            }

            if (saleType === 'Credit') {
                if (!store || (store.credit || 0) < amount) {
                    this.showNotification(`Insufficient credit for ${store.name}.`, 'error');
                    return;
                }
                store.credit -= amount;
            }

            employeeInventoryItem.stock -= quantity;
            employee.transactions.push({ 
                id: `txn_${Date.now()}`, type: 'sale', saleType, storeId, productId, amount, quantity, discount,
                date: new Date().toISOString(), invoiced: false 
            });
            this.saveState();
            this.render();
            this.setActiveTab('sales-expenses');
            form.reset();
            this.handleSaleTypeChange();
            this.showNotification('Sale recorded successfully!', 'success');
        },
        handleRecordExpense(e) {
            e.preventDefault();
            const form = e.target;
            const description = form.querySelector('#expense-description').value;
            const amount = parseFloat(form.querySelector('#expense-amount').value);
            if (!description || isNaN(amount)) {
                this.showNotification('Invalid expense data.', 'error');
                return;
            }
            const employee = this.getEmployee(this.state.currentEmployeeId);
            employee.transactions.push({ id: `txn_${Date.now()}`, type: 'expense', description, amount, date: new Date().toISOString() });
            this.saveState();
            this.render();
            this.setActiveTab('sales-expenses');
            form.reset();
            this.showNotification('Expense recorded successfully!', 'success');
        },
        async handleGenerateInvoice(e) {
            e.preventDefault();
            const form = e.target;
            const selectedSalesIds = Array.from(form.querySelectorAll('input[name="invoice-sale"]:checked')).map(cb => cb.value);
            if (selectedSalesIds.length === 0) {
                this.showNotification('Please select at least one sale for the receipt.', 'error');
                return;
            }
            const btn = document.getElementById('generate-pdf-btn'), loader = document.getElementById('generate-pdf-loader');
            btn.disabled = true;
            document.getElementById('generate-pdf-text').textContent = 'Generating...';
            loader.classList.remove('hidden');
            const employee = this.getEmployee(this.state.currentEmployeeId);
            const salesToInvoice = employee.transactions.filter(t => selectedSalesIds.includes(t.id));
            const totalAmount = salesToInvoice.reduce((sum, sale) => sum + sale.amount, 0);
            const invoiceHtml = this.generateInvoiceHtml(employee, salesToInvoice, totalAmount);
            try {
                const response = await fetch('https://api.pdfshift.io/v3/convert/pdf', {
                    method: 'POST',
                    headers: { 'Authorization': 'Basic ' + btoa('api:' + this.pdfShiftApiKey), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source: invoiceHtml, landscape: false })
                });
                if (!response.ok) throw new Error(`PDF Generation Failed: ${(await response.json()).message}`);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none'; a.href = url; a.download = `Receipt_${Date.now()}.pdf`;
                document.body.appendChild(a); a.click();
                window.URL.revokeObjectURL(url); a.remove();
                salesToInvoice.forEach(sale => sale.invoiced = true);
                this.saveState(); this.render(); this.setActiveTab('invoices');
                this.showNotification('PDF Receipt downloaded successfully!', 'success');
            } catch (error) {
                console.error('Error generating PDF:', error);
                this.showNotification(error.message, 'error');
            } finally {
                btn.disabled = false;
                document.getElementById('generate-pdf-text').textContent = 'Generate & Download PDF Receipt';
                loader.classList.add('hidden');
                form.reset();
            }
        },
        generateInvoiceHtml(employee, sales, total) {
            let totalDiscount = 0;
            const itemsHtml = sales.map(sale => {
                const product = this.getProduct(sale.productId);
                const store = this.getStore(sale.storeId);
                const unitPrice = sale.quantity > 0 ? sale.amount / sale.quantity : 0;
                if (sale.discount > 0) totalDiscount += sale.discount;
                return `<tr><td style="padding: 8px; border-bottom: 1px solid #eee;">${product.name} (Sold at ${store?.name || 'Deleted Store'})</td><td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">${sale.quantity || 1}</td><td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">$${unitPrice.toFixed(2)}</td><td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">$${sale.amount.toFixed(2)}</td></tr>`;
            }).join('');
            
            const subtotal = sales.reduce((sum, sale) => sum + (this.getProduct(sale.productId).price * (sale.quantity || 1)), 0);
            const discountHtml = totalDiscount > 0 ? `<div class="total" style="font-weight:normal; font-size: 1em;">Discount: -$${totalDiscount.toFixed(2)}</div>` : '';

            return `<!DOCTYPE html><html><head><style>body{font-family:sans-serif;color:#333}.container{max-width:800px;margin:auto;padding:20px;border:1px solid #eee;box-shadow:0 0 10px rgba(0,0,0,.15)}.header,.details{margin-bottom:40px}.table{width:100%;border-collapse:collapse}.table th{background:#f9f9f9;text-align:left;padding:8px;border-bottom:2px solid #ddd}.total{text-align:right;margin-top:20px;font-size:1.2em;font-weight:bold}</style></head><body><div class="container"><div class="header"><h1>Sales Receipt</h1><p>Receipt ID: RCPT_${Date.now()}</p></div><div class="details"><strong>Generated By:</strong><br>${employee.name} (${employee.position})<br>Date: ${new Date().toLocaleDateString()}</div><table class="table"><thead><tr><th>Item</th><th>Quantity</th><th>Unit Price</th><th>Total</th></tr></thead><tbody>${itemsHtml}</tbody></table><div class="total" style="font-weight:normal; font-size: 1em; margin-top: 20px;">Subtotal: $${subtotal.toFixed(2)}</div>${discountHtml}<div class="total" style="margin-top: 5px;">Total: $${total.toFixed(2)}</div></div></body></html>`;
        },
        async generateAIPlan() {
            const employeeId = document.getElementById('ai-employee-select').value;
            const employee = this.getEmployee(employeeId);
            if (!employee) return;
            const btn = document.getElementById('generate-plan-btn'), loader = document.getElementById('generate-plan-loader');
            btn.disabled = true;
            document.getElementById('generate-plan-text').textContent = 'Analyzing...';
            loader.classList.remove('hidden');
            document.getElementById('ai-plan-output').innerHTML = `<p class="text-sepia-text-secondary dark:text-gray-400">Accura AI is analyzing the data...</p>`;
            const revenue = employee.transactions.filter(t => t.type === 'sale').reduce((s, t) => s + t.amount, 0);
            const expenses = employee.transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const profit = revenue - expenses;
            const recentTransactions = employee.transactions.slice(-5).map(t => {
                const desc = t.type === 'sale' ? `Sale of ${this.getProduct(t.productId)?.name}` : t.description;
                return `${t.type.toUpperCase()}: $${t.amount.toFixed(2)} - ${desc}`;
            });
            const plan = await this.mockGeminiAPI(employee.name, revenue, expenses, profit, recentTransactions);
            this.showNotification(`AI profit plan for ${employee.name} generated.`, 'success');
            document.getElementById('ai-plan-output').innerHTML = this.simpleMarkdownToHtml(plan);
            btn.disabled = false;
            document.getElementById('generate-plan-text').textContent = 'Generate Plan';
            loader.classList.add('hidden');
        },
        async mockGeminiAPI(name, revenue, expenses, profit, transactions) {
            return new Promise(resolve => setTimeout(() => {
                const advice = [];
                if (profit < 0) advice.push(`- **Address Negative Profit:** The current net profit is -$${Math.abs(profit).toFixed(2)}. Prioritize cost reduction or boosting high-margin sales immediately.`);
                else advice.push(`- **Leverage Positive Profit:** With a net profit of $${profit.toFixed(2)}, consider reinvesting in top-selling products or marketing efforts to scale up.`);

</body>
</html>
