<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ledgerly - Business Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,400;0,500;0,600;0,700;1,700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'logo': ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        'light-bg': '#f0f4f9', 'light-surface': '#ffffff', 'light-text': '#1f2937', 'light-text-secondary': '#6b7280',
                        'dark-bg': '#131314', 'dark-surface': '#1e1f20', 'dark-text': '#e3e3e3', 'dark-text-secondary': '#8f9397',
                        'primary': '#89b4fa', 'primary-hover': '#7287fd',
                        'accent-green': '#a6e3a1', 'accent-red': '#f38ba8',
                        'accent-yellow': '#f9e2af', 'accent-amber': '#fab387',
                        'accent-purple': '#cba6f7',
                    },
                    keyframes: {
                        'fade-in-out': { '0%': { opacity: '0', transform: 'translateY(-20px)' }, '10%': { opacity: '1', transform: 'translateY(0)' }, '90%': { opacity: '1', transform: 'translateY(0)' }, '100%': { opacity: '0', transform: 'translateY(-20px)' }, },
                        'color-pulse': { '0%, 100%': { color: '#89b4fa' }, '25%': { color: '#a6e3a1' }, '50%': { color: '#f5c2e7' }, '75%': { color: '#94e2d5' }, }
                    },
                    animation: { 'fade-in-out': 'fade-in-out 4s ease-in-out forwards', 'color-pulse': 'color-pulse 10s ease-in-out infinite', }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f0f4f9; color: #1f2937; font-family: 'Inter', sans-serif; }
        .dark body { background-color: #131314; color: #e3e3e3; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); }
        .tab-button.active { border-color: #89b4fa; color: #89b4fa; }
        .task-completed { text-decoration: line-through; color: #a3a3a3; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f0f4f9; }
        .dark ::-webkit-scrollbar-track { background: #1e1f20; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        @import url('https://rsms.me/inter/inter.css');
        .invoice-sub-tab-btn { border-color: transparent; }
        .invoice-sub-tab-btn.active { border-color: #89b4fa; color: #89b4fa; }
        .ai-tab-btn.active { background-color: #89b4fa; color: black; }
    </style>
</head>
<body class="antialiased font-sans">

    <div id="notification" class="fixed top-5 right-5 z-[100] text-black py-2 px-4 rounded-md shadow-lg opacity-0 transition-opacity">
        <span id="notification-message"></span>
    </div>

    <div id="app" class="h-screen flex flex-col">
        <header id="main-header" class="bg-light-surface dark:bg-dark-surface p-4 flex justify-between items-center relative z-35 flex-shrink-0 border-b border-gray-200 dark:border-gray-700 hidden">
            <div class="flex items-center space-x-4">
                <button id="sidenav-toggle" class="text-light-text-secondary dark:text-dark-text-secondary text-xl px-2 py-1" onclick="app.toggleSidenav()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="flex items-center space-x-3">
                    <i class="fas fa-chart-pie text-primary text-3xl"></i>
                    <div class="flex flex-col font-logo">
                        <h1 id="app-title" class="text-3xl font-bold text-light-text dark:text-dark-text animate-color-pulse uppercase tracking-wider">LEDGERLY</h1>
                        <span class="text-xs font-bold tracking-[0.3em] animate-color-pulse opacity-80 -mt-1 text-center">SALES</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center">
                <button id="settings-button" onclick="app.openModal('settingsModal')" class="text-light-text-secondary dark:text-dark-text-secondary text-xl px-4 py-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>

        <main id="main-content" class="flex-1 flex md:flex-row overflow-hidden min-h-0 hidden">
            <div id="sidenav-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden" onclick="app.toggleSidenav()"></div>

            <div id="side-panel" class="fixed inset-y-0 left-0 z-40 w-4/5 max-w-sm bg-light-surface dark:bg-dark-surface p-4 overflow-y-auto transform -translate-x-full transition-transform duration-300 ease-in-out md:relative md:w-1/3 lg:w-1/4 md:translate-x-0 md:flex-shrink-0 md:border-r border-gray-200 dark:border-gray-700">
                <button onclick="app.toggleSidenav()" class="absolute top-2 right-2 text-xl p-2 text-light-text-secondary dark:text-dark-text-secondary md:hidden">&times;</button>
                
                <div class="mt-10 md:mt-0">
                    <div id="company-overview-panel" class="mb-6">
                        <h2 class="text-xl font-semibold mb-3 text-light-text dark:text-dark-text flex items-center justify-between cursor-pointer hover:text-primary dark:hover:text-primary transition-colors" onclick="app.showCompanyView()">
                            <span><i class="fas fa-building mr-2 text-primary"></i>Company Overview</span>
                            <i class="fas fa-arrow-right"></i>
                        </h2>
                    </div>
                    
                    <div id="quick-actions-panel" class="mb-6">
                        <h2 class="text-xl font-semibold mb-3 text-light-text dark:text-dark-text flex items-center justify-between cursor-pointer" onclick="app.togglePanel('quick-actions')">
                            <span><i class="fas fa-bolt mr-2 text-primary"></i>Quick Actions</span>
                            <i id="quick-actions-toggle-icon" class="fas fa-chevron-down"></i>
                        </h2>
                        <div id="quick-actions-content" class="space-y-3 hidden">
                            <button class="w-full text-left bg-light-bg dark:bg-dark-bg p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700" onclick="app.openModal('addEmployeeModal')"><i class="fas fa-user-plus w-6 mr-2"></i>Add Employee</button>
                            <button class="w-full text-left bg-light-bg dark:bg-dark-bg p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700" onclick="app.openModal('addProductModal')"><i class="fas fa-plus-circle w-6 mr-2"></i>Add Product / Stock</button>
                            <button class="w-full text-left bg-light-bg dark:bg-dark-bg p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700" onclick="app.openModal('delegateStockModal')"><i class="fas fa-people-arrows w-6 mr-2"></i>Delegate Stock</button>
                            <button class="w-full text-left bg-light-bg dark:bg-dark-bg p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700" onclick="app.openModal('createTaskModal')"><i class="fas fa-tasks w-6 mr-2"></i>Create Task</button>
                            <button class="w-full text-left bg-light-bg dark:bg-dark-bg p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700" onclick="app.openModal('addCategoryModal')"><i class="fas fa-tag w-6 mr-2"></i>Add Expense Category</button>
                        </div>
                    </div>

                    <div id="product-requests-panel" class="mb-6">
                        <h2 class="text-xl font-semibold mb-3 text-light-text dark:text-dark-text flex items-center justify-between cursor-pointer" onclick="app.togglePanel('product-requests')">
                            <span><i class="fas fa-dolly mr-2 text-primary"></i>Product Requests</span>
                            <i id="product-requests-toggle-icon" class="fas fa-chevron-down"></i>
                        </h2>
                        <div id="product-requests-content" class="space-y-3 hidden">
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="content-area" class="flex-1 overflow-y-auto bg-light-bg dark:bg-dark-bg">
                <div id="employee-view" class="h-full hidden"></div>
                <div id="company-view" class="h-full hidden"></div>
            </div>
        </main>
    </div>

    <div id="modal-container"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const app = {
        state: {
            theme: 'dark', currentEmployeeId: null, employees: [],
            masterInventory: [], tasks: [], expenseCategories: [],
            productRequests: [], 
            ledgerFilter: 'all', activeInvoiceSubTab: 'create',
            currentView: 'employee',
            companyActiveTab: 'dashboard',
            storeSearchTerm: '',
            ledgerSearchTerm: '',
        },
        currentSaleCart: [],
        charts: {},
        notificationTimeout: null,

        init() {
            this.loadState(); this.applyTheme(); this.renderModals();
            this.addEventListeners(); this.render();
            if(this.state.employees.length > 0) {
                this.togglePanel('quick-actions', true);
                this.togglePanel('product-requests', true);
            }
        },

        showFirstTimeSetup() { document.getElementById('firstTimeModal')?.classList.remove('hidden'); },
        showMainApp() {
            document.getElementById('firstTimeModal')?.classList.add('hidden');
            document.getElementById('main-header').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        },

        saveState() { localStorage.setItem('ledgerlyState', JSON.stringify(this.state)); },
        loadState() {
            const savedState = localStorage.getItem('ledgerlyState');
            if (savedState) this.state = { ...this.state, ...JSON.parse(savedState) };

            this.state.employees.forEach(emp => {
                if (emp.isActive === undefined) emp.isActive = true;
                if (!emp.transactions) emp.transactions = [];
                emp.transactions.forEach(t => {
                    if (t.type === 'sale' && !t.items && t.productId) {
                        t.items = [{
                            productId: t.productId,
                            quantity: t.quantity,
                            price: t.amount / t.quantity,
                            name: this.getProduct(t.productId)?.name || 'Unknown'
                        }];
                    }
                });
                if (!emp.inventory) emp.inventory = [];
                if (!emp.stores) emp.stores = [];
                if (!emp.invoices) emp.invoices = [];
            });
            this.state.masterInventory.forEach(prod => { if (prod.isActive === undefined) prod.isActive = true; });
            if (!this.state.expenseCategories || this.state.expenseCategories.length === 0) {
                this.state.expenseCategories = [ { id: `cat_${Date.now()}_1`, name: 'Supplies' }, { id: `cat_${Date.now()}_2`, name: 'Travel' }, { id: `cat_${Date.now()}_3`, name: 'Utilities' }, { id: `cat_${Date.now()}_4`, name: 'Uncategorized' } ];
            }
             if (!this.state.tasks) this.state.tasks = [];
             if (!this.state.productRequests) this.state.productRequests = [];
             if (!this.state.ledgerFilter) this.state.ledgerFilter = 'all';
             if (!this.state.activeInvoiceSubTab) this.state.activeInvoiceSubTab = 'create';
             if (!this.state.currentView) this.state.currentView = 'employee';
             if (!this.state.companyActiveTab) this.state.companyActiveTab = 'dashboard';
        },
        getEmployee(id) { return this.state.employees.find(e => e.id === id); },
        getCurrentEmployee() { return this.getEmployee(this.state.currentEmployeeId); },
        getActiveEmployees() { return this.state.employees.filter(e => e.isActive); },
        getProduct(id) { return this.state.masterInventory.find(p => p.id === id); },
        getActiveProducts() { return this.state.masterInventory.filter(p => p.isActive); },
        getCategory(id) { return this.state.expenseCategories.find(c => c.id === id); },
        getTask(id) { return this.state.tasks.find(t => t.id === id); },

        addEventListeners() {
            document.getElementById('theme-toggle-modal')?.addEventListener('click', () => this.toggleTheme());
            document.getElementById('first-employee-form')?.addEventListener('submit', e => this.handleFirstEmployee(e));
            document.getElementById('employee-switcher-modal')?.addEventListener('change', e => this.handleEmployeeSwitch(e));
            
            document.getElementById('add-employee-form')?.addEventListener('submit', e => this.handleAddEmployee(e));
            document.getElementById('edit-employee-form')?.addEventListener('submit', e => this.handleUpdateEmployee(e));
            
            const addProductForm = document.getElementById('add-product-form');
            if (addProductForm) {
                addProductForm.addEventListener('submit', e => this.handleAddProduct(e));
                document.getElementById('new-product-name')?.addEventListener('input', e => this.handleProductNameInput(e));
            }
            
            document.getElementById('edit-product-form')?.addEventListener('submit', e => this.handleUpdateProduct(e));
            document.getElementById('add-category-form')?.addEventListener('submit', e => this.handleAddCategory(e));
            document.getElementById('edit-category-form')?.addEventListener('submit', e => this.handleUpdateCategory(e));
            document.getElementById('delegate-stock-form')?.addEventListener('submit', e => this.handleDelegateStock(e));
            document.getElementById('create-task-form')?.addEventListener('submit', e => this.handleCreateTask(e));
            document.getElementById('decline-stock-form')?.addEventListener('submit', e => this.handleDeclineStock(e));
        },

        attachEmployeeViewEventListeners() {
            document.getElementById('employee-tabs-container')?.addEventListener('click', e => this.handleTabClick(e, 'employee'));
            document.getElementById('mobile-tabs')?.addEventListener('change', e => this.handleMobileTabChange(e));

            const saleForm = document.getElementById('record-sale-form');
            if(saleForm) {
                saleForm.addEventListener('submit', e => this.handleRecordSale(e));
                document.getElementById('add-item-to-sale-btn')?.addEventListener('click', () => this.addToSaleCart());
                document.getElementById('sale-cart-items')?.addEventListener('click', e => {
                    if (e.target.closest('.remove-sale-item-btn')) {
                        const productId = e.target.closest('.remove-sale-item-btn').dataset.productId;
                        this.removeFromSaleCart(productId);
                    }
                });
                document.getElementById('sale-discount')?.addEventListener('input', () => this.updateSaleCartTotal());
            }

            document.getElementById('record-expense-form')?.addEventListener('submit', e => this.handleRecordExpense(e));
            document.getElementById('employee-add-store-form')?.addEventListener('submit', e => this.handleAddStore(e));
            document.getElementById('edit-store-form')?.addEventListener('submit', e => this.handleUpdateStore(e));
            document.getElementById('request-stock-form')?.addEventListener('submit', e => this.handleRequestStock(e));

            const invoiceForm = document.getElementById('invoice-form');
            if (invoiceForm) {
                invoiceForm.addEventListener('submit', e => this.handleGenerateInvoice(e));
                invoiceForm.addEventListener('change', e => {
                    if (e.target.id === 'invoice-store') {
                        this.renderInvoiceTransactionList(e.target.value);
                    } else if (e.target.classList.contains('invoice-txn-checkbox')) {
                        const generateBtn = invoiceForm.querySelector('button[type="submit"]');
                        const anyChecked = invoiceForm.querySelector('.invoice-txn-checkbox:checked');
                        generateBtn.disabled = !anyChecked;
                    }
                });
            }

            document.getElementById('credit-received-form')?.addEventListener('submit', e => this.handleCreditReceived(e));
            document.getElementById('ledger-filter-container')?.addEventListener('click', e => {
                const button = e.target.closest('.ledger-filter-btn');
                if (button && button.dataset.filter) {
                    this.state.ledgerFilter = button.dataset.filter;
                    this.renderLedger();
                }
            });
            
            document.getElementById('invoice-sub-nav')?.addEventListener('click', e => {
                const button = e.target.closest('.invoice-sub-tab-btn');
                if (button && button.dataset.subTab) {
                    this.state.activeInvoiceSubTab = button.dataset.subTab;
                    this.renderInvoices();
                }
            });

            document.getElementById('pending-invoice-panel')?.addEventListener('click', e => {
                const item = e.target.closest('.pending-invoice-item');
                if (item && item.dataset.storeId) {
                    this.setActiveInvoiceSubTab('create');
                    document.getElementById('invoice-store').value = item.dataset.storeId;
                    this.renderInvoiceTransactionList(item.dataset.storeId);
                }
            });
        },
        
        attachCompanyViewEventListeners() {
            document.getElementById('company-tabs-container')?.addEventListener('click', e => this.handleTabClick(e, 'company'));
        },

        handleMobileTabChange(e) {
            const tabName = e.target.value;
            if (tabName === 'ledger') this.state.ledgerFilter = 'all';
            this.setActiveTab(tabName, 'employee');
        },

        handleTabClick(e, viewType) {
            const tabButton = e.target.closest('.tab-button');
            if (!tabButton || !tabButton.dataset.tab) return;
            
            if (viewType === 'employee') {
                 if(tabButton.dataset.tab === 'ledger') this.state.ledgerFilter = 'all';
                 if(tabButton.dataset.tab === 'invoices') this.state.activeInvoiceSubTab = 'create';
                this.setActiveTab(tabButton.dataset.tab, 'employee');
            } else if (viewType === 'company') {
                this.state.companyActiveTab = tabButton.dataset.tab;
                this.setActiveTab(tabButton.dataset.tab, 'company');
            }
        },

        render() {
            try {
                if (this.state.employees.length === 0) { this.showFirstTimeSetup(); return; }
                this.showMainApp();
                
                if (!this.state.currentEmployeeId || !this.getCurrentEmployee()?.isActive) {
                    const firstActive = this.getActiveEmployees()[0];
                    this.state.currentEmployeeId = firstActive ? firstActive.id : null;
                }
                
                this.renderEmployeeSwitcher();
                this.renderProductRequestsPanel();
                
                const employeeView = document.getElementById('employee-view');
                const companyView = document.getElementById('company-view');

                if (this.state.currentView === 'company') {
                    employeeView.classList.add('hidden');
                    employeeView.innerHTML = '';
                    companyView.classList.remove('hidden');
                    this.renderCompanyDashboardView();
                } else {
                    companyView.classList.add('hidden');
                    companyView.innerHTML = '';
                    employeeView.classList.remove('hidden');
                    this.renderEmployeeSpecificView();
                }
            } catch (error) {
                console.error("Render Error:", error);
                document.body.innerHTML = `<div style="padding: 2rem; font-family: sans-serif;"><h1>An Error Occurred</h1><p>The application could not start. Please check the console or try clearing local storage.</p><pre style="background: #eee; padding: 1rem; border-radius: 5px; white-space: pre-wrap;">${error.stack}</pre></div>`;
            }
        },

        renderEmployeeSpecificView() {
            const employeeView = document.getElementById('employee-view');
            if (this.getActiveEmployees().length === 0) {
                employeeView.innerHTML = `<div class="p-4 sm:p-8 text-center"><h2 class="text-2xl font-bold mb-4">All Employees Inactive</h2><p>Please reactivate an employee or view the Company Overview.</p></div>`;
            } else if (this.state.currentEmployeeId) {
                employeeView.innerHTML = this.getEmployeeViewTemplate();
                this.renderTabs('employee');
                this.attachEmployeeViewEventListeners();
                this.setActiveTab(document.querySelector('#employee-tabs-container .tab-button.active')?.dataset.tab || 'dashboard', 'employee');
            } else {
                employeeView.innerHTML = `<div class="p-4 sm:p-8 text-center"><h2 class="text-2xl font-bold mb-4">No active employee selected.</h2><p>Please select an employee from the dropdown or view the Company Overview.</p></div>`;
            }
        },

        renderCompanyDashboardView() {
            const companyView = document.getElementById('company-view');
            companyView.innerHTML = this.getCompanyViewTemplate();
            this.renderTabs('company');
            this.attachCompanyViewEventListeners();
            this.setActiveTab(this.state.companyActiveTab, 'company');
        },

        showCompanyView() {
            this.state.currentView = 'company';
            this.state.companyActiveTab = 'company-dashboard';
            this.saveState();
            this.render();
            this.toggleSidenav();
        },

        showEmployeeView() {
            this.state.currentView = 'employee';
            this.saveState();
            this.render();
        },

        getCompanyViewTemplate() {
            let totalRevenue=0, totalExpenses=0;
            this.state.employees.forEach(emp => {
                if(emp.transactions){
                    totalRevenue += emp.transactions.filter(t => t.type === 'sale').reduce((sum, t) => sum + t.amount, 0);
                    totalExpenses += emp.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                }
            });
            const totalProfit = totalRevenue - totalExpenses;

            return `
            <div class="w-full max-w-6xl mx-auto px-4 py-6">
                <div class="bg-light-surface dark:bg-dark-surface rounded-lg shadow-lg">
                    <div class="flex-shrink-0 p-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
                        <div>
                            <button onclick="app.showEmployeeView()" class="text-light-text-secondary dark:text-dark-text-secondary hover:text-primary dark:hover:text-primary mr-4"><i class="fas fa-arrow-left mr-2"></i>Back</button>
                            <h2 class="text-2xl font-bold inline-block">Company-Wide Overview</h2>
                        </div>
                        <button onclick="app.openModal('aiAdvisorModal')" class="bg-primary/20 text-primary font-semibold py-2 px-4 rounded-lg hover:bg-primary hover:text-black transition-colors">
                            <i class="fas fa-brain mr-2"></i>
                            <span class="hidden sm:inline">Accura AI</span>
                        </button>
                    </div>
                    <div class="flex-shrink-0 border-b border-gray-200 dark:border-gray-700">
                        <nav id="company-tabs-container" class="-mb-px flex flex-wrap items-center gap-x-4 gap-y-2 px-4"></nav>
                    </div>
                    <div class="p-4 sm:p-6">
                        <div id="company-dashboard-content" class="tab-content hidden">
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                                <div class="bg-light-bg dark:bg-dark-bg p-4 rounded-lg"><div class="text-sm text-light-text-secondary dark:text-dark-text-secondary">Total Revenue</div><div class="text-2xl font-bold text-accent-green">AED ${totalRevenue.toFixed(2)}</div></div>
                                <div class="bg-light-bg dark:bg-dark-bg p-4 rounded-lg"><div class="text-sm text-light-text-secondary dark:text-dark-text-secondary">Total Expenses</div><div class="text-2xl font-bold text-accent-red">AED ${totalExpenses.toFixed(2)}</div></div>
                                <div class="bg-light-bg dark:bg-dark-bg p-4 rounded-lg"><div class="text-sm text-light-text-secondary dark:text-dark-text-secondary">Net Profit</div><div class="text-2xl font-bold ${totalProfit >= 0 ? 'text-accent-green':'text-accent-red'}">AED ${totalProfit.toFixed(2)}</div></div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                 <div class="bg-light-bg dark:bg-dark-bg p-4 rounded-lg h-72 lg:h-80 w-full"><canvas id="company-revenue-expense-chart"></canvas></div>
                                 <div class="bg-light-bg dark:bg-dark-bg p-4 rounded-lg h-72 lg:h-80 w-full"><canvas id="company-top-products-chart"></canvas></div>
                            </div>
                        </div>
                        <div id="company-employees-content" class="tab-content hidden"></div>
                        <div id="company-inventory-content" class="tab-content hidden"></div>
                        <div id="company-expenses-content" class="tab-content hidden"></div>
                        <div id="company-tasks-content" class="tab-content hidden"></div>
                    </div>
                </div>
            </div>`;
        },

        getEmployeeViewTemplate() {
            const employee = this.getCurrentEmployee();
            if (!employee) return '';
            const revenue = employee.transactions.filter(t => t.type === 'sale').reduce((sum, t) => sum + t.amount, 0);
            const expenses = employee.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const profit = revenue - expenses;
            const salesAndExpensesContent = `
                <div id="sales-expenses-content" class="tab-content hidden grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="bg-light-bg dark:bg-dark-bg p-4 sm:p-6 rounded-lg">
                        <h3 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-cart-plus mr-3 text-accent-green"></i>Record a Sale</h3>
                        <form id="record-sale-form" class="space-y-4">
                            <div class="grid grid-cols-1 sm:grid-cols-5 gap-2 items-end p-2 border border-dashed border-gray-400 dark:border-gray-600 rounded-md">
                                <div class="sm:col-span-2">
                                    <label for="add-sale-product" class="form-label">Product</label>
                                    <select id="add-sale-product" class="form-input"></select>
                                </div>
                                <div class="sm:col-span-1">
                                    <label for="add-sale-quantity" class="form-label">Qty</label>
                                    <input type="number" id="add-sale-quantity" value="1" min="1" class="form-input">
                                </div>
                                <div class="sm:col-span-2">
                                    <button type="button" id="add-item-to-sale-btn" class="w-full bg-primary/80 text-black font-bold py-2 px-4 rounded-md hover:bg-primary">Add to Sale</button>
                                </div>
                            </div>

                            <div id="sale-cart-items" class="space-y-2 max-h-48 overflow-y-auto p-2 border-y border-gray-200 dark:border-gray-700">
                                <p class="text-center text-sm text-light-text-secondary dark:text-dark-text-secondary">Items will appear here...</p>
                            </div>
                            
                            <div class="space-y-3">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="sale-type" class="form-label">Sale Type</label>
                                        <select id="sale-type" name="sale-type" class="form-input"></select>
                                    </div>
                                    <div>
                                        <label for="sale-store" class="form-label">Store</label>
                                        <select id="sale-store" name="sale-store" class="form-input"></select>
                                    </div>
                                </div>
                                <div>
                                    <label for="sale-discount" class="form-label">Overall Discount (AED)</label>
                                    <input type="number" id="sale-discount" name="sale-discount" min="0" value="0" step="0.01" class="form-input">
                                </div>
                                <div class="p-3 bg-light-surface dark:bg-dark-surface rounded-md text-right">
                                    <span class="text-light-text-secondary dark:text-dark-text-secondary">Final Total: </span>
                                    <strong id="final-sale-amount" class="text-xl">AED 0.00</strong>
                                </div>
                                <button type="submit" id="record-sale-btn" class="w-full bg-primary text-black font-bold py-2 px-4 rounded-md hover:bg-primary-hover disabled:opacity-50 disabled:cursor-not-allowed" disabled>Record Transaction</button>
                            </div>
                        </form>
                    </div>
                    <div class="bg-light-bg dark:bg-dark-bg p-4 sm:p-6 rounded-lg">
                        <h3 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-money-bill-wave mr-3 text-accent-red"></i>Record an Expense</h3>
                        <form id="record-expense-form" class="space-y-3">
                            <div><label for="expense-description" class="form-label">Description</label><input type="text" id="expense-description" name="expense-description" required class="form-input"></div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div><label for="expense-amount" class="form-label">Amount (AED)</label><input type="number" id="expense-amount" name="expense-amount" step="0.01" min="0" required class="form-input"></div>
                                <div><label for="expense-category" class="form-label">Category</label><select id="expense-category" name="expense-category" required class="form-input"></select></div>
                            </div>
                            <button type="submit" class="w-full bg-primary text-black font-bold py-2 px-4 rounded-md hover:bg-primary-hover">Record Expense</button>
                        </form>
                    </div>
                </div>
            `;

            return `
            <div class="w-full max-w-6xl mx-auto px-4 py-6">
                <div class="bg-light-surface dark:bg-dark-surface rounded-lg shadow-lg flex flex-col">
                    <div class="flex-shrink-0 p-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center gap-4">
                            <h2 class="text-2xl font-bold">${employee.name}</h2>
                            <button onclick="app.openModal('aiAdvisorModal')" class="text-primary hover:text-primary-hover" title="AI Advisor for ${employee.name}">
                                <i class="fas fa-brain text-xl"></i>
                            </button>
                        </div>
                        <p class="text-light-text-secondary dark:text-dark-text-secondary hidden sm:block">${employee.position}</p>
                    </div>
                    <div class="flex-shrink-0 border-b border-gray-200 dark:border-gray-700">
                        <div class="md:hidden my-2 px-4">
                            <label for="mobile-tabs" class="sr-only">Select a tab</label>
                            <select id="mobile-tabs" class="form-input w-full"></select>
                        </div>
                        <nav id="employee-tabs-container" class="-mb-px hidden md:flex space-x-6 px-4"></nav>
                    </div>
                    <div class="flex-grow p-4 sm:p-6">
                        <div id="dashboard-content" class="tab-content hidden">
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                                <div class="bg-light-bg dark:bg-dark-bg p-4 rounded-lg"><div class="text-sm text-light-text-secondary dark:text-dark-text-secondary">Revenue</div><div class="text-2xl font-bold text-accent-green">AED ${revenue.toFixed(2)}</div></div>
                                <div class="bg-light-bg dark:bg-dark-bg p-4 rounded-lg"><div class="text-sm text-light-text-secondary dark:text-dark-text-secondary">Expenses</div><div class="text-2xl font-bold text-accent-red">AED ${expenses.toFixed(2)}</div></div>
                                <div class="bg-light-bg dark:bg-dark-bg p-4 rounded-lg"><div class="text-sm text-light-text-secondary dark:text-dark-text-secondary">Net Profit</div><div class="text-2xl font-bold ${profit >= 0 ? 'text-accent-green':'text-accent-red'}">AED ${profit.toFixed(2)}</div></div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div class="bg-light-bg dark:bg-dark-bg p-4 rounded-lg h-60 sm:h-64"><canvas id="sales-over-time-chart"></canvas></div>
                                <div class="bg-light-bg dark:bg-dark-bg p-4 rounded-lg h-60 sm:h-64"><canvas id="top-products-chart"></canvas></div>
                                <div class="bg-light-bg dark:bg-dark-bg p-4 rounded-lg h-60 sm:h-64"><canvas id="expenses-by-category-chart"></canvas></div>
                                <div class="bg-light-bg dark:bg-dark-bg p-4 rounded-lg h-60 sm:h-64"><canvas id="store-credit-chart"></canvas></div>
                            </div>
                        </div>
                        <div id="my-tasks-content" class="tab-content hidden"><h3 class="text-xl font-bold mb-4">My Tasks</h3><ul id="employee-tasks-list" class="space-y-3"></ul></div>
                        <div id="my-inventory-content" class="tab-content hidden"></div>
                        ${salesAndExpensesContent}
                        <div id="stores-content" class="tab-content hidden">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div class="bg-light-bg dark:bg-dark-bg p-4 sm:p-6 rounded-lg">
                                    <h3 class="text-xl font-bold mb-4">Add Store</h3>
                                    <form id="employee-add-store-form" class="space-y-3">
                                        <div><label for="new-store-name" class="form-label">Store Name</label><input type="text" id="new-store-name" required class="form-input"></div>
                                        <div><label for="new-store-location" class="form-label">Location</label><input type="text" id="new-store-location" required class="form-input"></div>
                                        <div><label for="new-store-credit-limit" class="form-label">Credit Limit (AED)</label><input type="number" id="new-store-credit-limit" required min="0" step="0.01" class="form-input"></div>
                                        <button type="submit" class="w-full bg-primary text-black font-bold py-2 px-4 rounded-md hover:bg-primary-hover">Add Store</button>
                                    </form>
                                </div>
                                <div class="lg:col-span-1 space-y-4" id="stores-list-container">
                                    
                                    <div class="flex justify-between items-center">
                                        <h3 class="text-xl font-bold">My Stores</h3>
                                        <button onclick="app.toggleSearch('stores')" class="text-light-text-secondary dark:text-dark-text-secondary hover:text-primary p-2"><i class="fas fa-search"></i></button>
                                    </div>
                                    <div id="stores-search-container" class="hidden">
                                        <input type="text" id="stores-search-input" placeholder="Search by name or location..." class="form-input w-full">
                                    </div>
                                    
                                    <div id="stores-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                                </div>
                            </div>
                        </div>
                        <div id="request-stock-content" class="tab-content hidden"></div>
                        <div id="invoices-content" class="tab-content hidden">
                            <div class="mb-4 border-b border-gray-200 dark:border-gray-700">
                                <nav id="invoice-sub-nav" class="-mb-px flex space-x-6 overflow-x-auto">
                                    <button data-sub-tab="create" class="invoice-sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-light-text-secondary dark:text-dark-text-secondary">Create Invoice</button>
                                    <button data-sub-tab="pending" class="invoice-sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-light-text-secondary dark:text-dark-text-secondary">Pending</button>
                                    <button data-sub-tab="recent" class="invoice-sub-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-light-text-secondary dark:text-dark-text-secondary">Recent</button>
                                </nav>
                            </div>
                            <div id="create-invoice-panel" class="invoice-sub-tab-content bg-light-bg dark:bg-dark-bg p-4 sm:p-6 rounded-lg">
                                <h3 class="text-xl font-bold mb-4">Create Invoice</h3>
                                <form id="invoice-form" class="space-y-4">
                                    <div><label for="invoice-store" class="form-label">1. Select a Store</label><select id="invoice-store" class="form-input"></select></div>
                                    <div id="invoice-transactions-container" class="hidden">
                                        <label class="form-label">2. Select Uninvoiced Sales</label>
                                        <div id="invoice-transactions-list" class="mt-2 space-y-2 max-h-60 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-md p-3"></div>
                                    </div>
                                    <button type="submit" class="w-full bg-primary text-black font-bold py-2 px-4 rounded-md hover:bg-primary-hover flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed" disabled><i class="fas fa-file-invoice-dollar mr-2"></i>Create & Save Invoice</button>
                                </form>
                            </div>
                            <div id="pending-invoice-panel" class="invoice-sub-tab-content hidden bg-light-bg dark:bg-dark-bg p-4 sm:p-6 rounded-lg"></div>
                            <div id="recent-invoice-panel" class="invoice-sub-tab-content hidden bg-light-bg dark:bg-dark-bg p-4 sm:p-6 rounded-lg"></div>
                        </div>
                        <div id="ledger-content" class="tab-content hidden">

                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">Transaction Ledger</h3>
                                <button onclick="app.toggleSearch('ledger')" class="text-light-text-secondary dark:text-dark-text-secondary hover:text-primary p-2"><i class="fas fa-search"></i></button>
                            </div>
                            <div id="ledger-search-container" class="hidden mb-4">
                                <input type="text" id="ledger-search-input" placeholder="Search in transaction details..." class="form-input w-full">
                            </div>

                            <div id="ledger-filter-container" class="flex flex-wrap gap-2 mb-4">
                                <button data-filter="all" class="ledger-filter-btn px-3 py-1 text-sm font-semibold rounded-full border dark:border-gray-600">All</button>
                                <button data-filter="cash" class="ledger-filter-btn px-3 py-1 text-sm font-semibold rounded-full bg-accent-green/20 text-green-800 dark:text-accent-green">Cash</button>
                                <button data-filter="credit" class="ledger-filter-btn px-3 py-1 text-sm font-semibold rounded-full bg-accent-yellow/20 text-yellow-800 dark:text-accent-yellow">Credit</button>
                                <button data-filter="deal" class="ledger-filter-btn px-3 py-1 text-sm font-semibold rounded-full bg-accent-purple/20 text-purple-800 dark:text-accent-purple">Deal</button>
                                <button data-filter="payment" class="ledger-filter-btn px-3 py-1 text-sm font-semibold rounded-full bg-primary/20 text-blue-800 dark:text-primary">Payment</button>
                                <button data-filter="expense" class="ledger-filter-btn px-3 py-1 text-sm font-semibold rounded-full bg-accent-red/20 text-red-800 dark:text-accent-red">Expenses</button>
                            </div>
                            <div class="overflow-x-auto bg-light-bg dark:bg-dark-bg rounded-lg">
                                <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-700">
                                    <thead class="bg-gray-50 dark:bg-gray-800/50"><tr><th class="table-header">Date</th><th class="table-header">Type</th><th class="table-header">Details</th><th class="table-header text-right">Amount</th></tr></thead>
                                    <tbody id="ledger-body" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        },

        showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            if (!notification) return;
            const notificationMessage = document.getElementById('notification-message');
            if (this.notificationTimeout) { clearTimeout(this.notificationTimeout); }
            notificationMessage.textContent = message;
            notification.classList.remove('bg-accent-green', 'bg-accent-red', 'opacity-0', 'animate-fade-in-out');
            void notification.offsetWidth;
            if (type === 'success') { notification.classList.add('bg-accent-green'); } else { notification.classList.add('bg-accent-red'); }
            notification.classList.add('animate-fade-in-out');
            this.notificationTimeout = setTimeout(() => {
                notification.classList.remove('animate-fade-in-out');
                notification.classList.add('opacity-0');
                this.notificationTimeout = null;
            }, 4000);
        },

        renderStoresTab() {
            const employee = this.getCurrentEmployee();
            if (!employee) return;
            const storesList = document.getElementById('stores-list');
            const searchTerm = this.state.storeSearchTerm.toLowerCase();

            // Filter stores based on the search term
            const filteredStores = employee.stores.filter(store =>
                store.name.toLowerCase().includes(searchTerm) ||
                store.location.toLowerCase().includes(searchTerm)
            );

            // Generate the HTML for the filtered list
            storesList.innerHTML = filteredStores.map(store => {
                const calculatedCredit = (store.creditUsed || 0) - (store.creditPaidBack || 0);
                const outstandingCredit = Math.max(0, calculatedCredit);
                return `
                <div class="bg-light-surface dark:bg-dark-surface p-4 rounded-lg">
                    <div class="flex justify-between items-start">
                        <div><h4 class="font-bold text-lg">${store.name}</h4><p class="text-sm text-light-text-secondary dark:text-dark-text-secondary">${store.location}</p></div>
                        <div class="flex space-x-3">
                           <button onclick="app.startReceiveCredit('${store.id}')" class="text-sm text-accent-green hover:opacity-80" title="Receive Credit Payment"><i class="fas fa-hand-holding-usd"></i></button>
                           <button onclick="app.startEditStore('${store.id}')" class="text-sm hover:text-primary" title="Edit Store"><i class="fas fa-pencil-alt"></i></button>
                           <button onclick="app.deleteStore('${store.id}')" class="text-sm hover:text-accent-red" title="Delete Store"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <div class="mt-4 text-xs space-y-2">
                        <div class="flex justify-between"><span>Credit Limit:</span> <span class="font-mono">AED ${((store.creditAvailable || 0) + (store.creditUsed || 0)).toFixed(2)}</span></div>
                        <div class="flex justify-between"><span>Outstanding Credit:</span> <span class="font-mono ${outstandingCredit > 0 ? 'text-accent-red' : ''}">AED ${outstandingCredit.toFixed(2)}</span></div>
                        <div class="flex justify-between"><span>Paid Back:</span> <span class="font-mono text-accent-green">AED ${(store.creditPaidBack || 0).toFixed(2)}</span></div>
                    </div>
                </div>`;
            }).join('') || `<p class="text-center py-8 text-light-text-secondary dark:text-dark-text-secondary">No stores found.</p>`;

            // Connect the search input to the state
            const searchInput = document.getElementById('stores-search-input');
            if (searchInput) {
                searchInput.value = this.state.storeSearchTerm;
                searchInput.oninput = (e) => {
                    this.state.storeSearchTerm = e.target.value;
                    this.renderStoresTab(); // Re-render the list as user types
                };
            }
        },

        renderLedger() {
            const employee = this.getCurrentEmployee();
            if (!employee) return;
            const ledgerBody = document.getElementById('ledger-body');
            const sortedTransactions = [...employee.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            const typeFilter = this.state.ledgerFilter;
            const searchTerm = this.state.ledgerSearchTerm.toLowerCase();

            // 1. Filter by type buttons (existing logic)
            let filteredTransactions = sortedTransactions.filter(t => {
                if (typeFilter === 'all') return true;
                if (typeFilter === 'payment') return t.type === 'credit_received';
                if (typeFilter === 'expense') return t.type === 'expense';
                if (typeFilter === 'cash') return t.type === 'sale' && t.saleType === 'Cash';
                if (typeFilter === 'credit') return t.type === 'sale' && t.saleType === 'Credit';
                if (typeFilter === 'deal') return t.type === 'sale' && t.saleType === 'Deal';
                return false;
            });

            // 2. Filter by search term (new logic)
            if (searchTerm) {
                filteredTransactions = filteredTransactions.filter(t => {
                    let details = '';
                    if (t.type === 'sale') {
                        const store = employee.stores.find(s => s.id === t.storeId);
                        const itemDetails = (t.items || []).map(i => i.name).join(' ');
                        details = `Sold ${itemDetails} to ${store?.name || 'N/A'}`;
                    } else if (t.type === 'expense') {
                        const category = this.getCategory(t.categoryId);
                        details = `${t.description} (${category?.name||'Uncategorized'})`;
                    } else if (t.type === 'credit_received') {
                        const store = employee.stores.find(s => s.id === t.storeId);
                        details = `Credit Received from ${store?.name || 'N/A'}`;
                    }
                    return details.toLowerCase().includes(searchTerm);
                });
            }

            // Update active filter button
            document.querySelectorAll('.ledger-filter-btn').forEach(btn => {
                btn.classList.toggle('ring-2', btn.dataset.filter === typeFilter);
                btn.classList.toggle('ring-primary', btn.dataset.filter === typeFilter);
            });

            // Render the final filtered list
            ledgerBody.innerHTML = filteredTransactions.map(t => {
                const date = new Date(t.date).toLocaleDateString();
                const time = new Date(t.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                if (t.type === 'sale') {
                    const store = employee.stores.find(s => s.id === t.storeId);
                    const details = (t.items && t.items.length > 1) 
                        ? `Sold ${t.items.length} products to ${store?.name || 'N/A'}` 
                        : `Sold ${t.items?.[0]?.quantity || t.quantity} x ${t.items?.[0]?.name || 'N/A'} to ${store?.name || 'N/A'}`;
                    let invoicedIcon = '';
                    if (typeof t.invoiced === 'string' && t.invoiced.startsWith('inv_')) {
                        invoicedIcon = ` <button onclick="app.previewInvoice('${t.invoiced}')" class="text-primary hover:text-primary-hover ml-2" title="View Invoice"><i class="fas fa-file-invoice"></i></button>`;
                    } else if (t.invoiced === true) {
                        invoicedIcon = ` <i class="fas fa-file-invoice text-primary/50 ml-2" title="Invoiced (Legacy)"></i>`;
                    }
                    let typeBadge = '';
                    switch (t.saleType) {
                        case 'Credit': typeBadge = `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-accent-yellow/20 text-yellow-600 dark:text-accent-yellow">Credit</span>`; break;
                        case 'Deal': typeBadge = `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-accent-purple/20 text-purple-600 dark:text-accent-purple">Deal</span>`; break;
                        default: typeBadge = `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-accent-green/20 text-green-600 dark:text-accent-green">Cash Sale</span>`;
                    }
                    return `<tr class="hover:bg-light-surface dark:hover:bg-dark-surface/50 text-sm"><td class="px-4 py-3 whitespace-nowrap">${date} ${time}</td><td class="px-4 py-3">${typeBadge}</td><td class="px-4 py-3">${details}${invoicedIcon}</td><td class="px-4 py-3 text-right font-mono text-accent-green">+${t.amount.toFixed(2)}</td></tr>`;
                } else if (t.type === 'expense') {
                    const category = this.getCategory(t.categoryId);
                    return `<tr class="hover:bg-light-surface dark:hover:bg-dark-surface/50 text-sm"><td class="px-4 py-3 whitespace-nowrap">${date} ${time}</td><td class="px-4 py-3"><span class="px-2 py-1 text-xs font-semibold rounded-full bg-accent-red/20 text-red-600 dark:text-accent-red">Expense</span></td><td class="px-4 py-3">${t.description} <span class="text-light-text-secondary dark:text-dark-text-secondary">(${category?.name||'Uncategorized'})</span></td><td class="px-4 py-3 text-right font-mono text-accent-red">-${t.amount.toFixed(2)}</td></tr>`;
                } else if (t.type === 'credit_received') {
                    const store = employee.stores.find(s => s.id === t.storeId);
                    return `<tr class="hover:bg-light-surface dark:hover:bg-dark-surface/50 text-sm"><td class="px-4 py-3 whitespace-nowrap">${date} ${time}</td><td class="px-4 py-3"><span class="px-2 py-1 text-xs font-semibold rounded-full bg-primary/20 text-blue-600 dark:text-primary">Payment</span></td><td class="px-4 py-3">Credit Received from ${store?.name || 'N/A'}</td><td class="px-4 py-3 text-right font-mono text-accent-green">+${t.amount.toFixed(2)}</td></tr>`;
                }
                return '';
            }).join('') || `<tr><td colspan="4" class="text-center py-10 text-light-text-secondary dark:text-dark-text-secondary">No transactions found.</td></tr>`;
            
            // Connect the search input to the state
            const searchInput = document.getElementById('ledger-search-input');
            if (searchInput) {
                searchInput.value = this.state.ledgerSearchTerm;
                searchInput.oninput = (e) => {
                    this.state.ledgerSearchTerm = e.target.value;
                    this.renderLedger(); // Re-render the list as user types
                };
            }
        },

        addToSaleCart() {
            const productSelect = document.getElementById('add-sale-product');
            const quantityInput = document.getElementById('add-sale-quantity');
            const productId = productSelect.value;
            const quantity = parseInt(quantityInput.value);
            
            if (!productId || isNaN(quantity) || quantity <= 0) {
                this.showNotification('Please select a product and enter a valid quantity.', 'error');
                return;
            }

            const product = this.getProduct(productId);
            const employee = this.getCurrentEmployee();
            const inventoryItem = employee.inventory.find(i => i.productId === productId);
            const availableStock = inventoryItem ? inventoryItem.stock : 0;
            
            const existingCartItem = this.currentSaleCart.find(item => item.productId === productId);
            const currentQuantityInCart = existingCartItem ? existingCartItem.quantity : 0;

            if (quantity + currentQuantityInCart > availableStock) {
                this.showNotification(`Not enough stock. You only have ${availableStock} available.`, 'error');
                return;
            }

            if (existingCartItem) {
                existingCartItem.quantity += quantity;
            } else {
                this.currentSaleCart.push({ 
                    productId: product.id, 
                    name: product.name, 
                    quantity: quantity, 
                    price: product.price 
                });
            }
            
            this.renderSaleCart();
            productSelect.selectedIndex = 0;
            quantityInput.value = 1;
        },
        
        removeFromSaleCart(productId) {
            this.currentSaleCart = this.currentSaleCart.filter(item => item.productId !== productId);
            this.renderSaleCart();
        },

        renderSaleCart() {
            const cartContainer = document.getElementById('sale-cart-items');
            if (this.currentSaleCart.length === 0) {
                cartContainer.innerHTML = `<p class="text-center text-sm text-light-text-secondary dark:text-dark-text-secondary">Items will appear here...</p>`;
            } else {
                cartContainer.innerHTML = this.currentSaleCart.map(item => `
                    <div class="flex justify-between items-center p-2 bg-light-surface dark:bg-dark-surface rounded-md text-sm">
                        <div>
                            <span class="font-semibold">${item.name}</span>
                            <span class="text-light-text-secondary dark:text-dark-text-secondary ml-2">(Qty: ${item.quantity})</span>
                        </div>
                        <div class="flex items-center">
                            <span class="font-mono mr-4">AED ${(item.price * item.quantity).toFixed(2)}</span>
                            <button type="button" class="remove-sale-item-btn text-accent-red hover:opacity-75" data-product-id="${item.productId}">&times;</button>
                        </div>
                    </div>
                `).join('');
            }
            this.updateSaleCartTotal();
        },

        updateSaleCartTotal() {
            const subtotal = this.currentSaleCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const discount = parseFloat(document.getElementById('sale-discount').value) || 0;
            const total = subtotal - discount;
            
            document.getElementById('final-sale-amount').textContent = `AED ${total.toFixed(2)}`;
            document.getElementById('record-sale-btn').disabled = this.currentSaleCart.length === 0;
        },

        handleCreditReceived(e) {
            e.preventDefault();
            const employee = this.getCurrentEmployee();
            if(!employee) return;
            const storeId = document.getElementById('credit-store-id').value;
            const store = employee.stores.find(s => s.id === storeId);
            if (!store) return;
            const amount = parseFloat(document.getElementById('credit-received-amount').value);
            const outstanding = (store.creditUsed || 0) - (store.creditPaidBack || 0);
            if (isNaN(amount) || amount <= 0 || amount > outstanding) { this.showNotification('Invalid payment amount.', 'error'); return; }
            store.creditPaidBack = (store.creditPaidBack || 0) + amount;
            store.creditAvailable += amount;
            employee.transactions.push({
                id: `txn_${Date.now()}`, type: 'credit_received', storeId: storeId,
                amount: amount, date: new Date().toISOString()
            });
            this.saveState();
            this.closeModal('creditReceivedModal');
            this.setActiveTab('stores', 'employee');
            this.showNotification('Credit payment recorded!');
        },

        renderTabs(viewType) {
            let tabs = [];
            let containerId = '';
            let mobileTabsId = '';

            if (viewType === 'employee') {
                tabs = [ 
                    { id: 'dashboard', name: 'Dashboard', icon: 'fa-chart-line' }, 
                    { id: 'my-tasks', name: 'My Tasks', icon: 'fa-tasks' }, 
                    { id: 'my-inventory', name: 'My Inventory', icon: 'fa-boxes' },
                    { id: 'request-stock', name: 'Request Stock', icon: 'fa-truck-loading' },
                    { id: 'sales-expenses', name: 'Sales & Expenses', icon: 'fa-exchange-alt' }, 
                    { id: 'stores', name: 'Manage Stores', icon: 'fa-store' }, 
                    { id: 'invoices', name: 'Invoices', icon: 'fa-file-invoice-dollar' }, 
                    { id: 'ledger', name: 'Ledger', icon: 'fa-history' } 
                ];
                containerId = 'employee-tabs-container';
                mobileTabsId = 'mobile-tabs';
            } else { // company view
                 tabs = [
                    { id: 'company-dashboard', name: 'Dashboard', icon: 'fa-tachometer-alt' },
                    { id: 'company-employees', name: 'Employees', icon: 'fa-users' },
                    { id: 'company-inventory', name: 'Inventory', icon: 'fa-warehouse' },
                    { id: 'company-expenses', name: 'Expenses', icon: 'fa-receipt' },
                    { id: 'company-tasks', name: 'Tasks', icon: 'fa-tasks' }
                ];
                containerId = 'company-tabs-container';
            }

            document.getElementById(containerId).innerHTML = tabs.map(tab => `<button data-tab="${tab.id}" class="tab-button text-light-text-secondary dark:text-dark-text-secondary hover:text-light-text dark:hover:text-dark-text border-b-2 border-transparent py-3 px-1 sm:px-4 font-medium text-sm"><i class="fas ${tab.icon} mr-0 sm:mr-2"></i><span class="hidden sm:inline">${tab.name}</span></button>`).join('');
            
            if (mobileTabsId) {
                document.getElementById(mobileTabsId).innerHTML = tabs.map(tab => `<option value="${tab.id}">${tab.name}</option>`).join('');
            }
        },

        toggleSidenav() { 
            document.getElementById('side-panel').classList.toggle('-translate-x-full');
            document.getElementById('sidenav-backdrop').classList.toggle('hidden');
        },
        
        setActiveTab(tabName, viewType) {
            const viewSelector = viewType === 'company' ? '#company-view' : '#employee-view';
            const tabsContainerId = viewType === 'company' ? 'company-tabs-container' : 'employee-tabs-container';
            
            document.querySelectorAll(`${viewSelector} .tab-content`).forEach(el => el.classList.add('hidden'));
            document.querySelectorAll(`#${tabsContainerId} .tab-button`).forEach(el => el.classList.remove('active'));
            
            const contentEl = document.querySelector(`${viewSelector} #${tabName}-content`);
            if (contentEl) contentEl.classList.remove('hidden');

            const tabButton = document.querySelector(`#${tabsContainerId} [data-tab="${tabName}"]`);
            if (tabButton) tabButton.classList.add('active');

            if (viewType === 'employee') {
                const mobileTabs = document.getElementById('mobile-tabs');
                if (mobileTabs) mobileTabs.value = tabName;
                const renderMap = { dashboard: 'renderDashboard', 'my-tasks': 'renderMyTasks', 'my-inventory': 'renderMyInventory', 'sales-expenses': 'renderSalesAndExpenses', stores: 'renderStoresTab', invoices: 'renderInvoices', ledger: 'renderLedger', 'request-stock': 'renderRequestStockTab' };
                if (renderMap[tabName]) this[renderMap[tabName]]();
            } else { // company view
                const renderMap = { 
                    'company-dashboard': 'renderCompanyDashboardTab', 
                    'company-employees': 'renderCompanyEmployeesTab', 
                    'company-inventory': 'renderCompanyInventoryTab',
                    'company-expenses': 'renderCompanyExpensesTab',
                    'company-tasks': 'renderCompanyTasksTab',
                };
                if (renderMap[tabName]) this[renderMap[tabName]]();
            }
        },

        togglePanel(panelName, forceOpen = false) { 
            const icon = document.getElementById(`${panelName}-toggle-icon`); 
            const content = document.getElementById(`${panelName}-content`); 
            if(!icon || !content) return;
            const isHidden = content.classList.contains('hidden'); 
            if (forceOpen && isHidden) { content.classList.remove('hidden'); } 
            else if (!forceOpen) { content.classList.toggle('hidden'); } 
            icon.classList.toggle('fa-chevron-up', !content.classList.contains('hidden')); 
            icon.classList.toggle('fa-chevron-down', content.classList.contains('hidden')); 
        },
        
        toggleSearch(section) {
            const container = document.getElementById(`${section}-search-container`);
            if (container) {
                container.classList.toggle('hidden');
                if (!container.classList.contains('hidden')) {
                    document.getElementById(`${section}-search-input`).focus();
                }
            }
        },

        // --- COMPANY VIEW TAB RENDERERS ---
        renderCompanyDashboardTab() {
             Object.values(this.charts).forEach(chart => { if (chart) chart.destroy() });
             const isDark = this.state.theme === 'dark';
             const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
             const textColor = isDark ? '#e3e3e3' : '#1f2937';
            
             const transactionsByDate = {};
             this.state.employees.forEach(emp => {
                 (emp.transactions || []).forEach(t => {
                     const date = t.date.split('T')[0];
                     if (!transactionsByDate[date]) transactionsByDate[date] = { revenue: 0, expenses: 0 };
                     if (t.type === 'sale') transactionsByDate[date].revenue += t.amount;
                     if (t.type === 'expense') transactionsByDate[date].expenses += t.amount;
                 });
             });
             const sortedDates = Object.keys(transactionsByDate).sort();
             this.charts.companyRevenue = new Chart(document.getElementById('company-revenue-expense-chart').getContext('2d'), {
                 type: 'line',
                 data: {
                     labels: sortedDates,
                     datasets: [
                         { label: 'Total Revenue', data: sortedDates.map(date => transactionsByDate[date].revenue), borderColor: '#a6e3a1', backgroundColor: 'rgba(166, 227, 161, 0.2)', tension: 0.1, fill: true },
                         { label: 'Total Expenses', data: sortedDates.map(date => transactionsByDate[date].expenses), borderColor: '#f38ba8', backgroundColor: 'rgba(243, 139, 168, 0.2)', tension: 0.1, fill: true }
                     ]
                 },
                 options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } }, x: { grid: { color: gridColor }, ticks: { color: textColor } } }, plugins: { legend: { labels: { color: textColor } }, title: {display: true, text: 'Firm-Wide Revenue vs. Expenses', color: textColor, font:{size:16}} } }
             });

            const salesByProduct = {};
            this.state.employees.forEach(emp => {
                (emp.transactions || []).filter(t => t.type === 'sale').forEach(t => {
                    (t.items || []).forEach(item => {
                        salesByProduct[item.productId] = (salesByProduct[item.productId] || 0) + (item.price * item.quantity);
                    });
                });
            });
            const topProducts = Object.entries(salesByProduct).sort(([, a], [, b]) => b - a).slice(0, 5);
             this.charts.companyProducts = new Chart(document.getElementById('company-top-products-chart').getContext('2d'), {
                 type: 'bar',
                 data: {
                     labels: topProducts.map(([productId]) => this.getProduct(productId)?.name || 'Unknown'),
                     datasets: [{ label: 'Revenue by Product', data: topProducts.map(([, amount]) => amount), backgroundColor: ['#89b4fa', '#a6e3a1', '#f9e2af', '#fab387', '#f38ba8'] }]
                 },
                 options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } }, y: { grid: { color: gridColor }, ticks: { color: textColor } } }, plugins: { legend: { display: false }, title: { display: true, text: 'Top Products by Revenue (Firm-Wide)', color: textColor, font: { size: 16 } } } }
             });
        },

        renderCompanyEmployeesTab() {
            const container = document.querySelector('#company-view #company-employees-content');
            const activeEmployees = this.state.employees.filter(e => e.isActive);
            const inactiveEmployees = this.state.employees.filter(e => !e.isActive);
            let content = `<h3 class="text-xl font-bold mb-4">Active Employees (${activeEmployees.length})</h3>`;
            content += `<div class="space-y-3 mb-6">${activeEmployees.map(emp=>{const revenue=emp.transactions.filter(t=>t.type==='sale').reduce((sum,t)=>sum+t.amount,0);const expenses=emp.transactions.filter(t=>t.type==='expense').reduce((sum,t)=>sum+t.amount,0);return`<div class="bg-light-bg dark:bg-dark-bg p-3 rounded-lg"><div class="flex justify-between items-center"><div><span class="font-bold">${emp.name}</span><em class="text-xs ml-2 text-light-text-secondary dark:text-dark-text-secondary">(${emp.position})</em></div><div class="flex space-x-3"><button class="text-sm hover:text-primary" onclick="app.startEditEmployee('${emp.id}')"><i class="fas fa-pencil-alt"></i></button><button class="text-sm hover:text-accent-red" onclick="app.deactivateEmployee('${emp.id}')"><i class="fas fa-user-slash"></i></button></div></div><div class="text-xs mt-2 space-y-1 pl-1 border-l-2 border-gray-300 dark:border-gray-600 ml-1 pl-2"><div class="flex justify-between"><span>Revenue:</span> <span class="font-semibold text-accent-green">AED ${revenue.toFixed(2)}</span></div><div class="flex justify-between"><span>Expenses:</span> <span class="font-semibold text-accent-red">AED ${expenses.toFixed(2)}</span></div></div></div>`}).join('')||`<p class="text-sm text-light-text-secondary dark:text-dark-text-secondary">No active employees.</p>`}</div>`;
            if (inactiveEmployees.length > 0) {
                 content += `<h3 class="text-xl font-bold mb-4">Inactive Employees (${inactiveEmployees.length})</h3>`;
                 content += `<div class="space-y-3">${inactiveEmployees.map(emp=>`<div class="flex justify-between items-center bg-light-bg dark:bg-dark-bg opacity-60 p-3 rounded-lg"><span class="italic">${emp.name}</span><button class="text-sm text-accent-green hover:opacity-80 font-semibold" onclick="app.reactivateEmployee('${emp.id}')">Reactivate</button></div>`).join('')}</div>`;
            }
            container.innerHTML = content;
        },

        renderCompanyInventoryTab() {
            const container = document.querySelector('#company-view #company-inventory-content');
            let content = `<h3 class="text-xl font-bold mb-4">Master Inventory</h3>`;
            content += `<div class="overflow-x-auto bg-light-bg dark:bg-dark-bg rounded-lg"><table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700"><thead class="bg-gray-50 dark:bg-gray-800/50"><tr><th class="table-header">Product</th><th class="table-header">Price</th><th class="table-header">Stock</th><th class="table-header">Actions</th></tr></thead><tbody class="divide-y divide-gray-200 dark:divide-gray-700">`;
            content += this.getActiveProducts().map(prod => `
                <tr class="hover:bg-light-surface dark:hover:bg-dark-surface/50 text-sm">
                    <td class="px-6 py-4 whitespace-nowrap">${prod.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-mono">AED ${prod.price.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-mono">${prod.stock}</td>
                    <td class="px-6 py-4 whitespace-nowrap"><button class="text-sm hover:text-primary" onclick="app.startEditProduct('${prod.id}')"><i class="fas fa-pencil-alt"></i></button><button class="text-sm hover:text-accent-red ml-4" onclick="app.deleteProduct('${prod.id}')"><i class="fas fa-trash-alt"></i></button></td>
                </tr>
            `).join('') || `<tr><td colspan="4" class="text-center py-10 text-light-text-secondary dark:text-dark-text-secondary">No active products in master inventory.</td></tr>`;
            content += `</tbody></table></div>`;
            container.innerHTML = content;
        },
        
        renderCompanyExpensesTab() {
            const container = document.querySelector('#company-view #company-expenses-content');
            const isDark = this.state.theme === 'dark';
            const textColor = isDark ? '#e3e3e3' : '#1f2937';
            
            const expensesByCategory = {};
            this.state.employees.forEach(emp => {
                (emp.transactions || []).filter(t => t.type === 'expense').forEach(t => {
                    const category = this.getCategory(t.categoryId) || { name: 'Uncategorized' };
                    expensesByCategory[category.name] = (expensesByCategory[category.name] || 0) + t.amount;
                });
            });
            
            let content = `<h3 class="text-xl font-bold mb-4">Total Expenses by Category</h3>`;
            if (Object.keys(expensesByCategory).length > 0) {
                 content += `<div class="bg-light-bg dark:bg-dark-bg p-4 rounded-lg mx-auto" style="max-height: 400px; max-width: 400px;"><canvas id="company-expenses-by-category-chart"></canvas></div>`;
            } else {
                 content += `<p class="text-center py-8 text-light-text-secondary dark:text-dark-text-secondary">No expenses recorded yet.</p>`;
            }
            container.innerHTML = content;
            
            if (Object.keys(expensesByCategory).length > 0) {
                 Object.values(this.charts).forEach(chart=>{if(chart)chart.destroy()});
                 this.charts.companyExpensesByCategory = new Chart(document.getElementById('company-expenses-by-category-chart').getContext('2d'), {
                     type: 'doughnut',
                     data: {
                         labels: Object.keys(expensesByCategory),
                         datasets: [{ data: Object.values(expensesByCategory), backgroundColor: ['#f38ba8', '#fab387', '#f9e2af', '#a6e3a1', '#89b4fa', '#cba6f7', '#f5c2e7'], borderColor: isDark ? '#1e1f20' : '#ffffff', borderWidth: 4 }]
                     },
                     options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'top', labels: { color: textColor } } } }
                });
            }
        },

        renderCompanyTasksTab() {
             const container = document.querySelector('#company-view #company-tasks-content');
             let content = `<h3 class="text-xl font-bold mb-4">All Tasks</h3>`;
             const sortedTasks = [...this.state.tasks].sort((a, b) => (a.status === 'Completed' ? 1 : -1) - (b.status === 'Completed' ? 1 : -1));
             content += `<ul class="space-y-3">${sortedTasks.map(task => `
                <li class="bg-light-bg dark:bg-dark-bg p-4 rounded-lg flex justify-between items-center ${task.status === 'Completed' ? 'task-completed opacity-60' : ''}">
                    <div>
                        <p>${task.description}</p>
                        <small class="text-light-text-secondary dark:text-dark-text-secondary">To: <strong>${this.getEmployee(task.assigneeId)?.name || 'Unassigned'}</strong></small>
                    </div>
                    <span class="text-sm font-semibold">${task.status}</span>
                </li>`).join('') || `<p class="text-center py-8 text-light-text-secondary dark:text-dark-text-secondary">No tasks have been created yet.</p>`}</ul>`;
             container.innerHTML = content;
        },

        // --- EMPLOYEE VIEW TAB RENDERERS ---
        renderDashboard() { const employee=this.getCurrentEmployee();if(!employee)return;const isDark=this.state.theme==='dark';const gridColor=isDark?'rgba(255, 255, 255, 0.1)':'rgba(0, 0, 0, 0.1)';const textColor=isDark?'#e3e3e3':'#1f2937';Object.values(this.charts).forEach(chart=>{if(chart)chart.destroy()});const salesByDate=employee.transactions.filter(t=>t.type==='sale').reduce((acc,t)=>{const date=t.date.split('T')[0];acc[date]=(acc[date]||0)+t.amount;return acc},{});const sortedDates=Object.keys(salesByDate).sort();this.charts.sales=new Chart(document.getElementById('sales-over-time-chart').getContext('2d'),{type:'line',data:{labels:sortedDates,datasets:[{label:'Daily Revenue',data:sortedDates.map(date=>salesByDate[date]),borderColor:'#89b4fa',backgroundColor:'rgba(137, 180, 250, 0.2)',tension:0.1,fill:true}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,grid:{color:gridColor},ticks:{color:textColor}},x:{grid:{color:gridColor},ticks:{color:textColor}}},plugins:{legend:{labels:{color:textColor}}}}});const salesByProduct=employee.transactions.filter(t=>t.type==='sale').reduce((acc,t)=>{(t.items||[]).forEach(item=>{acc[item.productId]=(acc[item.productId]||0)+(item.price*item.quantity)});return acc},{});const topProducts=Object.entries(salesByProduct).sort(([,a],[,b])=>b-a).slice(0,5);this.charts.products=new Chart(document.getElementById('top-products-chart').getContext('2d'),{type:'bar',data:{labels:topProducts.map(([productId])=>this.getProduct(productId)?.name||'Unknown'),datasets:[{label:'Revenue by Product',data:topProducts.map(([,amount])=>amount),backgroundColor:['#89b4fa','#a6e3a1','#f9e2af','#fab387','#f38ba8']}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',scales:{x:{beginAtZero:true,grid:{color:gridColor},ticks:{color:textColor}},y:{grid:{color:gridColor},ticks:{color:textColor}}},plugins:{legend:{display:false},title:{display:true,text:'Top Products by Revenue',color:textColor,font:{size:16}}}}});const expensesByCategory=employee.transactions.filter(t=>t.type==='expense').reduce((acc,t)=>{const category=this.getCategory(t.categoryId)||{name:'Uncategorized'};acc[category.name]=(acc[category.name]||0)+t.amount;return acc},{});this.charts.expensesByCategory=new Chart(document.getElementById('expenses-by-category-chart').getContext('2d'),{type:'doughnut',data:{labels:Object.keys(expensesByCategory),datasets:[{data:Object.values(expensesByCategory),backgroundColor:['#f38ba8','#fab387','#f9e2af','#a6e3a1','#89b4fa','#cba6f7','#f5c2e7'],borderColor:isDark?'#1e1f20':'#ffffff',borderWidth:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{color:textColor}},title:{display:true,text:'Expenses by Category',color:textColor,font:{size:16}}}}});const totalCreditUsed=employee.stores.reduce((sum,s)=>sum+(s.creditUsed||0),0);const totalCreditAvailable=employee.stores.reduce((sum,s)=>sum+(s.creditAvailable||0),0);const outstandingCredit=totalCreditUsed-employee.stores.reduce((sum,s)=>sum+(s.creditPaidBack||0),0);const totalCreditLimit=totalCreditAvailable+totalCreditUsed;this.charts.credit=new Chart(document.getElementById('store-credit-chart').getContext('2d'),{type:'bar',data:{labels:['Credit Status'],datasets:[{label:'Outstanding',data:[outstandingCredit],backgroundColor:'#f38ba8'},{label:'Available',data:[totalCreditLimit-outstandingCredit],backgroundColor:'#a6e3a1'}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true,max:totalCreditLimit>0?totalCreditLimit:1},y:{stacked:true}},plugins:{title:{display:true,text:'My Store Credit Status',color:textColor,font:{size:16}},legend:{position:'top',labels:{color:textColor}}}}});},
        renderMyTasks() {
            const employeeTasks = this.state.tasks.filter(t => t.assigneeId === this.state.currentEmployeeId);
            document.getElementById('employee-tasks-list').innerHTML = employeeTasks.map(task => `<li class="bg-light-bg dark:bg-dark-bg p-4 rounded-lg flex justify-between items-center ${task.status === 'Completed' ? 'task-completed opacity-60' : ''}"><span>${task.description}</span><button class="text-black px-3 py-1 rounded-md text-sm font-semibold ${task.status === 'Completed' ? 'bg-gray-400' : 'bg-accent-green hover:opacity-80'}" onclick="app.toggleTaskStatus('${task.id}')">${task.status === 'Completed' ? 'Reopen' : 'Complete'}</button></li>`).join('') || `<p class="text-center py-8 text-light-text-secondary dark:text-dark-text-secondary">You have no assigned tasks.</p>`;
        },
        renderMyInventory() {
            const contentEl = document.getElementById('my-inventory-content');
            const employee = this.getCurrentEmployee();
            if (!employee) return;

            let currentInventoryHTML = `<h3 class="text-xl font-bold mb-4">My Current Inventory</h3>`;
            const currentStock = employee.inventory.filter(i => i.stock > 0);
            if (currentStock.length === 0) {
                currentInventoryHTML += `<div class="bg-light-bg dark:bg-dark-bg rounded-lg p-4 text-center text-light-text-secondary dark:text-dark-text-secondary">You have no stock.</div>`;
            } else {
                currentInventoryHTML += `<div class="overflow-x-auto bg-light-bg dark:bg-dark-bg rounded-lg"><table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700"><thead class="bg-light-bg dark:bg-dark-bg"><tr><th class="table-header">Product</th><th class="table-header">Stock</th></tr></thead><tbody id="employee-inventory-list" class="divide-y divide-gray-200 dark:divide-gray-700">
                ${currentStock.map(item => { const product = this.getProduct(item.productId); return `<tr class="hover:bg-light-surface dark:hover:bg-dark-surface/50"><td class="px-6 py-4 whitespace-nowrap">${product ? product.name : 'Unknown Product'}</td><td class="px-6 py-4 whitespace-nowrap font-mono">${item.stock}</td></tr>`; }).join('')}
                </tbody></table></div>`;
            }

            let pendingDeliveriesHTML = `<h3 class="text-xl font-bold mt-8 mb-4">Pending Deliveries</h3>`;
            const incomingStock = this.state.productRequests.filter(req => req.employeeId === employee.id && req.status === 'Approved');
            if (incomingStock.length === 0) {
                pendingDeliveriesHTML += `<div class="bg-light-bg dark:bg-dark-bg rounded-lg p-4 text-center text-light-text-secondary dark:text-dark-text-secondary">No incoming deliveries.</div>`;
            } else {
                pendingDeliveriesHTML += `<div class="space-y-3">${incomingStock.map(req => {
                    const product = this.getProduct(req.productId);
                    return `<div class="bg-light-bg dark:bg-dark-bg p-4 rounded-lg flex justify-between items-center">
                                <div>
                                    <p class="font-semibold">${product?.name || 'Unknown'}</p>
                                    <p class="text-sm text-light-text-secondary dark:text-dark-text-secondary">Quantity: ${req.quantity}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="app.openDeclineModal('${req.id}')" class="bg-accent-red/80 text-white font-semibold py-1 px-3 rounded-md hover:opacity-80">Decline</button>
                                    <button onclick="app.confirmStockReceipt('${req.id}')" class="bg-accent-green text-black font-semibold py-1 px-3 rounded-md hover:opacity-80">Confirm Receipt</button>
                                </div>
                            </div>`;
                }).join('')}</div>`;
            }

            contentEl.innerHTML = currentInventoryHTML + pendingDeliveriesHTML;
        },
        renderSalesAndExpenses() {
            const employee = this.getCurrentEmployee();
            if(!employee) return;
            // Setup Sales Form
            document.getElementById('sale-type').innerHTML = `<option value="Cash">Cash</option><option value="Credit">Credit</option><option value="Deal">Deal</option>`;
            document.getElementById('sale-store').innerHTML = employee.stores.map(s => `<option value="${s.id}">${s.name}</option>`).join('') || `<option disabled>Add a store first</option>`;
            const availableInventory = employee.inventory?.filter(item => item.stock > 0 && this.getProduct(item.productId)?.isActive) || [];
            document.getElementById('add-sale-product').innerHTML = `<option value="">-- Select Product --</option>` + availableInventory.map(item => {
                const product = this.getProduct(item.productId);
                return `<option value="${product.id}">${product.name} (Stock: ${item.stock})</option>`
            }).join('');
            
            // Clear cart from previous sessions and render
            this.currentSaleCart = [];
            this.renderSaleCart();

            // Setup Expense Form
            document.getElementById('expense-category').innerHTML=this.state.expenseCategories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')||`<option disabled>Add a category first</option>`;
            document.querySelector('#record-expense-form button').disabled=this.state.expenseCategories.length===0
        },
        
        renderRequestStockTab() {
            const container = document.getElementById('request-stock-content');
            if (!container) return;

            const activeProducts = this.getActiveProducts().filter(p => p.stock > 0);
            if (activeProducts.length === 0) {
                container.innerHTML = `<p class="text-center py-8 text-light-text-secondary dark:text-dark-text-secondary">No products available in master inventory to request.</p>`;
                return;
            }

            container.innerHTML = `
            <div class="bg-light-bg dark:bg-dark-bg p-4 sm:p-6 rounded-lg max-w-lg mx-auto">
                <h3 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-dolly-flatbed mr-3 text-accent-amber"></i>Request Stock from Master Inventory</h3>
                <form id="request-stock-form" class="space-y-4">
                    <div>
                        <label for="request-product" class="form-label">Product</label>
                        <select id="request-product" name="request-product" class="form-input">
                            ${activeProducts.map(p => `<option value="${p.id}">${p.name} (Master Stock: ${p.stock})</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="request-quantity" class="form-label">Quantity</label>
                        <input type="number" id="request-quantity" name="request-quantity" min="1" value="1" required class="form-input">
                    </div>
                    <button type="submit" class="w-full bg-primary text-black font-bold py-2 px-4 rounded-md hover:bg-primary-hover">Submit Request</button>
                </form>
            </div>
            `;
            document.getElementById('request-stock-form')?.addEventListener('submit', e => this.handleRequestStock(e));
        },

        setActiveInvoiceSubTab(subTabName) {
            this.state.activeInvoiceSubTab = subTabName;
            document.querySelectorAll('.invoice-sub-tab-content').forEach(p => p.classList.add('hidden'));
            document.querySelector(`#employee-view #${subTabName}-invoice-panel`)?.classList.remove('hidden');

            document.querySelectorAll('.invoice-sub-tab-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.subTab === subTabName);
            });
        },

        renderInvoices() {
            const employee = this.getCurrentEmployee();
            if(!employee) return;

            const invoiceStoreSelect = document.getElementById('invoice-store');
            if (invoiceStoreSelect) {
                const currentStoreValue = invoiceStoreSelect.value;
                invoiceStoreSelect.innerHTML = '<option value="">-- Select a Store --</option>' + employee.stores.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                if (employee.stores.find(s => s.id === currentStoreValue)) {
                    invoiceStoreSelect.value = currentStoreValue;
                }
                this.renderInvoiceTransactionList(invoiceStoreSelect.value);
            }

            const recentPanel = document.getElementById('recent-invoice-panel');
            if(recentPanel) {
                const sortedInvoices = [...(employee.invoices || [])].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 15);
                let recentContent = `<h3 class="text-xl font-bold mb-4">My Recent Invoices</h3><div class="space-y-3">`;
                if (sortedInvoices.length === 0) {
                    recentContent += `<p class="text-center text-sm text-light-text-secondary dark:text-dark-text-secondary py-4">No recent invoices found.</p>`;
                } else {
                    recentContent += sortedInvoices.map(inv => `
                    <div class="bg-light-surface dark:bg-dark-surface p-3 rounded-md flex justify-between items-center text-sm">
                        <div><div class="font-semibold">${inv.storeName}</div><div class="text-xs text-light-text-secondary dark:text-dark-text-secondary">${new Date(inv.date).toLocaleDateString()}</div></div>
                        <div class="font-mono font-bold text-lg">AED ${inv.total.toFixed(2)}</div>
                    </div>`).join('');
                }
                recentContent += `</div>`;
                recentPanel.innerHTML = recentContent;
            }
            
            this.renderPendingInvoices();
            this.setActiveInvoiceSubTab(this.state.activeInvoiceSubTab);
        },

        renderPendingInvoices() {
            const employee = this.getCurrentEmployee();
            if (!employee) return;
            const pendingPanel = document.getElementById('pending-invoice-panel');
            if (!pendingPanel) return;
            
            const storesWithPendingSales = employee.stores.map(store => {
                let pendingCount = 0;
                let pendingTotal = 0;
                this.state.employees.forEach(emp => {
                    (emp.transactions || []).forEach(t => {
                        if (t.type === 'sale' && t.storeId === store.id && !t.invoiced) {
                            pendingCount++;
                            pendingTotal += t.amount;
                        }
                    });
                });
                return { ...store, pendingCount, pendingTotal };
            }).filter(store => store.pendingCount > 0);

            let content = `<h3 class="text-xl font-bold mb-4">Stores with Pending Sales</h3><div class="space-y-3">`;
            if (storesWithPendingSales.length === 0) {
                content += `<p class="text-center text-sm text-light-text-secondary dark:text-dark-text-secondary py-4">No stores have pending sales to be invoiced.</p>`;
            } else {
                content += storesWithPendingSales.map(store => `
                    <div data-store-id="${store.id}" class="pending-invoice-item bg-light-surface dark:bg-dark-surface p-3 rounded-md flex justify-between items-center text-sm cursor-pointer hover:ring-2 hover:ring-primary">
                        <div>
                            <div class="font-semibold">${store.name}</div>
                            <div class="text-xs text-light-text-secondary dark:text-dark-text-secondary">${store.pendingCount} uninvoiced sale(s)</div>
                        </div>
                        <div class="font-mono font-bold text-lg">AED ${store.pendingTotal.toFixed(2)}</div>
                    </div>
                `).join('');
            }
            content += `</div>`;
            pendingPanel.innerHTML = content;
        },

        renderInvoiceTransactionList(storeId) {
            const container = document.getElementById('invoice-transactions-container');
            const listEl = document.getElementById('invoice-transactions-list');
            const generateBtn = document.querySelector('#invoice-form button[type="submit"]');

            if (!storeId) {
                container.classList.add('hidden');
                listEl.innerHTML = '';
                generateBtn.disabled = true;
                return;
            }
            let allSalesToStore = [];
            this.state.employees.forEach(emp => {
                (emp.transactions || []).forEach(t => {
                    if (t.type === 'sale' && t.storeId === storeId && !t.invoiced) {
                        allSalesToStore.push(t);
                    }
                });
            });

            allSalesToStore.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (allSalesToStore.length === 0) {
                listEl.innerHTML = `<p class="text-center text-sm text-light-text-secondary dark:text-dark-text-secondary py-4">No uninvoiced sales found for this store.</p>`;
                generateBtn.disabled = true;
            } else {
                listEl.innerHTML = allSalesToStore.map(t => {
                    const saleDetails = (t.items && t.items.length > 1) 
                        ? `${t.items.length} different products`
                        : `${t.items?.[0]?.quantity} x ${t.items?.[0]?.name}`;
                    const saleDate = new Date(t.date).toLocaleDateString();
                    return `
                        <label for="txn-${t.id}" class="flex items-center space-x-3 p-2 rounded-md hover:bg-light-surface dark:hover:bg-dark-surface cursor-pointer">
                            <input type="checkbox" id="txn-${t.id}" data-transaction-id="${t.id}" class="invoice-txn-checkbox h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary">
                            <div class="flex-grow flex justify-between items-center text-sm">
                                <div>
                                    <span class="font-semibold">${saleDetails}</span>
                                </div>
                                <div class="text-right">
                                    <span class="font-mono">${saleDate}</span>
                                    <strong class="ml-4">AED ${t.amount.toFixed(2)}</strong>
                                </div>
                            </div>
                        </label>
                    `;
                }).join('');
                generateBtn.disabled = true;
            }
            container.classList.remove('hidden');
        },

        renderModals() { 
            document.getElementById('modal-container').innerHTML=`
            ${this.getFirstTimeModalHTML()}
            ${this.getGenericModalHTML('addEmployeeModal','Add New Employee',`<form id="add-employee-form" class="space-y-4"><div><label for="new-employee-name" class="block text-sm font-medium">Name</label><input type="text" id="new-employee-name" required class="modal-input"></div><div><label for="new-employee-position" class="block text-sm font-medium">Position</label><input type="text" id="new-employee-position" required class="modal-input"></div><button type="submit" class="modal-submit-button">Add Employee</button></form>`)}
            ${this.getGenericModalHTML('editEmployeeModal','Edit Employee',`<form id="edit-employee-form" class="space-y-4"><input type="hidden" id="edit-employee-id"><div><label for="edit-employee-name" class="block text-sm font-medium">Name</label><input type="text" id="edit-employee-name" required class="modal-input"></div><div><label for="edit-employee-position" class="block text-sm font-medium">Position</label><input type="text" id="edit-employee-position" required class="modal-input"></div><button type="submit" class="modal-submit-button">Save Changes</button></form>`)}
            ${this.getGenericModalHTML('addProductModal','Add New Product / Stock',`<form id="add-product-form" class="space-y-4"><div><label for="new-product-name" class="block text-sm font-medium">Product Name</label><input type="text" id="new-product-name" required class="modal-input"></div><div id="price-container"><label for="new-product-price" class="block text-sm font-medium">Price (AED)</label><input type="number" id="new-product-price" step="0.01" min="0" required class="modal-input"></div><div><label id="stock-label" for="new-product-stock" class="block text-sm font-medium">Initial Stock</label><input type="number" id="new-product-stock" min="0" required class="modal-input"></div><button id="add-product-submit-btn" type="submit" class="modal-submit-button">Add Product</button></form>`)}
            ${this.getGenericModalHTML('editProductModal','Edit Product',`<form id="edit-product-form" class="space-y-4"><input type="hidden" id="edit-product-id"><div><label for="edit-product-name" class="block text-sm font-medium">Product Name</label><input type="text" id="edit-product-name" required class="modal-input"></div><div><label for="edit-product-price" class="block text-sm font-medium">Price (AED)</label><input type="number" id="edit-product-price" step="0.01" min="0" required class="modal-input"></div><div><label for="edit-product-stock" class="block text-sm font-medium">Current Stock</label><input type="number" id="edit-product-stock" min="0" required class="modal-input"></div><button type="submit" class="modal-submit-button">Save Changes</button></form>`)}
            ${this.getGenericModalHTML('addCategoryModal','Add Expense Category',`<form id="add-category-form" class="space-y-4"><div><label for="new-category-name" class="block text-sm font-medium">Category Name</label><input type="text" id="new-category-name" required class="modal-input"></div><button type="submit" class="modal-submit-button">Add Category</button></form>`)}
            ${this.getGenericModalHTML('editCategoryModal','Edit Expense Category',`<form id="edit-category-form" class="space-y-4"><input type="hidden" id="edit-category-id"><div><label for="edit-category-name" class="block text-sm font-medium">Category Name</label><input type="text" id="edit-category-name" required class="modal-input"></div><button type="submit" class="modal-submit-button">Save Changes</button></form>`)}
            ${this.getGenericModalHTML('delegateStockModal','Delegate Stock to Employee',`<form id="delegate-stock-form" class="space-y-4"><div><label for="delegate-employee" class="block text-sm font-medium">Employee</label><select id="delegate-employee" class="modal-input"></select></div><div><label for="delegate-product" class="block text-sm font-medium">Product</label><select id="delegate-product" class="modal-input"></select></div><div><label for="delegate-quantity" class="block text-sm font-medium">Quantity</label><input type="number" id="delegate-quantity" min="1" required class="modal-input"></div><button type="submit" class="modal-submit-button">Delegate Stock</button></form>`)}
            ${this.getGenericModalHTML('createTaskModal','Create a New Task',`<form id="create-task-form" class="space-y-4"><div><label for="task-description" class="block text-sm font-medium">Task Description</label><input type="text" id="task-description" required class="modal-input"></div><div><label for="task-assignee" class="block text-sm font-medium">Assign To</label><select id="task-assignee" class="modal-input"></select></div><button type="submit" class="modal-submit-button">Create Task</button></form>`)}
            ${this.getGenericModalHTML('editStoreModal','Edit Store',`<form id="edit-store-form" class="space-y-4"><input type="hidden" id="edit-store-id"><div><label for="edit-store-name" class="block text-sm font-medium">Store Name</label><input type="text" id="edit-store-name" required class="modal-input"></div><div><label for="edit-store-location" class="block text-sm font-medium">Location</label><input type="text" id="edit-store-location" required class="modal-input"></div><div><label for="edit-store-credit-limit" class="block text-sm font-medium">Credit Limit</label><input type="number" step="0.01" min="0" id="edit-store-credit-limit" required class="modal-input"></div><button type="submit" class="modal-submit-button">Save Changes</button></form>`)}
            ${this.getGenericModalHTML('creditReceivedModal','Receive Credit Payment',`<form id="credit-received-form" class="space-y-4"><input type="hidden" id="credit-store-id"><p>Receiving payment from: <strong id="credit-store-name"></strong></p><p>Outstanding credit: <strong id="credit-outstanding"></strong></p><div><label for="credit-received-amount" class="block text-sm font-medium">Amount Received</label><input type="number" id="credit-received-amount" step="0.01" min="0" required class="modal-input"></div><button type="submit" class="modal-submit-button">Record Payment</button></form>`)}
            ${this.getAImodalHTML()}
            ${this.getGenericModalHTML('declineStockModal', 'Decline Stock Delivery', `<form id="decline-stock-form" class="space-y-4"><input type="hidden" id="decline-request-id"><div><label for="decline-reason" class="block text-sm font-medium">Reason for Declining</label><select id="decline-reason" required class="modal-input"><option value="">-- Select a Reason --</option><option value="Damaged Goods">Damaged Goods</option><option value="Insufficient Goods">Insufficient Goods</option><option value="Other">Other</option></select></div><div><label for="decline-description" class="block text-sm font-medium">Description (Optional)</label><textarea id="decline-description" rows="3" class="modal-input"></textarea></div><button type="submit" class="modal-submit-button bg-accent-red hover:bg-accent-red/80">Submit Decline</button></form>`)}
            ${this.getGenericModalHTML('settingsModal', 'Settings', `
                <div class="space-y-6">
                    <div>
                        <label for="employee-switcher-modal" class="block text-sm font-medium mb-2">Current Employee</label>
                        <select id="employee-switcher-modal" class="modal-input"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Appearance</label>
                        <button id="theme-toggle-modal" class="w-full text-left bg-light-bg dark:bg-dark-bg p-3 rounded-lg flex items-center justify-between hover:bg-gray-200 dark:hover:bg-gray-700">
                            <span>Change Theme</span>
                            <i id="theme-icon-modal" class="fas"></i>
                        </button>
                    </div>
                    <div id="data-management-settings"></div>
                </div>
            `)}
             ${this.getGenericModalHTML('invoicePreviewModal', 'Invoice Preview', `
                <div id="invoice-preview-content" class="bg-white p-2 rounded max-h-[60vh] overflow-y-auto mb-4 border border-gray-300">
                    </div>
                <button id="download-previewed-invoice-btn" class="modal-submit-button">Download as PDF</button>
            `, 'max-w-4xl')}
            `
        },
        getGenericModalHTML(id, title, content, dialogClass = 'max-w-md') {
            return `<div id="${id}" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
                <div class="bg-light-surface dark:bg-dark-surface rounded-lg shadow-xl w-full ${dialogClass} mx-auto transform transition-all flex flex-col">
                    <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-xl font-semibold">${title}</h3>
                        <button onclick="app.closeModal('${id}')" class="text-light-text-secondary dark:text-dark-text-secondary hover:text-light-text dark:hover:text-dark-text">&times;</button>
                    </div>
                    <div class="p-6">${content}</div>
                </div>
            </div>`;
        },
        getFirstTimeModalHTML(){return`<div id="firstTimeModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop"><div class="bg-light-surface dark:bg-dark-surface rounded-lg shadow-xl w-full max-w-md mx-auto text-center p-8"><i class="fas fa-rocket text-4xl text-primary mb-4"></i><h2 class="text-2xl font-bold mb-2">Welcome to Ledgerly!</h2><p class="text-light-text-secondary dark:text-dark-text-secondary mb-6">Let's get you set up. Start by adding your first employee.</p><form id="first-employee-form" class="space-y-4"><div><label for="first-employee-name" class="sr-only">Name</label><input type="text" id="first-employee-name" placeholder="First Employee's Name" required class="modal-input"></div><div><label for="first-employee-position" class="sr-only">Position</label><input type="text" id="first-employee-position" placeholder="Position (e.g., Manager)" required class="modal-input"></div><button type="submit" class="modal-submit-button w-full">Get Started</button></form></div></div>`},
        getAImodalHTML() {
             return `
            <div id="aiAdvisorModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
                <div class="bg-light-surface dark:bg-dark-surface rounded-lg shadow-xl w-full max-w-2xl mx-auto transform transition-all flex flex-col" style="max-height: 90vh;">
                    <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                        <h3 class="text-xl font-semibold flex items-center"><i class="fas fa-brain mr-3 text-primary"></i>Accura AI <span class="text-primary font-bold ml-2">2.0 FLASH</span></h3>
                        <button onclick="app.closeModal('aiAdvisorModal')" class="text-light-text-secondary dark:text-dark-text-secondary hover:text-light-text dark:hover:text-dark-text">&times;</button>
                    </div>
                    <div class="p-4 flex-shrink-0">
                        <div id="ai-employee-selector-container" class="mb-4">
                            <label for="ai-employee-select" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary mb-1">Context</label>
                            <select id="ai-employee-select" class="w-full bg-light-bg dark:bg-dark-bg rounded-md p-2 focus:ring-2 focus:ring-primary focus:outline-none"></select>
                        </div>
                        <div class="border-b border-gray-200 dark:border-gray-600">
                             <nav class="-mb-px flex space-x-4" id="ai-tabs-nav">
                                 <button onclick="app.switchAITab('questions')" data-tab="questions" class="ai-tab-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-medium text-sm">Suggested Questions</button>
                                 <button onclick="app.switchAITab('chat')" data-tab="chat" class="ai-tab-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-medium text-sm">Chat</button>
                             </nav>
                        </div>
                    </div>
                    <div class="p-4 space-y-4 overflow-y-auto flex-grow min-h-0">
                        <div id="ai-questions-tab" class="ai-tab-content">
                             <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                 <button onclick="app.getAIResponse('Generate a sales action plan for me.')" class="text-left p-3 bg-light-bg dark:bg-dark-bg rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700"><p class="font-semibold">Generate Action Plan</p><p class="text-xs text-light-text-secondary dark:text-dark-text-secondary">Create a list of actionable steps to improve sales performance.</p></button>
                                 <button onclick="app.getAIResponse('Which of my products are performing the best and why?')" class="text-left p-3 bg-light-bg dark:bg-dark-bg rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700"><p class="font-semibold">Analyze Top Products</p><p class="text-xs text-light-text-secondary dark:text-dark-text-secondary">Identify top-selling products and suggest reasons for their success.</p></button>
                                 <button onclick="app.getAIResponse('Summarize my expenses and suggest where I can cut costs.')" class="text-left p-3 bg-light-bg dark:bg-dark-bg rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700"><p class="font-semibold">Find Cost Savings</p><p class="text-xs text-light-text-secondary dark:text-dark-text-secondary">Break down expenses by category and find optimization opportunities.</p></button>
                                 <button onclick="app.getAIResponse('Which of my stores has the most outstanding credit?')" class="text-left p-3 bg-light-bg dark:bg-dark-bg rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700"><p class="font-semibold">Analyze Store Credit</p><p class="text-xs text-light-text-secondary dark:text-dark-text-secondary">Identify stores with high credit usage and their limits.</p></button>
                             </div>
                             <div id="ai-response-area" class="mt-4 p-3 bg-light-bg dark:bg-dark-bg rounded-md text-sm prose max-w-none min-h-[100px]"><p class="text-light-text-secondary dark:text-dark-text-secondary">Your AI-generated response will appear here.</p></div>
                        </div>
                        <div id="ai-chat-tab" class="ai-tab-content hidden h-full flex flex-col">
                            <div id="ai-chat-history" class="flex-grow min-h-0 overflow-y-auto p-3 bg-light-bg dark:bg-dark-bg rounded-md mb-3 text-sm space-y-4"></div>
                            <div class="flex space-x-2 flex-shrink-0">
                                <input type="text" id="ai-chat-input" class="modal-input flex-grow" placeholder="Ask a question...">
                                <button id="ai-chat-send" class="px-4 py-2 bg-primary text-black font-semibold rounded-md hover:bg-primary-hover"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        },
        renderEmployeeSwitcher() { 
            const switcher = document.getElementById('employee-switcher-modal');
            if (!switcher) return;
            const currentVal = switcher.value;
            switcher.innerHTML = this.getActiveEmployees().map(emp => `<option value="${emp.id}" ${emp.id === this.state.currentEmployeeId ? 'selected' : ''}>${emp.name}</option>`).join('');
            if (currentVal) {
                switcher.value = currentVal;
            }
        },
        renderProductRequestsPanel() {
            const container = document.getElementById('product-requests-content');
            if (!container) return;
            const pendingRequests = this.state.productRequests.filter(req => req.status === 'Pending');
            const declinedRequests = this.state.productRequests.filter(req => req.status === 'Declined');
            
            let html = '';

            if (declinedRequests.length > 0) {
                html += '<h4 class="text-sm font-bold text-accent-red mb-2">Returned Deliveries</h4>';
                html += declinedRequests.map(req => {
                    const employee = this.getEmployee(req.employeeId);
                    const product = this.getProduct(req.productId);
                    if (!employee || !product) return '';
                    return `<div class="bg-light-bg dark:bg-dark-bg p-3 rounded-lg text-sm space-y-2 border-l-4 border-accent-red">
                        <div><strong>${employee.name}</strong> requests <strong>${req.quantity} x ${product.name}</strong>.</div>
                        <div class="text-xs p-2 bg-red-500/10 rounded-md">
                            <p class="font-bold">Reason: ${req.declineReason}</p>
                            ${req.declineDescription ? `<p class="mt-1 italic">"${req.declineDescription}"</p>` : ''}
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button onclick="app.handleAdminDismissal('${req.id}')" class="px-2 py-1 text-xs font-semibold rounded bg-gray-500/30 text-gray-800 dark:text-gray-300 hover:opacity-80">Dismiss</button>
                            <button onclick="app.handleAdminApproval('${req.id}')" class="px-2 py-1 text-xs font-semibold rounded bg-accent-green/30 text-accent-green hover:opacity-80">Re-approve</button>
                        </div>
                    </div>`;
                }).join('');
            }

            if (pendingRequests.length > 0) {
                html += `<h4 class="text-sm font-bold text-light-text-secondary dark:text-dark-text-secondary ${declinedRequests.length > 0 ? 'mt-4' : ''} mb-2">New Requests</h4>`;
                html += pendingRequests.map(req => {
                    const employee = this.getEmployee(req.employeeId);
                    const product = this.getProduct(req.productId);
                    if (!employee || !product) return '';
                    return `<div class="bg-light-bg dark:bg-dark-bg p-3 rounded-lg text-sm space-y-2">
                        <div><strong>${employee.name}</strong> requests <strong>${req.quantity} x ${product.name}</strong>.</div>
                        <div class="flex justify-end space-x-2">
                            <button onclick="app.handleAdminDismissal('${req.id}')" class="px-2 py-1 text-xs font-semibold rounded bg-accent-red/30 text-accent-red hover:opacity-80">Deny</button>
                            <button onclick="app.handleAdminApproval('${req.id}')" class="px-2 py-1 text-xs font-semibold rounded bg-accent-green/30 text-accent-green hover:opacity-80">Approve</button>
                        </div>
                    </div>`;
                }).join('');
            }

            container.innerHTML = html || `<p class="text-xs text-center text-light-text-secondary dark:text-dark-text-secondary py-2">No pending requests.</p>`;
        },
        handleAdminApproval(requestId) {
            const request = this.state.productRequests.find(r => r.id === requestId);
            if (!request) return;

            const product = this.getProduct(request.productId);
            if (product.stock < request.quantity) {
                this.showNotification(`Cannot approve: Not enough master stock for ${product.name}.`, 'error');
                return;
            }

            request.status = 'Approved';
            delete request.declineReason;
            delete request.declineDescription;

            this.saveState();
            this.render();
            this.showNotification(`Request approved. Awaiting employee confirmation.`);
        },
        handleAdminDismissal(requestId) {
            this.state.productRequests = this.state.productRequests.filter(r => r.id !== requestId);
            this.saveState();
            this.render();
            this.showNotification('Request denied and dismissed.', 'error');
        },
        confirmStockReceipt(requestId) {
            const requestIndex = this.state.productRequests.findIndex(r => r.id === requestId);
            if (requestIndex === -1) return;

            const request = this.state.productRequests[requestIndex];
            const employee = this.getEmployee(request.employeeId);
            const product = this.getProduct(request.productId);

            if (!employee || !product) {
                this.showNotification('Error: Employee or product not found.', 'error');
                return;
            }

            if (product.stock < request.quantity) {
                this.showNotification(`Action failed: Not enough master stock for ${product.name}.`, 'error');
                this.state.productRequests.splice(requestIndex, 1); // Remove failed request
                this.saveState();
                this.render();
                return;
            }

            product.stock -= request.quantity;
            let employeeInventoryItem = employee.inventory.find(i => i.productId === request.productId);
            if (employeeInventoryItem) {
                employeeInventoryItem.stock += request.quantity;
            } else {
                employee.inventory.push({ productId: request.productId, stock: request.quantity });
            }

            this.state.productRequests.splice(requestIndex, 1);
            this.saveState();
            this.setActiveTab('my-inventory', 'employee'); 
            this.showNotification(`Stock received and added to your inventory.`);
        },
        openDeclineModal(requestId) {
            document.getElementById('decline-request-id').value = requestId;
            this.openModal('declineStockModal');
        },
        handleDeclineStock(e) {
            e.preventDefault();
            const form = e.target;
            const requestId = document.getElementById('decline-request-id').value;
            const reason = document.getElementById('decline-reason').value;
            const description = document.getElementById('decline-description').value;

            if (!reason) {
                this.showNotification('Please select a reason for declining.', 'error');
                return;
            }

            const request = this.state.productRequests.find(r => r.id === requestId);
            if (request) {
                request.status = 'Declined';
                request.declineReason = reason;
                request.declineDescription = description;
            }

            this.saveState();
            this.closeModal('declineStockModal');
            this.render();
            this.showNotification('Delivery declined and returned to sender.');
            form.reset();
        },
        applyTheme() { 
            const isDark = this.state.theme === 'dark';
            document.documentElement.classList.toggle('dark', isDark);
            const themeIcon = document.getElementById('theme-icon-modal');
            if (themeIcon) {
                themeIcon.className = `fas ${isDark ? 'fa-sun' : 'fa-moon'}`;
            }
        },
        toggleTheme() { 
            this.state.theme = this.state.theme === 'dark' ? 'light' : 'dark';
            this.applyTheme();
            this.saveState(); 
            this.render();
        },
        openModal(modalId) {
            if (modalId === 'settingsModal') {
                this.renderEmployeeSwitcher();
                this.applyTheme();
            }
            if(modalId==='delegateStockModal'){document.getElementById('delegate-employee').innerHTML=this.getActiveEmployees().map(e=>`<option value="${e.id}">${e.name}</option>`).join('');document.getElementById('delegate-product').innerHTML=this.getActiveProducts().filter(p=>p.stock>0).map(p=>`<option value="${p.id}">${p.name} (Master Stock: ${p.stock})</option>`).join('')}
            if(modalId==='createTaskModal'){document.getElementById('task-assignee').innerHTML=this.getActiveEmployees().map(e=>`<option value="${e.id}">${e.name}</option>`).join('')}
            if(modalId === 'aiAdvisorModal') {
                const selector = document.getElementById('ai-employee-select');
                selector.innerHTML = `<option value="company">Entire Company</option>` + this.getActiveEmployees().map(emp => `<option value="${emp.id}">${emp.name}</option>`).join('');
                
                if (this.state.currentView === 'company') {
                    selector.value = 'company';
                } else {
                    selector.value = this.state.currentEmployeeId;
                }
                this.switchAITab('questions');
                document.getElementById('ai-response-area').innerHTML = `<p class="text-light-text-secondary dark:text-dark-text-secondary">Your AI-generated response will appear here.</p>`;
                document.getElementById('ai-chat-history').innerHTML = '';
                
                // Attach listeners for chat
                const sendBtn = document.getElementById('ai-chat-send');
                const chatInput = document.getElementById('ai-chat-input');
                const sendMsg = () => {
                    const prompt = chatInput.value.trim();
                    if(prompt) this.getAIResponse(prompt, true);
                    chatInput.value = '';
                };
                sendBtn.onclick = sendMsg;
                chatInput.onkeyup = (e) => { if(e.key === 'Enter') sendMsg(); };
            }
            if (modalId === 'addProductModal') {
                this.handleProductNameInput({ target: { value: '' } }); // Reset modal state
            }
            document.getElementById(modalId)?.classList.remove('hidden');
        },
        closeModal(modalId){document.getElementById(modalId)?.classList.add('hidden')},
        createEmployee(name,position){return{id:`emp_${Date.now()}`,name,position,isActive:true,inventory:[],transactions:[],stores:[],invoices:[]}},
        handleFirstEmployee(e){e.preventDefault();const name=document.getElementById('first-employee-name').value;const position=document.getElementById('first-employee-position').value;if(!name.trim()||!position.trim())return;const firstEmployee=this.createEmployee(name,position);this.state.employees.push(firstEmployee);this.state.currentEmployeeId=firstEmployee.id; this.state.currentView = 'employee'; this.saveState();this.render();this.togglePanel('quick-actions',true);this.togglePanel('product-requests',true);},
        handleAddEmployee(e){e.preventDefault();const name=document.getElementById('new-employee-name').value;const position=document.getElementById('new-employee-position').value;if(!name.trim()||!position.trim())return;this.state.employees.push(this.createEmployee(name,position));this.saveState();this.render();this.closeModal('addEmployeeModal');this.showNotification('Employee added successfully!');e.target.reset()},
        startEditEmployee(id){const employee=this.getEmployee(id);if(!employee)return;document.getElementById('edit-employee-id').value=id;document.getElementById('edit-employee-name').value=employee.name;document.getElementById('edit-employee-position').value=employee.position;this.openModal('editEmployeeModal')},
        handleUpdateEmployee(e){e.preventDefault();const id=document.getElementById('edit-employee-id').value;const employee=this.getEmployee(id);if(!employee)return;employee.name=document.getElementById('edit-employee-name').value;employee.position=document.getElementById('edit-employee-position').value;this.saveState();this.render();this.closeModal('editEmployeeModal');this.showNotification('Employee updated!')},
        deactivateEmployee(id){if(confirm('Are you sure you want to deactivate this employee? They will not be able to log sales or expenses.')){const employee=this.getEmployee(id);if(employee){employee.isActive=false;this.saveState();this.render();this.showNotification('Employee deactivated.','error')}}},
        reactivateEmployee(id){const employee=this.getEmployee(id);if(employee){employee.isActive=true;this.saveState();this.render();this.showNotification('Employee reactivated.')}},
        handleEmployeeSwitch(e){
            this.state.currentEmployeeId = e.target.value;
            this.state.currentView = 'employee';
            this.state.ledgerFilter = 'all'; 
            this.state.activeInvoiceSubTab = 'create'; 
            this.state.storeSearchTerm = '';
            this.state.ledgerSearchTerm = '';
            this.saveState();
            this.closeModal('settingsModal');
            this.render();
        },
        handleAddStore(e){e.preventDefault();const employee = this.getCurrentEmployee(); if(!employee) return; const name=document.getElementById('new-store-name').value;const location=document.getElementById('new-store-location').value;const creditLimit=parseFloat(document.getElementById('new-store-credit-limit').value);if(!name.trim()||isNaN(creditLimit)){this.showNotification('Please fill all fields correctly.','error');return}employee.stores.push({id:`store_${Date.now()}`,name,location,creditAvailable:creditLimit,creditUsed:0,creditPaidBack:0});this.saveState();this.setActiveTab('stores', 'employee');this.showNotification('Store added successfully!');e.target.reset()},
        startEditStore(id){const employee = this.getCurrentEmployee(); if(!employee) return; const store=employee.stores.find(s=>s.id===id);if(!store)return;document.getElementById('edit-store-id').value=id;document.getElementById('edit-store-name').value=store.name;document.getElementById('edit-store-location').value=store.location;document.getElementById('edit-store-credit-limit').value=(store.creditAvailable||0)+(store.creditUsed||0);this.openModal('editStoreModal')},
        handleUpdateStore(e){e.preventDefault();const employee = this.getCurrentEmployee(); if(!employee) return; const id=document.getElementById('edit-store-id').value;const store=employee.stores.find(s=>s.id===id);if(!store)return;const newCreditLimit=parseFloat(document.getElementById('edit-store-credit-limit').value);const creditUsed = store.creditUsed || 0; if(isNaN(newCreditLimit)||newCreditLimit<creditUsed){this.showNotification('New credit limit cannot be less than credit already used.','error');return}store.name=document.getElementById('edit-store-name').value;store.location=document.getElementById('edit-store-location').value;store.creditAvailable=newCreditLimit-creditUsed;this.saveState();this.setActiveTab('stores', 'employee');this.closeModal('editStoreModal');this.showNotification('Store updated!')},
        deleteStore(id){if(confirm('Are you sure you want to delete this store? This action cannot be undone.')){const employee = this.getCurrentEmployee(); if(!employee) return; employee.stores=employee.stores.filter(s=>s.id!==id);this.saveState();this.setActiveTab('stores', 'employee');this.showNotification('Store deleted.','error')}},
        startReceiveCredit(id){const employee = this.getCurrentEmployee(); if(!employee) return; const store=employee.stores.find(s=>s.id===id);if(!store)return;const outstanding=(store.creditUsed||0)-(store.creditPaidBack||0);if(outstanding<=0){this.showNotification('This store has no outstanding credit.','success');return}document.getElementById('credit-store-id').value=id;document.getElementById('credit-store-name').textContent=store.name;document.getElementById('credit-outstanding').textContent=`AED ${outstanding.toFixed(2)}`;document.getElementById('credit-received-amount').max=outstanding;document.getElementById('credit-received-amount').value=outstanding.toFixed(2);this.openModal('creditReceivedModal')},
        
        handleProductNameInput(e) {
            const name = e.target.value.trim().toLowerCase();
            const existingProduct = this.state.masterInventory.find(p => p.name.toLowerCase() === name);
            const priceContainer = document.getElementById('price-container');
            const priceInput = document.getElementById('new-product-price');
            const stockLabel = document.getElementById('stock-label');
            const submitBtn = document.getElementById('add-product-submit-btn');

            if (existingProduct) {
                priceInput.value = existingProduct.price;
                priceInput.disabled = true;
                priceContainer.classList.add('opacity-50');
                stockLabel.textContent = 'Add Stock Quantity';
                submitBtn.textContent = 'Add Stock';
            } else {
                priceInput.disabled = false;
                priceContainer.classList.remove('opacity-50');
                stockLabel.textContent = 'Initial Stock';
                submitBtn.textContent = 'Add Product';
            }
        },

        handleAddProduct(e){
            e.preventDefault();
            const nameInput = document.getElementById('new-product-name');
            const name = nameInput.value.trim();
            const price = parseFloat(document.getElementById('new-product-price').value);
            const stock = parseInt(document.getElementById('new-product-stock').value);

            if (!name || isNaN(stock) || stock < 0) {
                this.showNotification('Please provide a valid name and stock quantity.', 'error');
                return;
            }

            const existingProduct = this.state.masterInventory.find(p => p.name.toLowerCase() === name.toLowerCase());

            if (existingProduct) {
                existingProduct.stock += stock;
                this.showNotification(`Added ${stock} to ${existingProduct.name}. New total: ${existingProduct.stock}.`);
            } else {
                if (isNaN(price) || price < 0) {
                    this.showNotification('Please provide a valid price for the new product.', 'error');
                    return;
                }
                this.state.masterInventory.push({id:`prod_${Date.now()}`,name,price,stock,isActive:true});
                this.showNotification('Product added to master inventory!');
            }

            this.saveState();
            this.render();
            this.closeModal('addProductModal');
            e.target.reset();
        },

        startEditProduct(id){const product=this.getProduct(id);if(!product)return;document.getElementById('edit-product-id').value=id;document.getElementById('edit-product-name').value=product.name;document.getElementById('edit-product-price').value=product.price;document.getElementById('edit-product-stock').value=product.stock;this.openModal('editProductModal')},
        handleUpdateProduct(e){e.preventDefault();const id=document.getElementById('edit-product-id').value;const product=this.getProduct(id);if(!product)return;product.name=document.getElementById('edit-product-name').value;product.price=parseFloat(document.getElementById('edit-product-price').value);product.stock=parseInt(document.getElementById('edit-product-stock').value);this.saveState();this.render();this.closeModal('editProductModal');this.showNotification('Product updated!')},
        deleteProduct(id){if(confirm('Are you sure you want to delete this product? It will become unavailable for new sales.')){const product=this.getProduct(id);if(product){product.isActive=false;this.saveState();this.render();this.showNotification('Product deleted.','error')}}},
        handleAddCategory(e){e.preventDefault();const name=document.getElementById('new-category-name').value;if(!name.trim())return;this.state.expenseCategories.push({id:`cat_${Date.now()}`,name});this.saveState();this.render();this.closeModal('addCategoryModal');this.showNotification('Category added!');e.target.reset()},
        startEditCategory(id){const category=this.getCategory(id);if(!category)return;document.getElementById('edit-category-id').value=id;document.getElementById('edit-category-name').value=category.name;this.openModal('editCategoryModal')},
        handleUpdateCategory(e){e.preventDefault();const id=document.getElementById('edit-category-id').value;const category=this.getCategory(id);if(!category)return;category.name=document.getElementById('edit-category-name').value;this.saveState();this.render();this.closeModal('editCategoryModal');this.showNotification('Category updated!')},
        deleteCategory(id){if(this.state.expenseCategories.length<=1){this.showNotification('Cannot delete the last category.','error');return}if(confirm('Are you sure? Existing expenses under this category will become uncategorized.')){const uncategorized=this.state.expenseCategories.find(c=>c.name.toLowerCase()==='uncategorized')||this.state.expenseCategories[0];this.state.employees.forEach(emp=>{emp.transactions.forEach(t=>{if(t.type==='expense'&&t.categoryId===id){t.categoryId=uncategorized.id}})});this.state.expenseCategories=this.state.expenseCategories.filter(c=>c.id!==id);this.saveState();this.render();this.showNotification('Category deleted.','error')}},
        handleDelegateStock(e){e.preventDefault();const employeeId=document.getElementById('delegate-employee').value;const productId=document.getElementById('delegate-product').value;const quantity=parseInt(document.getElementById('delegate-quantity').value);const employee=this.getEmployee(employeeId);const product=this.getProduct(productId);if(!employee||!product||isNaN(quantity)||quantity<=0){this.showNotification('Invalid delegation details.','error');return}if(product.stock<quantity){this.showNotification('Not enough stock in master inventory.','error');return}product.stock-=quantity;let employeeProduct=employee.inventory.find(p=>p.productId===productId);if(employeeProduct){employeeProduct.stock+=quantity}else{employee.inventory.push({productId:productId,stock:quantity})}this.saveState();this.render();this.closeModal('delegateStockModal');this.showNotification(`Delegated ${quantity} of ${product.name} to ${employee.name}.`)},
        handleCreateTask(e){e.preventDefault();const description=document.getElementById('task-description').value;const assigneeId=document.getElementById('task-assignee').value;if(!description.trim()||!assigneeId)return;this.state.tasks.push({id:`task_${Date.now()}`,description,assigneeId,status:'Pending'});this.saveState();this.render();this.closeModal('createTaskModal');this.showNotification('Task created successfully!');e.target.reset()},
        toggleTaskStatus(id){const task=this.getTask(id);if(task){task.status=task.status==='Completed'?'Pending':'Completed';this.saveState();this.render()}},
        handleRequestStock(e) {
            e.preventDefault();
            const employee = this.getCurrentEmployee();
            if (!employee) return;

            const productId = document.getElementById('request-product').value;
            const quantity = parseInt(document.getElementById('request-quantity').value);

            if (!productId || isNaN(quantity) || quantity <= 0) {
                this.showNotification('Please select a product and enter a valid quantity.', 'error');
                return;
            }

            const request = {
                id: `req_${Date.now()}`,
                employeeId: employee.id,
                productId: productId,
                quantity: quantity,
                date: new Date().toISOString(),
                status: 'Pending'
            };

            this.state.productRequests.push(request);
            this.saveState();
            this.render();
            this.showNotification('Stock request submitted successfully!');
            e.target.reset();
        },
        handleRecordSale(e){
            e.preventDefault();
            const form=e.target;
            const employee=this.getCurrentEmployee();

            if (this.currentSaleCart.length === 0) {
                this.showNotification('Please add at least one item to the sale.', 'error');
                return;
            }

            const saleType = form.elements['sale-type'].value;
            const storeId = form.elements['sale-store'].value;
            const discount = parseFloat(form.elements['sale-discount'].value) || 0;
            const store = employee.stores.find(s => s.id === storeId);
            
            if (!store) {
                this.showNotification('Please select a valid store.', 'error');
                return;
            }
            
            const subtotal = this.currentSaleCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const finalAmount = subtotal - discount;

            if (saleType === 'Credit') {
                const outstandingCredit = (store.creditUsed || 0) - (store.creditPaidBack || 0);
                const creditLimit = (store.creditAvailable || 0) + (store.creditUsed || 0);
                if (outstandingCredit + finalAmount > creditLimit) {
                    this.showNotification('This sale exceeds the store\'s credit limit.', 'error');
                    return;
                }
                store.creditUsed = (store.creditUsed || 0) + finalAmount;
                store.creditAvailable = (store.creditAvailable || 0) - finalAmount;
            }
            
            // Deduct stock for all items
            this.currentSaleCart.forEach(cartItem => {
                 if (saleType === 'Deal') {
                    const masterProduct = this.getProduct(cartItem.productId);
                    if (masterProduct.stock < cartItem.quantity) {
                         this.showNotification(`Not enough stock in Master Inventory for ${masterProduct.name} for a deal sale.`, 'error');
                         throw new Error("Insufficient master stock for deal."); // Stop transaction
                    }
                    masterProduct.stock -= cartItem.quantity;
                 } else {
                    const employeeInventoryItem = employee.inventory.find(i => i.productId === cartItem.productId);
                    employeeInventoryItem.stock -= cartItem.quantity;
                 }
            });

            employee.transactions.push({
                id: `txn_${Date.now()}`,
                type: 'sale',
                items: [...this.currentSaleCart],
                saleType,
                storeId,
                discount,
                amount: finalAmount,
                date: new Date().toISOString(),
                invoiced: false
            });
            
            this.saveState();
            this.showNotification('Sale recorded successfully!');
            this.currentSaleCart = []; // Clear the cart
            this.setActiveTab('sales-expenses', 'employee'); // Re-render tab
        },
        handleRecordExpense(e){e.preventDefault();const form=e.target;const employee=this.getCurrentEmployee();if(!employee)return;const description=form.elements['expense-description'].value;const amount=parseFloat(form.elements['expense-amount'].value);const categoryId=form.elements['expense-category'].value;if(!description.trim()||isNaN(amount)||amount<=0||!categoryId){this.showNotification('Please fill all fields correctly.','error');return}const newExpense={id:`txn_${Date.now()}`,type:'expense',description:description.trim(),amount,categoryId,date:new Date().toISOString()};employee.transactions.push(newExpense);this.saveState();this.setActiveTab('sales-expenses', 'employee');this.showNotification('Expense recorded successfully!','success');form.reset()},

        previewInvoice(invoiceId) {
            let foundInvoice = null;
            for (const emp of this.state.employees) {
                const invoice = (emp.invoices || []).find(inv => inv.id === invoiceId);
                if (invoice) {
                    foundInvoice = invoice;
                    break;
                }
            }

            if (foundInvoice && foundInvoice.htmlContent) {
                const modal = document.getElementById('invoicePreviewModal');
                document.getElementById('invoice-preview-content').innerHTML = foundInvoice.htmlContent;
                
                const downloadBtn = document.getElementById('download-previewed-invoice-btn');
                downloadBtn.onclick = () => this.downloadInvoice(
                    foundInvoice.htmlContent, 
                    { name: foundInvoice.storeName }, 
                    new Date(foundInvoice.date).toISOString().split('T')[0]
                );

                this.openModal('invoicePreviewModal');
            } else {
                this.showNotification('Could not find the saved invoice data.', 'error');
                console.error(`Invoice with ID ${invoiceId} not found or has no HTML content.`);
            }
        },
        
        downloadInvoice(invoiceHTML, store, invoiceDate) {
            this.showNotification('Generating PDF...');

            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.inset = '0';
            overlay.style.backgroundColor = 'white';
            overlay.style.zIndex = '9999';
            overlay.style.overflow = 'auto';
            overlay.style.padding = '1rem';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'flex-start';
            overlay.style.justifyContent = 'center';

            overlay.innerHTML = invoiceHTML;
            
            const elementToCapture = overlay.firstElementChild;

            document.body.appendChild(overlay);

            const opt = {
                margin:       0.5,
                filename:     `Invoice_${store.name.replace(/\s/g, '_')}_${invoiceDate}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            const cleanup = () => {
                document.body.removeChild(overlay);
            };

            setTimeout(() => {
                html2pdf().set(opt).from(elementToCapture).save().then(() => {
                    cleanup();
                    this.showNotification('Invoice downloaded!', 'success');
                    this.closeModal('invoicePreviewModal');
                }).catch(err => {
                    cleanup();
                    this.showNotification('Error generating PDF.', 'error');
                    console.error('PDF Generation Error:', err);
                    this.closeModal('invoicePreviewModal');
                });
            }, 150);
        },

        handleGenerateInvoice(e) {
            e.preventDefault();
            const employee = this.getCurrentEmployee();
            const storeId = document.getElementById('invoice-store').value;
            const store = employee.stores.find(s => s.id === storeId);
            if (!store) { return; }

            const selectedCheckboxes = document.querySelectorAll('.invoice-txn-checkbox:checked');
            if (selectedCheckboxes.length === 0) { return; }

            const selectedTxnIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.transactionId);
            
            const invoiceId = `inv_${Date.now()}`;
            const salesInPeriod = [];
            let total = 0;

            selectedTxnIds.forEach(txnId => {
                for (const emp of this.state.employees) {
                    const transaction = (emp.transactions || []).find(t => t.id === txnId);
                    if (transaction) {
                        transaction.invoiced = invoiceId;
                        salesInPeriod.push(transaction);
                        total += transaction.amount;
                        break;
                    }
                }
            });

            const invoiceDate = new Date();
            const invoiceHTML = this.generateInvoiceHtml(store, salesInPeriod, total, invoiceId, invoiceDate);

            const newInvoice = {
                id: invoiceId,
                storeId: store.id,
                storeName: store.name,
                date: invoiceDate.toISOString(),
                total: total,
                transactionIds: selectedTxnIds,
                htmlContent: invoiceHTML
            };

            if (!employee.invoices) employee.invoices = [];
            employee.invoices.push(newInvoice);
            this.saveState();
            
            this.showNotification('Invoice created and saved successfully!');
            
            this.state.activeInvoiceSubTab = 'recent';
            this.setActiveTab('invoices', 'employee');
        },

        generateInvoiceHtml(store, sales, total, invoiceId, invoiceDate) {
            const salesByDate = sales.reduce((acc, sale) => {
                const date = new Date(sale.date).toLocaleDateString('en-CA');
                if (!acc[date]) {
                    acc[date] = [];
                }
                acc[date].push(sale);
                return acc;
            }, {});

            const sortedDates = Object.keys(salesByDate).sort();

            const tableRows = sortedDates.flatMap(date => {
                const salesOnDate = salesByDate[date];
                const dateRow = `<tr><td colspan="5" style="background-color: #f9f9f9; font-weight: bold; padding: 10px 8px; border-top: 1px solid #eee;">${new Date(date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</td></tr>`;

                const itemRows = salesOnDate.flatMap(sale => {
                    const employee = this.state.employees.find(e => e.transactions.some(t => t.id === sale.id));
                    const totalQuantityInSale = sale.items.reduce((sum, i) => sum + i.quantity, 1);
                    const perItemDiscount = sale.discount > 0 && sale.items.length > 0 ? sale.discount / totalQuantityInSale : 0;
                    return (sale.items || []).map(item => `
                        <tr style="page-break-inside: avoid;">
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">
                                ${item.name}<br>
                                <small style="color: #666;">Sold by: ${employee?.name || 'N/A'} | Type: ${sale.saleType}</small>
                            </td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">${item.quantity}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">${item.price.toFixed(2)}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">${(perItemDiscount * item.quantity).toFixed(2)}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: 500;">${(item.price * item.quantity - perItemDiscount * item.quantity).toFixed(2)}</td>
                        </tr>`
                    );
                }).join('');
                return [dateRow, itemRows];
            }).join('');

            const subTotal = sales.reduce((sum, sale) => sum + sale.items.reduce((s, i) => s + (i.price * i.quantity), 0), 0);
            const totalDiscount = sales.reduce((sum, sale) => sum + (sale.discount || 0), 0);

            return `
            <div style="background-color: #ffffff; color: #111827; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji'; font-size: 14px; line-height: 1.5; margin: auto; max-width: 8.5in; padding: 2rem; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);">
                
                <div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #111827; padding-bottom: 1rem; margin-bottom: 2rem;">
                    <div>
                        <h1 style="font-size: 2.25rem; font-weight: 700; margin: 0; color: #111827; line-height: 1;">LEDGERLY</h1>
                        <p style="margin: 0.25rem 0 0; color: #6b7280;">Sales Division</p>
                    </div>
                    <div style="text-align: right;">
                        <h2 style="font-size: 1.875rem; font-weight: 600; margin: 0;">INVOICE</h2>
                        <p style="margin: 0.25rem 0 0; color: #6b7280;">#${invoiceId}</p>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
                    <div>
                        <p style="margin: 0; color: #6b7280; font-weight: 500;">BILL TO</p>
                        <p style="margin: 0.25rem 0 0; font-weight: 600; font-size: 1.125rem;">${store.name}</p>
                        <p style="margin: 0.25rem 0 0; color: #6b7280;">${store.location}</p>
                    </div>
                    <div style="text-align: right;">
                        <p style="margin: 0; color: #6b7280;"><span style="font-weight: 500;">Invoice Date:</span> ${invoiceDate.toLocaleDateString()}</p>
                        <p style="margin: 0.25rem 0 0; color: #6b7280;"><span style="font-weight: 500;">Due Date:</span> On Receipt</p>
                    </div>
                </div>

                <table style="width: 100%; border-collapse: collapse;">
                    <thead style="background-color: #f3f4f6; color: #374151;">
                        <tr>
                            <th style="padding: 12px 8px; text-align: left; font-weight: 600; width: 50%;">ITEM DESCRIPTION</th>
                            <th style="padding: 12px 8px; text-align: right; font-weight: 600;">QTY</th>
                            <th style="padding: 12px 8px; text-align: right; font-weight: 600;">RATE (AED)</th>
                            <th style="padding: 12px 8px; text-align: right; font-weight: 600;">DISCOUNT (AED)</th>
                            <th style="padding: 12px 8px; text-align: right; font-weight: 600;">AMOUNT (AED)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>

                <div style="display: flex; justify-content: flex-end; margin-top: 2rem;">
                    <div style="width: 100%; max-width: 300px;">
                        <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                            <span>Subtotal</span>
                            <span>${subTotal.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; color: #ef4444;">
                            <span>Discount</span>
                            <span>(${totalDiscount.toFixed(2)})</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-top: 2px solid #111827; border-bottom: 2px solid #111827; margin-top: 8px; font-weight: 700; font-size: 1.25rem;">
                            <span>Total Due</span>
                            <span>AED ${total.toFixed(2)}</span>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 3rem; text-align: center; color: #6b7280; font-size: 0.875rem;">
                    <p>Thank you for your business!</p>
                    <p>All transactions are final. Please contact us for any inquiries.</p>
                </div>
            </div>
                `;
        },

        switchAITab(tabName) {
            document.querySelectorAll('.ai-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`ai-${tabName}-tab`).classList.remove('hidden');
            document.querySelectorAll('.ai-tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
        },

        async getAIResponse(prompt, isChatMessage = false) {
            const contextId = document.getElementById('ai-employee-select').value;
            let contextData = '';
            let subject = 'the entire company';

            if (contextId === 'company') {
                contextData = JSON.stringify({
                    employees: this.state.employees,
                    masterInventory: this.state.masterInventory,
                    tasks: this.state.tasks
                }, null, 2);
            } else {
                const employee = this.getEmployee(contextId);
                if (employee) {
                    subject = employee.name;
                    contextData = JSON.stringify(employee, null, 2);
                }
            }

            const outputArea = isChatMessage ? document.getElementById('ai-chat-history') : document.getElementById('ai-response-area');
            const thinkingHTML = `<div class="text-light-text-secondary dark:text-dark-text-secondary"><i>Accura AI is thinking... <i class="fas fa-spinner fa-spin ml-1"></i></i></div>`;
            const userMessageHTML = `<div class="text-right"><div class="inline-block bg-primary text-black p-2 rounded-lg">${prompt}</div></div>`;

            if (isChatMessage) {
                outputArea.innerHTML += userMessageHTML + thinkingHTML;
                outputArea.scrollTop = outputArea.scrollHeight; // Scroll to bottom
            } else {
                outputArea.innerHTML = thinkingHTML;
            }

            const aiResponse = await this.mockAIApi(prompt, subject); 

            const aiResponseHTML = `<div class="prose max-w-none text-light-text dark:text-dark-text">${this.simpleMarkdownToHtml(aiResponse)}</div>`;
            
            if (isChatMessage) {
                outputArea.lastChild.remove(); // Remove thinking indicator
                outputArea.innerHTML += `<div><div class="inline-block bg-light-bg dark:bg-dark-bg p-3 rounded-lg">${aiResponseHTML}</div></div>`;
                outputArea.scrollTop = outputArea.scrollHeight;
            } else {
                outputArea.innerHTML = aiResponseHTML;
            }
        },

        async mockAIApi(prompt, subject) {
            await new Promise(res => setTimeout(res, 1500)); // Simulate network delay
            prompt = prompt.toLowerCase();
            if (prompt.includes('action plan')) {
                return `### Action Plan for ${subject}\n\n1. **Identify Top Customers:** Review sales data to find the top 3 stores by revenue.\n2. **Promote High-Margin Products:** Focus sales efforts on products with the best profit margins.\n3. **Follow-up on Outstanding Credit:** Contact stores with significant outstanding credit to ensure timely payments.`;
            } else if (prompt.includes('top product')) {
                return `### Top Product Analysis for ${subject}\n\nBased on the data, the top-selling product is **"Master Widget"**. It is likely successful due to its competitive price point and high demand in the current market. Consider increasing its stock.`;
            } else if (prompt.includes('cost') || prompt.includes('expense')) {
                return `### Expense Analysis for ${subject}\n\nThe largest expense category is **"Supplies"**. To reduce costs, consider:\n- Ordering supplies in bulk for a discount.\n- Researching alternative suppliers for better pricing.`;
            } else if (prompt.includes('credit')) {
                 return `### Store Credit Analysis\n\n**"MegaMart"** has the highest outstanding credit at **AED 4,500**. Their credit limit is AED 5,000. It would be wise to follow up on payment before extending further credit.`;
            } else {
                return `I can help with that. To give you the best advice about "${prompt}" for ${subject}, I need to analyze the sales transactions, inventory levels, and expense reports. Please ensure all data is up to date.`;
            }
        },

        simpleMarkdownToHtml(md){return md.replace(/^### (.*$)/gim,'<h3 class="font-bold text-lg mb-2">$1</h3>').replace(/^## (.*$)/gim,'<h2 class="font-bold text-xl mb-3">$1</h2>').replace(/^# (.*$)/gim,'<h1 class="font-bold text-2xl mb-4">$1</h1>').replace(/\*\*(.*)\*\*/gim,'<strong>$1</strong>').replace(/\*(.*)\*/gim,'<em>$1</em>').replace(/\n\s*-\s/g,'<br>- ').replace(/\n/g,'<br>')}
    };

    window.app = app;

    const styleSheet = document.createElement("style");
    styleSheet.innerText = `.modal-input { width: 100%; background-color: ${tailwind.config.theme.extend.colors['light-bg']}; border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem 0.75rem; } .dark .modal-input { background-color: ${tailwind.config.theme.extend.colors['dark-bg']}; border-color: #4b5563; } .modal-submit-button { width: 100%; background-color: ${tailwind.config.theme.extend.colors.primary}; color: black; font-weight: bold; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s; } .modal-submit-button:hover { background-color: ${tailwind.config.theme.extend.colors['primary-hover']}; } .form-label { display: block; font-size: 0.875rem; font-weight: 500; color: ${tailwind.config.theme.extend.colors['light-text-secondary']}; } .dark .form-label { color: ${tailwind.config.theme.extend.colors['dark-text-secondary']}; } .form-input { margin-top: 0.25rem; display: block; width: 100%; background-color: ${tailwind.config.theme.extend.colors['light-bg']}; border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem 0.75rem; outline: none; } .dark .form-input { background-color: ${tailwind.config.theme.extend.colors['dark-bg']}; border-color: #4b5563; } .form-input:focus { ring: 2px; border-color: ${tailwind.config.theme.extend.colors.primary}; box-shadow: 0 0 0 2px ${tailwind.config.theme.extend.colors.primary}; } .table-header { padding: 0.75rem 1.5rem; text-align: left; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: ${tailwind.config.theme.extend.colors['light-text-secondary']}; } .dark .table-header { color: ${tailwind.config.theme.extend.colors['dark-text-secondary']}; }`;
    document.head.appendChild(styleSheet);

    app.init();
});
</script>

</body>
</html>
