<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ledgerly - Business Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Gemini-Inspired Color Palette
                        'light-bg': '#f0f4f9',
                        'light-surface': '#ffffff',
                        'light-text': '#1f2937',
                        'light-text-secondary': '#6b7280',
                        'dark-bg': '#131314',
                        'dark-surface': '#1e1f20',
                        'dark-text': '#e3e3e3',
                        'dark-text-secondary': '#8f9397',
                        'primary': '#89b4fa',
                        'primary-hover': '#7287fd',
                        'accent-green': '#a6e3a1',
                        'accent-red': '#f38ba8',
                    },
                    keyframes: {
                        'fade-in-out': {
                            '0%': { opacity: '0', transform: 'translateY(-20px)' },
                            '10%': { opacity: '1', transform: 'translateY(0)' },
                            '90%': { opacity: '1', transform: 'translateY(0)' },
                            '100%': { opacity: '0', transform: 'translateY(-20px)' },
                        },
                        'color-pulse': {
                            '0%, 100%': { color: '#89b4fa' }, /* primary */
                            '25%': { color: '#a6e3a1' }, /* accent-green */
                            '50%': { color: '#f5c2e7' }, /* A pinkish color */
                            '75%': { color: '#94e2d5' }, /* A teal color */
                        }
                    },
                    animation: {
                        'fade-in-out': 'fade-in-out 4s ease-in-out forwards',
                        'color-pulse': 'color-pulse 10s ease-in-out infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f0f4f9; color: #1f2937; }
        .dark body { background-color: #131314; color: #e3e3e3; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); }
        .tab-button.active { border-color: #89b4fa; color: #89b4fa; }
        .task-completed { text-decoration: line-through; color: #a3a3a3; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f0f4f9; }
        .dark ::-webkit-scrollbar-track { background: #1e1f20; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
    </style>
</head>
<body class="antialiased font-sans">

    <div id="notification" class="fixed top-5 right-5 z-[100] text-black py-2 px-4 rounded-md shadow-lg opacity-0">
        <span id="notification-message"></span>
    </div>

    <div id="app" class="h-screen flex flex-col">
        <header id="main-header" class="bg-light-surface dark:bg-dark-surface p-4 flex justify-between items-center z-20 flex-shrink-0 border-b border-gray-200 dark:border-gray-700 hidden">
            <div class="flex items-center space-x-4">
                <i class="fas fa-book-open text-primary text-2xl"></i>
                <h1 id="app-title" class="text-2xl font-bold text-light-text dark:text-dark-text animate-color-pulse">Ledgerly</h1>
                <button id="theme-toggle" class="text-light-text-secondary dark:text-dark-text-secondary text-xl px-2 py-1 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i id="theme-icon" class="fas"></i>
                </button>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-light-text-secondary dark:text-dark-text-secondary hidden md:inline">Current Employee:</span>
                <select id="employee-switcher" class="bg-light-bg dark:bg-dark-bg text-light-text dark:text-dark-text border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-primary focus:outline-none"></select>
            </div>
        </header>

        <main id="main-content" class="flex-grow flex flex-col md:flex-row overflow-hidden hidden">
            <div class="w-full md:w-1/3 lg:w-1/4 bg-light-surface dark:bg-dark-surface p-4 overflow-y-auto flex-shrink-0 border-r border-gray-200 dark:border-gray-700">
                <div id="company-overview-panel" class="mb-6">
                    <h2 class="text-xl font-semibold mb-3 text-light-text dark:text-dark-text flex items-center justify-between cursor-pointer" onclick="app.togglePanel('company-overview')">
                        <span><i class="fas fa-building mr-2 text-primary"></i>Company Overview</span>
                        <i id="company-overview-toggle-icon" class="fas fa-chevron-down"></i>
                    </h2>
                    <div id="company-overview-content" class="space-y-4 hidden">
                        <div id="company-stats" class="space-y-2 p-3 bg-light-bg dark:bg-dark-bg rounded-lg"></div>

                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-light-text-secondary dark:text-dark-text-secondary">Employees</h3>
                                <button class="bg-primary text-black px-3 py-1 rounded-md text-sm font-semibold hover:bg-primary-hover" onclick="app.openModal('addEmployeeModal')">+ Add</button>
                            </div>
                            <ul id="employee-list" class="space-y-2 text-sm"></ul>
                        </div>
                        
                        <div id="inactive-employee-section" class="hidden">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-light-text-secondary dark:text-dark-text-secondary">Inactive Employees</h3>
                            </div>
                            <ul id="inactive-employee-list" class="space-y-2 text-sm"></ul>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-light-text-secondary dark:text-dark-text-secondary">Master Inventory</h3>
                                <div>
                                    <button class="bg-primary text-black px-3 py-1 rounded-md text-sm font-semibold hover:bg-primary-hover mr-2" onclick="app.openModal('addProductModal')">+ Add</button>
                                    <button class="bg-accent-green text-black px-3 py-1 rounded-md text-sm font-semibold hover:opacity-80" onclick="app.openModal('delegateStockModal')">Delegate</button>
                                </div>
                            </div>
                            <div id="master-inventory-list" class="space-y-1 text-sm"></div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-light-text-secondary dark:text-dark-text-secondary">All Tasks</h3>
                                <button class="bg-primary text-black px-3 py-1 rounded-md text-sm font-semibold hover:bg-primary-hover" onclick="app.openModal('createTaskModal')">+ Create</button>
                            </div>
                            <ul id="all-tasks-list" class="space-y-2 text-sm"></ul>
                        </div>
                    </div>
                </div>

                <div id="ai-advisor-panel">
                    <h2 class="text-xl font-semibold mb-3 text-light-text dark:text-dark-text flex items-center justify-between cursor-pointer" onclick="app.togglePanel('ai-advisor')">
                        <span><i class="fas fa-brain mr-2 text-primary"></i>Accura AI Advisor</span>
                        <i id="ai-advisor-toggle-icon" class="fas fa-chevron-down"></i>
                    </h2>
                    <div id="ai-advisor-content" class="space-y-4 hidden">
                        <div>
                            <label for="ai-employee-select" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary mb-1">Select Employee to Analyze</label>
                            <select id="ai-employee-select" class="w-full bg-light-bg dark:bg-dark-bg text-light-text dark:text-dark-text border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-primary focus:outline-none"></select>
                        </div>
                        <button id="generate-plan-btn" class="w-full bg-primary text-black py-2 rounded-md font-semibold hover:bg-primary-hover flex items-center justify-center" onclick="app.generateAIPlan()">
                            <span id="generate-plan-text">Generate Plan</span>
                            <i id="generate-plan-loader" class="fas fa-spinner fa-spin hidden ml-2"></i>
                        </button>
                        <div id="ai-plan-output" class="mt-4 p-3 bg-light-bg dark:bg-dark-bg rounded-md text-sm prose max-w-none max-h-60 overflow-y-auto">
                            <p class="text-light-text-secondary dark:text-dark-text-secondary">Your generated profit improvement plan will appear here.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="employee-view" class="flex-grow p-2 md:p-6 overflow-y-auto">
                </div>
        </main>
    </div>

    <div id="modal-container">
        </div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {

    const app = {
        // --- STATE & CONFIG ---
        state: {
            theme: 'dark',
            currentEmployeeId: null,
            employees: [],
            stores: [],
            masterInventory: [],
            tasks: [],
        },
        charts: {}, // To hold chart instances
        pdfShiftApiKey: 'Sk_4e4b1acfcab0c0454d642ef6701891a8d318d648',

        // --- INITIALIZATION ---
        init() {
            this.loadState();
            this.applyTheme();
            this.renderModals();
            this.addEventListeners();
            this.render();
        },
        
        showFirstTimeSetup() {
            document.getElementById('firstTimeModal').classList.remove('hidden');
        },
        
        showMainApp() {
            document.getElementById('firstTimeModal').classList.add('hidden');
            document.getElementById('main-header').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('main-content').classList.add('flex');
        },

        // --- STATE MANAGEMENT ---
        saveState() {
            localStorage.setItem('ledgerlyState', JSON.stringify(this.state));
        },

        loadState() {
            const savedState = localStorage.getItem('ledgerlyState');
            if (savedState) {
                this.state = Object.assign({}, this.state, JSON.parse(savedState));
                // Backwards compatibility for old data
                this.state.stores.forEach(store => { 
                    if (store.creditLimit === undefined) store.creditLimit = store.credit || 0;
                    if (store.creditAvailable === undefined) store.creditAvailable = store.credit || 0;
                    if (store.creditUsed === undefined) store.creditUsed = 0;
                });
                this.state.employees.forEach(emp => { if (emp.isActive === undefined) emp.isActive = true; });
                this.state.masterInventory.forEach(prod => { if (prod.isActive === undefined) prod.isActive = true; });
            }
        },
        
        // --- DATA HELPERS ---
        getEmployee(employeeId) {
            return this.state.employees.find(e => e.id === employeeId);
        },
        getActiveEmployees() {
            return this.state.employees.filter(e => e.isActive);
        },
        getProduct(productId) {
            return this.state.masterInventory.find(p => p.id === productId);
        },
        getActiveProducts() {
            return this.state.masterInventory.filter(p => p.isActive);
        },
        getStore(storeId) {
            return this.state.stores.find(s => s.id === storeId);
        },
        
        // --- EVENT LISTENERS & HANDLERS ---
        addEventListeners() {
            document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());
            document.getElementById('first-employee-form').addEventListener('submit', e => this.handleFirstEmployee(e));
            document.getElementById('employee-switcher').addEventListener('change', e => this.handleEmployeeSwitch(e));
            
            document.getElementById('add-employee-form').addEventListener('submit', e => this.handleAddEmployee(e));
            document.getElementById('edit-employee-form').addEventListener('submit', e => this.handleUpdateEmployee(e));
            document.getElementById('add-product-form').addEventListener('submit', e => this.handleAddProduct(e));
            document.getElementById('delegate-stock-form').addEventListener('submit', e => this.handleDelegateStock(e));
            document.getElementById('create-task-form').addEventListener('submit', e => this.handleCreateTask(e));
        },

        handleFirstEmployee(e) {
            e.preventDefault();
            const name = document.getElementById('first-employee-name').value;
            const position = document.getElementById('first-employee-position').value;
            if (!name || !position) return;
            const newEmployee = this.createEmployee(name, position);
            this.state.employees.push(newEmployee);
            this.state.currentEmployeeId = newEmployee.id;
            this.saveState();
            this.render();
            this.showNotification(`Welcome, ${name}! Your profile is ready.`, 'success');
        },
        handleEmployeeSwitch(e) {
            this.state.currentEmployeeId = e.target.value;
            this.saveState();
            this.render();
        },
        handleTabClick(e) {
            const button = e.target.closest('.tab-button');
            if (button) this.setActiveTab(button.dataset.tab);
        },
        attachEmployeeViewEventListeners() {
            document.getElementById('tabs-container')?.addEventListener('click', e => this.handleTabClick(e));
            
            const saleForm = document.getElementById('record-sale-form');
            if (saleForm) {
                saleForm.addEventListener('submit', e => this.handleRecordSale(e));
                saleForm.querySelector('#sale-type').addEventListener('change', () => this.handleSaleTypeChange());
                saleForm.querySelector('#sale-product').addEventListener('change', () => this.updateFinalSaleAmount());
                saleForm.querySelector('#sale-quantity').addEventListener('input', () => this.updateFinalSaleAmount());
                saleForm.querySelector('#sale-discount').addEventListener('input', () => this.updateFinalSaleAmount());
            }

            const expenseForm = document.getElementById('record-expense-form');
            if(expenseForm) expenseForm.addEventListener('submit', e => this.handleRecordExpense(e));

            const storeForm = document.getElementById('employee-add-store-form');
            if(storeForm) storeForm.addEventListener('submit', e => this.handleAddStore(e));

            const editStoreForm = document.getElementById('edit-store-form');
            if(editStoreForm) editStoreForm.addEventListener('submit', e => this.handleUpdateStore(e));

            const invoiceForm = document.getElementById('invoice-form');
            if(invoiceForm) invoiceForm.addEventListener('submit', e => this.handleGenerateInvoice(e));
        },

        // --- UI RENDERING ---
        render() {
            if (this.state.employees.length === 0) {
                 this.showFirstTimeSetup();
                 return;
            }
            
            this.showMainApp();

            if (!this.state.currentEmployeeId || !this.getEmployee(this.state.currentEmployeeId)?.isActive) {
                const firstActiveEmployee = this.getActiveEmployees()[0];
                this.state.currentEmployeeId = firstActiveEmployee ? firstActiveEmployee.id : null;
            }

            this.renderEmployeeSwitcher();
            this.renderCompanyOverview();
            this.renderAIAdvisorPanel();
            
            const employeeView = document.getElementById('employee-view');
            if (this.getActiveEmployees().length === 0) {
                employeeView.innerHTML = `<div class="p-8 text-center w-full h-full flex flex-col justify-center items-center">
                    <h2 class="text-2xl font-bold mb-4">All Employees Inactive</h2>
                    <p class="text-light-text-secondary dark:text-dark-text-secondary">Please reactivate an employee from the Company Overview panel to continue.</p>
                </div>`;
            } else {
                employeeView.innerHTML = this.getEmployeeViewTemplate();
                this.attachEmployeeViewEventListeners();
                this.renderTabs();
                this.setActiveTab(document.querySelector('.tab-button.active')?.dataset.tab || 'dashboard');
            }
        },

        getEmployeeViewTemplate() {
            return `
                <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
                    <nav class="flex flex-wrap -mb-px" id="tabs-container"></nav>
                </div>
                <div id="tab-content-container">
                    <div id="dashboard-content" class="tab-content">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="lg:col-span-2 bg-light-surface dark:bg-dark-surface p-4 rounded-lg shadow-lg"><div class="relative h-96"><canvas id="sales-over-time-chart"></canvas></div></div>
                            <div class="bg-light-surface dark:bg-dark-surface p-4 rounded-lg shadow-lg"><div class="relative h-80"><canvas id="top-products-chart"></canvas></div></div>
                            <div class="bg-light-surface dark:bg-dark-surface p-4 rounded-lg shadow-lg"><div class="relative h-80"><canvas id="revenue-expense-chart"></canvas></div></div>
                        </div>
                    </div>
                    <div id="my-tasks-content" class="tab-content hidden"><h2 class="text-2xl font-bold mb-4">My Assigned Tasks</h2><ul id="employee-tasks-list" class="space-y-3"></ul></div>
                    <div id="my-inventory-content" class="tab-content hidden"><h2 class="text-2xl font-bold mb-4">My Delegated Inventory</h2><div class="bg-light-surface dark:bg-dark-surface rounded-lg shadow overflow-hidden"><table class="min-w-full"><thead class="bg-light-bg dark:bg-dark-bg"><tr><th class="px-6 py-3 text-left text-xs font-medium text-light-text-secondary dark:text-dark-text-secondary uppercase tracking-wider">Product Name</th><th class="px-6 py-3 text-left text-xs font-medium text-light-text-secondary dark:text-dark-text-secondary uppercase tracking-wider">Stock</th></tr></thead><tbody id="employee-inventory-list" class="divide-y border-gray-200 dark:border-gray-700"></tbody></table></div></div>
                    <div id="sales-expenses-content" class="tab-content hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-light-surface dark:bg-dark-surface p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-bold mb-4">Record a Sale</h2>
                            <form id="record-sale-form" class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="sale-store" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Store</label><select id="sale-store" name="storeId" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-primary"></select></div>
                                    <div><label for="sale-type" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Sale Type</label><select id="sale-type" name="saleType" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-primary"></select></div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="sale-product" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Product</label><select id="sale-product" name="productId" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-primary"></select></div>
                                    <div><label for="sale-quantity" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Quantity</label><input type="number" id="sale-quantity" name="quantity" value="1" min="1" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-primary"></div>
                                </div>
                                <div id="deal-specific-fields" class="hidden"><label for="sale-discount" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Discount ($)</label><input type="number" id="sale-discount" name="discount" step="0.01" min="0" class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-primary"></div>
                                <div id="credit-specific-fields" class="hidden">
                                     <label for="sale-due-date" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Payment Due Date</label>
                                     <input type="date" id="sale-due-date" class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                <div class="p-3 bg-light-bg dark:bg-dark-bg rounded-md space-y-2">
                                    <div class="flex justify-between text-sm"><span class="text-light-text-secondary dark:text-dark-text-secondary">Total Price:</span><span id="sale-total-price" class="font-medium text-light-text dark:text-dark-text">$0.00</span></div>
                                    <div><label for="sale-amount" class="block text-sm font-bold text-light-text-secondary dark:text-dark-text-secondary">Final Amount ($)</label><input type="number" id="sale-amount" name="amount" step="0.01" required readonly class="mt-1 block w-full bg-gray-200 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text font-bold focus:outline-none"></div>
                                </div>
                                <button type="submit" class="w-full bg-primary text-black py-2 rounded-md font-semibold hover:bg-primary-hover">Record Sale</button>
                            </form>
                        </div>
                        <div class="bg-light-surface dark:bg-dark-surface p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-bold mb-4">Record an Expense</h2>
                            <form id="record-expense-form" class="space-y-4">
                                <div><label for="expense-description" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Description</label><input type="text" id="expense-description" name="description" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-primary focus:border-primary"></div>
                                <div><label for="expense-amount" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Amount ($)</label><input type="number" id="expense-amount" name="amount" step="0.01" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-primary focus:border-primary"></div>
                                <button type="submit" class="w-full bg-accent-red text-black py-2 rounded-md font-semibold hover:opacity-80">Record Expense</button>
                            </form>
                        </div>
                    </div>
                    <div id="stores-content" class="tab-content hidden"><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-light-surface dark:bg-dark-surface p-6 rounded-lg shadow-lg"><h2 class="text-2xl font-bold mb-4">Add a New Store</h2><form id="employee-add-store-form" class="space-y-4"><div><label for="employee-new-store-name" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Store Name / Location</label><input type="text" id="employee-new-store-name" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-primary focus:border-primary"></div><div><label for="employee-new-store-credit-limit" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Credit Limit ($)</label><input type="number" id="employee-new-store-credit-limit" step="0.01" min="0" class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-primary focus:border-primary"></div><button type="submit" class="w-full bg-primary text-black py-2 rounded-md font-semibold hover:bg-primary-hover">Add Store</button></form></div><div class="bg-light-surface dark:bg-dark-surface p-6 rounded-lg shadow-lg"><h2 class="text-2xl font-bold mb-4">All Stores</h2><div id="employee-view-store-list" class="space-y-3 max-h-96 overflow-y-auto"></div></div></div></div>
                    <div id="invoices-content" class="tab-content hidden"><h2 class="text-2xl font-bold mb-4">Generate Sales Receipt</h2><div class="bg-light-surface dark:bg-dark-surface p-6 rounded-lg shadow-lg"><form id="invoice-form" class="grid grid-cols-1 gap-6"><div><h3 class="text-lg font-semibold mb-3">Select Uninvoiced Sales</h3><div id="uninvoiced-sales-list" class="space-y-2 max-h-60 overflow-y-auto p-2 bg-light-bg dark:bg-dark-bg rounded-md border border-gray-300 dark:border-gray-600"><p class="text-light-text-secondary dark:text-dark-text-secondary">No uninvoiced sales found.</p></div></div><div><button id="generate-pdf-btn" type="submit" class="w-full bg-primary text-black py-2 rounded-md font-semibold hover:bg-primary-hover flex items-center justify-center"><span id="generate-pdf-text">Generate & Download PDF Receipt</span><i id="generate-pdf-loader" class="fas fa-spinner fa-spin hidden ml-2"></i></button></div></form></div></div>
                    <div id="ledger-content" class="tab-content hidden"><h2 class="text-2xl font-bold mb-4">Transaction Ledger</h2><div class="bg-light-surface dark:bg-dark-surface rounded-lg shadow overflow-hidden"><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-light-bg dark:bg-dark-bg"><tr><th class="px-6 py-3 text-left text-xs font-medium text-light-text-secondary dark:text-dark-text-secondary uppercase tracking-wider">Date</th><th class="px-6 py-3 text-left text-xs font-medium text-light-text-secondary dark:text-dark-text-secondary uppercase tracking-wider">Type</th><th class="px-6 py-3 text-left text-xs font-medium text-light-text-secondary dark:text-dark-text-secondary uppercase tracking-wider">Description</th><th class="px-6 py-3 text-left text-xs font-medium text-light-text-secondary dark:text-dark-text-secondary uppercase tracking-wider">Amount</th></tr></thead><tbody id="ledger-list" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody></table></div></div></div>
                </div>`;
        },

        renderEmployeeSwitcher() {
            const switcher = document.getElementById('employee-switcher');
            const activeEmployees = this.getActiveEmployees();
            switcher.innerHTML = activeEmployees.length > 0
                ? activeEmployees.map(emp => `<option value="${emp.id}" ${emp.id === this.state.currentEmployeeId ? 'selected' : ''}>${emp.name}</option>`).join('')
                : `<option>No active employees</option>`;
            switcher.disabled = activeEmployees.length === 0;
        },
        
        renderCompanyOverview() {
            let totalRevenue = 0, totalExpenses = 0;
            const employeeContributions = this.state.employees.map(emp => {
                const revenue = emp.transactions.filter(t => t.type === 'sale').reduce((sum, t) => sum + t.amount, 0);
                const expenses = emp.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                if (emp.isActive) {
                    totalRevenue += revenue;
                    totalExpenses += expenses;
                }
                return { ...emp, revenue, expenses, profit: revenue - expenses };
            });
            const totalProfit = totalRevenue - totalExpenses;

            document.getElementById('company-stats').innerHTML = `
                <h3 class="font-bold text-light-text-secondary dark:text-dark-text-secondary text-base">Firm-Wide Totals (Active)</h3>
                <div class="text-sm space-y-1">
                    <div class="flex justify-between"><span>Revenue:</span> <span class="font-semibold text-accent-green">$${totalRevenue.toFixed(2)}</span></div>
                    <div class="flex justify-between"><span>Expenses:</span> <span class="font-semibold text-accent-red">$${totalExpenses.toFixed(2)}</span></div>
                    <div class="flex justify-between"><span>Net Profit:</span> <span class="font-bold ${totalProfit < 0 ? 'text-accent-red' : 'text-light-text dark:text-dark-text'}">$${totalProfit.toFixed(2)}</span></div>
                </div>`;

            document.getElementById('employee-list').innerHTML = employeeContributions.filter(e => e.isActive).map(emp => `
                <li class="bg-light-bg dark:bg-dark-bg p-2 rounded">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-light-text dark:text-dark-text font-bold">${emp.name}</span>
                            <em class="text-light-text-secondary dark:text-dark-text-secondary text-xs ml-1">(${emp.position})</em>
                        </div>
                        <div class="flex space-x-3">
                            <button class="text-sm text-light-text-secondary hover:text-primary dark:text-dark-text-secondary dark:hover:text-primary" onclick="app.startEditEmployee('${emp.id}')"><i class="fas fa-pencil-alt"></i></button>
                            <button class="text-sm text-light-text-secondary hover:text-accent-red dark:text-dark-text-secondary dark:hover:text-accent-red" onclick="app.deactivateEmployee('${emp.id}')"><i class="fas fa-user-slash"></i></button>
                        </div>
                    </div>
                    <div class="text-xs mt-2 space-y-1 pl-1 border-l-2 border-gray-200 dark:border-gray-600 ml-1 pl-2">
                        <div class="flex justify-between"><span>Revenue:</span> <span class="font-semibold text-accent-green">$${emp.revenue.toFixed(2)}</span></div>
                        <div class="flex justify-between"><span>Expenses:</span> <span class="font-semibold text-accent-red">$${emp.expenses.toFixed(2)}</span></div>
                    </div>
                </li>`
            ).join('') || `<p class="text-light-text-secondary dark:text-dark-text-secondary text-sm">No active employees yet.</p>`;

            const inactiveEmployees = this.state.employees.filter(e => !e.isActive);
            const inactiveSection = document.getElementById('inactive-employee-section');
            const inactiveList = document.getElementById('inactive-employee-list');
            if (inactiveEmployees.length > 0) {
                inactiveSection.classList.remove('hidden');
                inactiveList.innerHTML = inactiveEmployees.map(emp => `
                    <li class="flex justify-between items-center bg-light-bg dark:bg-dark-bg p-2 rounded opacity-60">
                        <span class="text-light-text dark:text-dark-text italic">${emp.name}</span>
                        <button class="text-sm text-accent-green hover:opacity-80 font-semibold" onclick="app.reactivateEmployee('${emp.id}')">Reactivate</button>
                    </li>
                `).join('');
            } else {
                inactiveSection.classList.add('hidden');
            }

            const inventoryList = document.getElementById('master-inventory-list');
            inventoryList.innerHTML = this.state.masterInventory.map(prod => `
                <div class="flex justify-between items-center bg-light-bg dark:bg-dark-bg p-2 rounded">
                    <span class="text-light-text dark:text-dark-text">${prod.name}</span>
                    <span class="font-mono text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded">${prod.stock}</span>
                </div>`
            ).join('') || `<p class="text-light-text-secondary dark:text-dark-text-secondary text-sm">No products in inventory.</p>`;

            const allTasksList = document.getElementById('all-tasks-list');
            allTasksList.innerHTML = this.state.tasks.map(task => {
                const assignee = this.getEmployee(task.assigneeId);
                return `<li class="bg-light-bg dark:bg-dark-bg p-2 rounded text-light-text dark:text-dark-text ${task.status === 'Completed' ? 'task-completed' : ''}">
                    <p>${task.description}</p>
                    <small class="text-light-text-secondary dark:text-dark-text-secondary">Assigned to: ${assignee ? assignee.name : 'Unassigned'}</small>
                </li>`
            }).join('') || `<p class="text-light-text-secondary dark:text-dark-text-secondary text-sm">No tasks created.</p>`;
        },
        
        renderAIAdvisorPanel() {
             document.getElementById('ai-employee-select').innerHTML = this.getActiveEmployees().map(emp => `<option value="${emp.id}">${emp.name}</option>`).join('');
        },

        renderTabs() {
            const tabs = [
                { id: 'dashboard', name: 'Dashboard', icon: 'fa-chart-line' },
                { id: 'my-tasks', name: 'My Tasks', icon: 'fa-tasks' },
                { id: 'my-inventory', name: 'My Inventory', icon: 'fa-boxes' },
                { id: 'sales-expenses', name: 'Sales & Expenses', icon: 'fa-exchange-alt' },
                { id: 'stores', name: 'Manage Stores', icon: 'fa-store' },
                { id: 'invoices', name: 'Invoices', icon: 'fa-file-invoice-dollar' },
                { id: 'ledger', name: 'Ledger', icon: 'fa-history' },
            ];
            document.getElementById('tabs-container').innerHTML = tabs.map(tab => `
                <button data-tab="${tab.id}" class="tab-button text-light-text-secondary dark:text-dark-text-secondary hover:text-light-text dark:hover:text-dark-text border-b-2 border-transparent py-3 px-4 font-medium text-sm">
                    <i class="fas ${tab.icon} mr-2 hidden md:inline"></i>${tab.name}
                </button>
            `).join('');
        },
        
        renderDashboard() {
            const employee = this.getEmployee(this.state.currentEmployeeId);
            if (!employee) return;

            const isDark = this.state.theme === 'dark';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const textColor = isDark ? '#e3e3e3' : '#1f2937';
            
            // --- 1. Sales Over Time Data ---
            const salesByDate = employee.transactions
                .filter(t => t.type === 'sale')
                .reduce((acc, t) => {
                    const date = t.date.split('T')[0];
                    acc[date] = (acc[date] || 0) + t.amount;
                    return acc;
                }, {});
            const sortedDates = Object.keys(salesByDate).sort();
            const salesLabels = sortedDates;
            const salesData = sortedDates.map(date => salesByDate[date]);

            // --- 2. Top Products Data ---
            const salesByProduct = employee.transactions
                .filter(t => t.type === 'sale')
                .reduce((acc, t) => {
                    acc[t.productId] = (acc[t.productId] || 0) + t.amount;
                    return acc;
                }, {});
            const topProducts = Object.entries(salesByProduct)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5);
            const topProductsLabels = topProducts.map(([productId]) => this.getProduct(productId)?.name || 'Unknown');
            const topProductsData = topProducts.map(([, amount]) => amount);
            
            // --- 3. Revenue vs Expense Data ---
            const totalRevenue = salesData.reduce((sum, val) => sum + val, 0);
            const totalExpenses = employee.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

            // Destroy old charts before creating new ones
            Object.values(this.charts).forEach(chart => {
                if (chart instanceof Chart) chart.destroy();
            });

            // Create Sales Chart
            this.charts.sales = new Chart(document.getElementById('sales-over-time-chart').getContext('2d'), {
                type: 'line',
                data: { labels: salesLabels, datasets: [{ label: 'Daily Revenue', data: salesData, borderColor: '#89b4fa', tension: 0.1, fill: false }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } }, x: { grid: { color: gridColor }, ticks: { color: textColor } } }, plugins: { legend: { labels: { color: textColor } } } }
            });

            // Create Top Products Chart
            this.charts.products = new Chart(document.getElementById('top-products-chart').getContext('2d'), {
                type: 'bar',
                data: { labels: topProductsLabels, datasets: [{ label: 'Revenue by Product', data: topProductsData, backgroundColor: ['#89b4fa', '#7287fd', '#a6e3a1', '#f38ba8', '#f5e0dc'] }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } }, y: { grid: { color: gridColor }, ticks: { color: textColor } } }, plugins: { legend: { display: false } } }
            });

            // Create Revenue/Expense Chart
            this.charts.revenue = new Chart(document.getElementById('revenue-expense-chart').getContext('2d'), {
                type: 'doughnut',
                data: { labels: ['Revenue', 'Expenses'], datasets: [{ data: [totalRevenue, totalExpenses], backgroundColor: ['#a6e3a1', '#f38ba8'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: textColor } } } }
            });
        },
        
        renderMyTasks() {
            const employeeTasks = this.state.tasks.filter(t => t.assigneeId === this.state.currentEmployeeId);
            document.getElementById('employee-tasks-list').innerHTML = employeeTasks.map(task => `
                <li class="bg-light-surface dark:bg-dark-surface p-4 rounded-lg shadow flex justify-between items-center ${task.status === 'Completed' ? 'task-completed' : ''}">
                    <span class="text-light-text dark:text-dark-text">${task.description}</span>
                    <button class="text-black px-3 py-1 rounded-md text-sm font-semibold ${task.status === 'Completed' ? 'bg-gray-400' : 'bg-accent-green hover:opacity-80'}" onclick="app.toggleTaskStatus('${task.id}')">
                        ${task.status === 'Completed' ? 'Reopen' : 'Complete'}
                    </button>
                </li>
            `).join('') || `<p class="text-light-text-secondary dark:text-dark-text-secondary">You have no assigned tasks.</p>`;
        },
        
        renderMyInventory() {
            const employee = this.getEmployee(this.state.currentEmployeeId);
            const listEl = document.getElementById('employee-inventory-list');
            if (!employee || !employee.inventory || employee.inventory.length === 0) {
                 listEl.innerHTML = `<tr><td colspan="2" class="px-6 py-4 text-center text-light-text-secondary dark:text-dark-text-secondary">No inventory delegated to you.</td></tr>`;
                 return;
            }
            listEl.innerHTML = employee.inventory.map(item => {
                const product = this.getProduct(item.productId);
                return `
                    <tr class="hover:bg-light-bg dark:hover:bg-dark-bg">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-light-text dark:text-dark-text">${product ? product.name : 'Unknown Product'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-light-text-secondary dark:text-dark-text-secondary">${item.stock}</td>
                    </tr>
                `;
            }).join('');
        },
        
        renderSalesAndExpenses() {
            const employee = this.getEmployee(this.state.currentEmployeeId);
            const saleProductSelect = document.getElementById('sale-product');
            const saleStoreSelect = document.getElementById('sale-store');
            const saleTypeSelect = document.getElementById('sale-type');

            saleTypeSelect.innerHTML = `<option>Cash</option><option>Credit</option><option>Deal</option>`;
            
            if (this.state.stores.length === 0) {
                saleStoreSelect.innerHTML = `<option disabled selected>Add a store first</option>`;
                saleStoreSelect.disabled = true;
            } else {
                saleStoreSelect.innerHTML = this.state.stores.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                saleStoreSelect.disabled = false;
            }

            if (!employee || !employee.inventory || employee.inventory.length === 0) {
                saleProductSelect.innerHTML = `<option disabled selected>No inventory to sell</option>`;
                saleProductSelect.disabled = true;
            } else {
                 saleProductSelect.innerHTML = employee.inventory.filter(item => item.stock > 0).map(item => {
                    const product = this.getProduct(item.productId);
                    return `<option value="${product.id}">${product.name} (Stock: ${item.stock})</option>`;
                 }).join('');
                saleProductSelect.disabled = false;
            }
            document.querySelector('#record-sale-form button').disabled = !(this.state.stores.length > 0 && employee?.inventory?.some(i => i.stock > 0));
            this.updateFinalSaleAmount();
        },
        
        renderStoresTab() {
            const listEl = document.getElementById('employee-view-store-list');
            if (this.state.stores.length === 0) {
                listEl.innerHTML = `<p class="text-light-text-secondary dark:text-dark-text-secondary">No stores have been added yet.</p>`;
                return;
            }
            const sortedStores = [...this.state.stores].sort((a, b) => (b.creditLimit || 0) - (a.creditLimit || 0));
            listEl.innerHTML = sortedStores.map(store => {
                const isOverdue = store.dueDate && new Date(store.dueDate) < new Date();
                return `
                <div class="flex justify-between items-center bg-light-bg dark:bg-dark-bg p-3 rounded">
                    <div>
                        <span class="text-light-text dark:text-dark-text font-medium">${store.name}</span>
                        <div class="text-xs text-light-text-secondary dark:text-dark-text-secondary">Credit Used: <span class="font-semibold text-accent-red">$${(store.creditUsed || 0).toFixed(2)}</span></div>
                        <div class="text-xs text-light-text-secondary dark:text-dark-text-secondary">Available: <span class="font-semibold text-accent-green">$${(store.creditAvailable || 0).toFixed(2)}</span> / $${(store.creditLimit || 0).toFixed(2)}</div>
                        ${store.dueDate ? `<div class="text-xs ${isOverdue ? 'text-accent-red' : 'text-light-text-secondary dark:text-dark-text-secondary'}">Due: ${store.dueDate}</div>` : ''}
                    </div>
                    <div class="flex space-x-3">
                        <button class="text-light-text-secondary hover:text-primary dark:text-dark-text-secondary dark:hover:text-primary" onclick="app.startEditStore('${store.id}')"><i class="fas fa-pencil-alt"></i></button>
                        <button class="text-light-text-secondary hover:text-accent-red dark:text-dark-text-secondary dark:hover:text-accent-red" onclick="app.deleteStore('${store.id}')"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>`
            }).join('');
        },

        renderInvoices() {
            const employee = this.getEmployee(this.state.currentEmployeeId);
            const listEl = document.getElementById('uninvoiced-sales-list');
            if (!employee) return;
            const uninvoicedSales = employee.transactions.filter(t => t.type === 'sale' && !t.invoiced);
            if (uninvoicedSales.length === 0) {
                listEl.innerHTML = `<p class="text-light-text-secondary dark:text-dark-text-secondary p-2">No uninvoiced sales found.</p>`;
                document.getElementById('generate-pdf-btn').disabled = true;
            } else {
                 document.getElementById('generate-pdf-btn').disabled = false;
                 listEl.innerHTML = uninvoicedSales.map(sale => {
                    const product = this.getProduct(sale.productId);
                    return `
                        <label class="flex items-center space-x-3 p-2 bg-light-surface dark:bg-dark-surface rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 cursor-pointer">
                            <input type="checkbox" name="invoice-sale" value="${sale.id}" class="form-checkbox h-5 w-5 text-primary bg-light-bg dark:bg-dark-bg border-gray-300 dark:border-gray-600 rounded focus:ring-primary">
                            <span class="text-sm text-light-text dark:text-dark-text">${new Date(sale.date).toLocaleDateString()}: ${product.name} - $${sale.amount.toFixed(2)}</span>
                        </label>`;
                 }).join('');
            }
        },

        renderLedger() {
            const employee = this.getEmployee(this.state.currentEmployeeId);
            const listEl = document.getElementById('ledger-list');
            if (!employee || employee.transactions.length === 0) {
                listEl.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-light-text-secondary dark:text-dark-text-secondary">No transactions recorded yet.</td></tr>`;
                return;
            }
            const sortedTransactions = [...employee.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            listEl.innerHTML = sortedTransactions.map(t => {
                const isSale = t.type === 'sale';
                let description = '';
                if(isSale) {
                    const product = this.getProduct(t.productId);
                    const store = this.getStore(t.storeId);
                    let discountInfo = t.discount > 0 ? `($${t.discount.toFixed(2)} off)` : '';
                    description = `${t.quantity}x ${product?.name || 'N/A'} at ${store?.name || 'Deleted Store'} (${t.saleType}) ${discountInfo}`;
                } else {
                    description = t.description;
                }
                const amountClass = isSale ? 'text-accent-green' : 'text-accent-red';
                return `
                    <tr class="hover:bg-light-bg dark:hover:bg-dark-bg">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-light-text-secondary dark:text-dark-text-secondary">${new Date(t.date).toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-light-text-secondary dark:text-dark-text-secondary capitalize">${t.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-light-text dark:text-dark-text">${description}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${amountClass}">${isSale ? '+' : '-'}$${t.amount.toFixed(2)}</td>
                    </tr>`;
            }).join('');
        },
        
        renderModals() {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div id="firstTimeModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
                    <div class="bg-light-surface dark:bg-dark-surface rounded-lg shadow-xl p-8 w-full max-w-md">
                        <h2 class="text-2xl font-bold mb-2 text-light-text dark:text-dark-text">Welcome to Ledgerly!</h2>
                        <p class="text-light-text-secondary dark:text-dark-text-secondary mb-6">Let's set up your first employee profile to get started.</p>
                        <form id="first-employee-form">
                            <div class="mb-4">
                                <label for="first-employee-name" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Employee Name</label>
                                <input type="text" id="first-employee-name" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="mb-6">
                                <label for="first-employee-position" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Position / Role</label>
                                <input type="text" id="first-employee-position" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <button type="submit" class="w-full bg-primary text-black font-semibold py-2 rounded-md hover:bg-primary-hover">Create Profile & Start</button>
                        </form>
                    </div>
                </div>

                <div id="addEmployeeModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
                    <div class="bg-light-surface dark:bg-dark-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
                        <button class="absolute top-4 right-4 text-light-text-secondary dark:text-dark-text-secondary hover:text-light-text dark:hover:text-dark-text" onclick="app.closeModal('addEmployeeModal')"><i class="fas fa-times"></i></button>
                        <h2 class="text-2xl font-bold mb-6 text-light-text dark:text-dark-text">Add New Employee</h2>
                        <form id="add-employee-form">
                             <div class="mb-4">
                                <label for="new-employee-name" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Employee Name</label>
                                <input type="text" id="new-employee-name" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="mb-6">
                                <label for="new-employee-position" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Position / Role</label>
                                <input type="text" id="new-employee-position" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <button type="submit" class="w-full bg-primary text-black font-semibold py-2 rounded-md hover:bg-primary-hover">Add Employee</button>
                        </form>
                    </div>
                </div>
                
                <div id="editEmployeeModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
                    <div class="bg-light-surface dark:bg-dark-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
                        <button class="absolute top-4 right-4 text-light-text-secondary dark:text-dark-text-secondary hover:text-light-text dark:hover:text-dark-text" onclick="app.closeModal('editEmployeeModal')"><i class="fas fa-times"></i></button>
                        <h2 class="text-2xl font-bold mb-6 text-light-text dark:text-dark-text">Edit Employee</h2>
                        <form id="edit-employee-form" class="space-y-4">
                            <input type="hidden" id="edit-employee-id">
                             <div class="mb-4">
                                <label for="edit-employee-name" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Employee Name</label>
                                <input type="text" id="edit-employee-name" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="mb-6">
                                <label for="edit-employee-position" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Position / Role</label>
                                <input type="text" id="edit-employee-position" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <button type="submit" class="w-full bg-primary text-black font-semibold py-2 rounded-md hover:bg-primary-hover">Save Changes</button>
                        </form>
                    </div>
                </div>

                <div id="editStoreModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
                    <div class="bg-light-surface dark:bg-dark-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
                        <button class="absolute top-4 right-4 text-light-text-secondary dark:text-dark-text-secondary hover:text-light-text dark:hover:text-dark-text" onclick="app.closeModal('editStoreModal')"><i class="fas fa-times"></i></button>
                        <h2 class="text-2xl font-bold mb-6 text-light-text dark:text-dark-text">Edit Store</h2>
                        <form id="edit-store-form" class="space-y-4">
                            <input type="hidden" id="edit-store-id">
                            <div>
                                <label for="edit-store-name" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Store Name / Location</label>
                                <input type="text" id="edit-store-name" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label for="edit-store-credit-limit" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Credit Limit ($)</label>
                                <input type="number" id="edit-store-credit-limit" step="0.01" min="0" class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <button type="submit" class="w-full bg-primary text-black font-semibold py-2 rounded-md hover:bg-primary-hover">Save Changes</button>
                        </form>
                    </div>
                </div>
                
                <div id="addProductModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
                    <div class="bg-light-surface dark:bg-dark-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
                        <button class="absolute top-4 right-4 text-light-text-secondary dark:text-dark-text-secondary hover:text-light-text dark:hover:text-dark-text" onclick="app.closeModal('addProductModal')"><i class="fas fa-times"></i></button>
                        <h2 class="text-2xl font-bold mb-6 text-light-text dark:text-dark-text">Add New Product</h2>
                        <form id="add-product-form">
                             <div class="mb-4">
                                <label for="new-product-name" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Product Name</label>
                                <input type="text" id="new-product-name" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="mb-4">
                                <label for="new-product-price" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Price ($)</label>
                                <input type="number" step="0.01" id="new-product-price" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                             <div class="mb-6">
                                <label for="new-product-stock" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Initial Stock</label>
                                <input type="number" id="new-product-stock" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <button type="submit" class="w-full bg-primary text-black font-semibold py-2 rounded-md hover:bg-primary-hover">Add Product</button>
                        </form>
                    </div>
                </div>

                <div id="delegateStockModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
                    <div class="bg-light-surface dark:bg-dark-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
                        <button class="absolute top-4 right-4 text-light-text-secondary dark:text-dark-text-secondary hover:text-light-text dark:hover:text-dark-text" onclick="app.closeModal('delegateStockModal')"><i class="fas fa-times"></i></button>
                        <h2 class="text-2xl font-bold mb-6 text-light-text dark:text-dark-text">Delegate Stock to Employee</h2>
                        <form id="delegate-stock-form">
                             <div class="mb-4">
                                <label for="delegate-employee" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Employee</label>
                                <select id="delegate-employee" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary"></select>
                            </div>
                            <div class="mb-4">
                                <label for="delegate-product" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Product</label>
                                 <select id="delegate-product" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary"></select>
                            </div>
                             <div class="mb-6">
                                <label for="delegate-quantity" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Quantity</label>
                                <input type="number" id="delegate-quantity" min="1" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <button type="submit" class="w-full bg-primary text-black font-semibold py-2 rounded-md hover:bg-primary-hover">Delegate Stock</button>
                        </form>
                    </div>
                </div>
                
                <div id="createTaskModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
                    <div class="bg-light-surface dark:bg-dark-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
                        <button class="absolute top-4 right-4 text-light-text-secondary dark:text-dark-text-secondary hover:text-light-text dark:hover:text-dark-text" onclick="app.closeModal('createTaskModal')"><i class="fas fa-times"></i></button>
                        <h2 class="text-2xl font-bold mb-6 text-light-text dark:text-dark-text">Create New Task</h2>
                        <form id="create-task-form">
                             <div class="mb-4">
                                <label for="new-task-description" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Task Description</label>
                                <input type="text" id="new-task-description" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="mb-6">
                                <label for="new-task-assignee" class="block text-sm font-medium text-light-text-secondary dark:text-dark-text-secondary">Assign To</label>
                                <select id="new-task-assignee" required class="mt-1 block w-full bg-light-bg dark:bg-dark-bg border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-primary"></select>
                            </div>
                            <button type="submit" class="w-full bg-primary text-black font-semibold py-2 rounded-md hover:bg-primary-hover">Create Task</button>
                        </form>
                    </div>
                </div>
            `;
        },

        // --- UI LOGIC ---
        applyTheme() {
            const themeIcon = document.getElementById('theme-icon');
            if (this.state.theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                document.documentElement.classList.remove('dark');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        },
        toggleTheme() {
            this.state.theme = this.state.theme === 'dark' ? 'light' : 'dark';
            this.applyTheme();
            this.saveState();
        },
        setActiveTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            switch(tabName) {
                case 'dashboard': this.renderDashboard(); break;
                case 'my-tasks': this.renderMyTasks(); break;
                case 'my-inventory': this.renderMyInventory(); break;
                case 'sales-expenses': this.renderSalesAndExpenses(); break;
                case 'stores': this.renderStoresTab(); break;
                case 'invoices': this.renderInvoices(); break;
                case 'ledger': this.renderLedger(); break;
            }
        },
        openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            const activeEmployees = this.getActiveEmployees();
            if (modalId === 'delegateStockModal') {
                document.getElementById('delegate-employee').innerHTML = activeEmployees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
                document.getElementById('delegate-product').innerHTML = this.state.masterInventory.map(p => `<option value="${p.id}">${p.name} (Stock: ${p.stock})</option>`).join('');
            } else if (modalId === 'createTaskModal') {
                document.getElementById('new-task-assignee').innerHTML = activeEmployees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            }
            modal.classList.remove('hidden');
        },
        closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        },
        togglePanel(panelName) {
            const content = document.getElementById(`${panelName}-content`);
            const icon = document.getElementById(`${panelName}-toggle-icon`);
            content.classList.toggle('hidden');
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-up');
        },
        showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            document.getElementById('notification-message').textContent = message;
            notification.className = 'fixed top-5 right-5 z-[100] text-black py-2 px-4 rounded-md shadow-lg';
            notification.classList.add(type === 'success' ? 'bg-accent-green' : 'bg-accent-red');
            void notification.offsetWidth; 
            notification.classList.add('animate-fade-in-out');
        },
        handleSaleTypeChange() {
            const saleType = document.getElementById('sale-type').value;
            const discountContainer = document.getElementById('deal-specific-fields');
            const creditContainer = document.getElementById('credit-specific-fields');
            
            discountContainer.classList.add('hidden');
            creditContainer.classList.add('hidden');
            document.getElementById('sale-discount').value = '';
            document.getElementById('sale-due-date').value = '';

            if (saleType === 'Deal') {
                discountContainer.classList.remove('hidden');
            } else if (saleType === 'Credit') {
                creditContainer.classList.remove('hidden');
            }
            this.updateFinalSaleAmount();
        },
        updateFinalSaleAmount() {
            const productId = document.getElementById('sale-product').value;
            const quantity = parseInt(document.getElementById('sale-quantity').value, 10) || 0;
            const discount = parseFloat(document.getElementById('sale-discount').value) || 0;
            const product = this.getProduct(productId);

            if (!product || quantity <= 0) {
                document.getElementById('sale-total-price').textContent = '$0.00';
                document.getElementById('sale-amount').value = '0.00';
                return;
            }

            const totalPrice = product.price * quantity;
            const finalAmount = totalPrice - discount;

            document.getElementById('sale-total-price').textContent = `$${totalPrice.toFixed(2)}`;
            document.getElementById('sale-amount').value = finalAmount.toFixed(2);
        },
        
        // --- ACTION HANDLERS ---
        createEmployee(name, position) {
            return { id: `emp_${Date.now()}`, name, position, isActive: true, inventory: [], transactions: [] };
        },
        handleAddEmployee(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.querySelector('#new-employee-name').value;
            const position = form.querySelector('#new-employee-position').value;
            if (!name || !position) return;
            this.state.employees.push(this.createEmployee(name, position));
            this.saveState();
            this.render();
            form.reset();
            this.closeModal('addEmployeeModal');
            this.showNotification(`Employee '${name}' added.`, 'success');
        },
        startEditEmployee(employeeId) {
            const employee = this.getEmployee(employeeId);
            if (!employee) return;
            document.getElementById('edit-employee-id').value = employee.id;
            document.getElementById('edit-employee-name').value = employee.name;
            document.getElementById('edit-employee-position').value = employee.position;
            this.openModal('editEmployeeModal');
        },
        handleUpdateEmployee(e) {
            e.preventDefault();
            const employeeId = document.getElementById('edit-employee-id').value;
            const employee = this.getEmployee(employeeId);
            if (!employee) return;
            employee.name = document.getElementById('edit-employee-name').value;
            employee.position = document.getElementById('edit-employee-position').value;
            this.saveState();
            this.render();
            this.closeModal('editEmployeeModal');
            this.showNotification('Employee details updated.', 'success');
        },
        deactivateEmployee(employeeId) {
            if (confirm('Deactivate this employee? Their data will be saved, but they will be hidden.')) {
                const employee = this.getEmployee(employeeId);
                if (employee) {
                    employee.isActive = false;
                    this.saveState();
                    this.render();
                    this.showNotification(`${employee.name} has been deactivated.`, 'success');
                }
            }
        },
        reactivateEmployee(employeeId) {
            const employee = this.getEmployee(employeeId);
            if (employee) {
                employee.isActive = true;
                this.state.currentEmployeeId = employeeId;
                this.saveState();
                this.render();
                this.showNotification(`${employee.name} has been reactivated.`, 'success');
            }
        },
        handleAddStore(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.querySelector('#employee-new-store-name').value;
            const creditLimit = parseFloat(form.querySelector('#employee-new-store-credit-limit').value) || 0;
            if (!name) return;
            this.state.stores.push({ id: `store_${Date.now()}`, name, creditLimit, creditAvailable: creditLimit, creditUsed: 0, dueDate: null });
            this.saveState();
            this.renderStoresTab();
            this.renderSalesAndExpenses(); 
            form.reset();
            this.showNotification(`Store '${name}' added.`, 'success');
        },
        startEditStore(storeId) {
            const store = this.getStore(storeId);
            if (!store) return;
            document.getElementById('edit-store-id').value = store.id;
            document.getElementById('edit-store-name').value = store.name;
            document.getElementById('edit-store-credit-limit').value = store.creditLimit || 0;
            this.openModal('editStoreModal');
        },
        handleUpdateStore(e) {
            e.preventDefault();
            const storeId = document.getElementById('edit-store-id').value;
            const store = this.getStore(storeId);
            if (!store) return;
            
            const oldCreditLimit = store.creditLimit || 0;
            const newCreditLimit = parseFloat(document.getElementById('edit-store-credit-limit').value) || 0;
            const creditUsed = oldCreditLimit - (store.creditAvailable || oldCreditLimit);
            
            store.name = document.getElementById('edit-store-name').value;
            store.creditLimit = newCreditLimit;
            store.creditAvailable = newCreditLimit - creditUsed;

            this.saveState();
            this.renderStoresTab();
            this.renderSalesAndExpenses();
            this.closeModal('editStoreModal');
            this.showNotification('Store details updated.', 'success');
        },
        deleteStore(storeId) {
            if (confirm('Delete this store? This action cannot be undone.')) {
                this.state.stores = this.state.stores.filter(s => s.id !== storeId);
                this.saveState();
                this.renderStoresTab();
                this.renderSalesAndExpenses();
                this.showNotification('Store deleted.', 'success');
            }
        },
        handleAddProduct(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.querySelector('#new-product-name').value;
            const price = parseFloat(form.querySelector('#new-product-price').value);
            const stock = parseInt(form.querySelector('#new-product-stock').value, 10);
            if (!name || isNaN(price) || isNaN(stock)) return;
            this.state.masterInventory.push({ id: `prod_${Date.now()}`, name, price, stock, isActive: true });
            this.saveState();
            this.render();
            form.reset();
            this.closeModal('addProductModal');
            this.showNotification(`Product '${name}' added.`, 'success');
        },
        handleDelegateStock(e) {
            e.preventDefault();
            const form = e.target;
            const employeeId = form.querySelector('#delegate-employee').value;
            const productId = form.querySelector('#delegate-product').value;
            const quantity = parseInt(form.querySelector('#delegate-quantity').value, 10);
            const masterProduct = this.getProduct(productId);
            if (!employeeId || !productId || isNaN(quantity) || quantity <= 0 || !masterProduct) return;
            if (masterProduct.stock < quantity) {
                this.showNotification('Not enough stock in master inventory.', 'error');
                return;
            }
            masterProduct.stock -= quantity;
            const employee = this.getEmployee(employeeId);
            let employeeProduct = employee.inventory.find(item => item.productId === productId);
            if (employeeProduct) {
                employeeProduct.stock += quantity;
            } else {
                employee.inventory.push({ productId, stock: quantity });
            }
            this.saveState();
            this.render();
            form.reset();
            this.closeModal('delegateStockModal');
            this.showNotification(`${quantity} x ${masterProduct.name} delegated to ${employee.name}.`, 'success');
        },
        handleCreateTask(e) {
            e.preventDefault();
            const form = e.target;
            const description = form.querySelector('#new-task-description').value;
            const assigneeId = form.querySelector('#new-task-assignee').value;
            if (!description || !assigneeId) return;
            this.state.tasks.push({ id: `task_${Date.now()}`, description, assigneeId, status: 'In Progress' });
            this.saveState();
            this.render();
            form.reset();
            this.closeModal('createTaskModal');
            const assignee = this.getEmployee(assigneeId);
            this.showNotification(`Task assigned to ${assignee.name}.`, 'success');
        },
        toggleTaskStatus(taskId) {
            const task = this.state.tasks.find(t => t.id === taskId);
            if (task) {
                task.status = task.status === 'Completed' ? 'In Progress' : 'Completed';
                this.saveState();
                this.render();
                this.setActiveTab('my-tasks');
                this.showNotification(`Task status updated to ${task.status}.`, 'success');
            }
        },
        handleRecordSale(e) {
            e.preventDefault();
            const form = e.target;
            const storeId = form.querySelector('#sale-store').value;
            const productId = form.querySelector('#sale-product').value;
            const saleType = form.querySelector('#sale-type').value;
            const quantity = parseInt(form.querySelector('#sale-quantity').value, 10);
            const discount = parseFloat(form.querySelector('#sale-discount').value) || 0;
            const amount = parseFloat(form.querySelector('#sale-amount').value);
            const dueDate = form.querySelector('#sale-due-date').value;

            const employee = this.getEmployee(this.state.currentEmployeeId);
            const employeeInventoryItem = employee.inventory.find(i => i.productId === productId);
            const store = this.getStore(storeId);

            if (!storeId || !productId || isNaN(amount) || isNaN(quantity) || quantity <= 0) {
                this.showNotification('Invalid sale data. Please check all fields.', 'error');
                return;
            }
            if (!employeeInventoryItem || employeeInventoryItem.stock < quantity) {
                this.showNotification('Not enough stock to complete sale.', 'error');
                return;
            }

            if (saleType === 'Credit') {
                if (!store || (store.creditAvailable || 0) < amount) {
                    this.showNotification(`Insufficient credit for ${store.name}.`, 'error');
                    return;
                }
                store.creditAvailable -= amount;
                store.creditUsed = (store.creditUsed || 0) + amount;
                if (dueDate) store.dueDate = dueDate;
            }

            employeeInventoryItem.stock -= quantity;
            employee.transactions.push({ 
                id: `txn_${Date.now()}`, type: 'sale', saleType, storeId, productId, amount, quantity, discount,
                date: new Date().toISOString(), invoiced: false 
            });
            this.saveState();
            this.render();
            this.setActiveTab('sales-expenses');
            form.reset();
            this.handleSaleTypeChange();
            this.showNotification('Sale recorded successfully!', 'success');
        },
        handleRecordExpense(e) {
            e.preventDefault();
            const form = e.target;
            const description = form.querySelector('#expense-description').value;
            const amount = parseFloat(form.querySelector('#expense-amount').value);
            if (!description || isNaN(amount)) {
                this.showNotification('Invalid expense data.', 'error');
                return;
            }
            const employee = this.getEmployee(this.state.currentEmployeeId);
            employee.transactions.push({ id: `txn_${Date.now()}`, type: 'expense', description, amount, date: new Date().toISOString() });
            this.saveState();
            this.render();
            this.setActiveTab('sales-expenses');
            form.reset();
            this.showNotification('Expense recorded successfully!', 'success');
        },
        async handleGenerateInvoice(e) {
            e.preventDefault();
            const form = e.target;
            const selectedSalesIds = Array.from(form.querySelectorAll('input[name="invoice-sale"]:checked')).map(cb => cb.value);
            if (selectedSalesIds.length === 0) {
                this.showNotification('Please select at least one sale for the receipt.', 'error');
                return;
            }
            const btn = document.getElementById('generate-pdf-btn'), loader = document.getElementById('generate-pdf-loader');
            btn.disabled = true;
            document.getElementById('generate-pdf-text').textContent = 'Generating...';
            loader.classList.remove('hidden');
            const employee = this.getEmployee(this.state.currentEmployeeId);
            const salesToInvoice = employee.transactions.filter(t => selectedSalesIds.includes(t.id));
            const totalAmount = salesToInvoice.reduce((sum, sale) => sum + sale.amount, 0);
            const invoiceHtml = this.generateInvoiceHtml(employee, salesToInvoice, totalAmount);
            try {
                const response = await fetch('https://api.pdfshift.io/v3/convert/pdf', {
                    method: 'POST',
                    headers: { 'Authorization': 'Basic ' + btoa('api:' + this.pdfShiftApiKey), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source: invoiceHtml, landscape: false })
                });
                if (!response.ok) throw new Error(`PDF Generation Failed: ${(await response.json()).message}`);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none'; a.href = url; a.download = `Receipt_${Date.now()}.pdf`;
                document.body.appendChild(a); a.click();
                window.URL.revokeObjectURL(url); a.remove();
                salesToInvoice.forEach(sale => sale.invoiced = true);
                this.saveState(); this.render(); this.setActiveTab('invoices');
                this.showNotification('PDF Receipt downloaded successfully!', 'success');
            } catch (error) {
                console.error('Error generating PDF:', error);
                this.showNotification(error.message, 'error');
            } finally {
                btn.disabled = false;
                document.getElementById('generate-pdf-text').textContent = 'Generate & Download PDF Receipt';
                loader.classList.add('hidden');
                form.reset();
            }
        },
        generateInvoiceHtml(employee, sales, total) {
            let totalDiscount = 0;
            const itemsHtml = sales.map(sale => {
                const product = this.getProduct(sale.productId);
                const store = this.getStore(sale.storeId);
                const unitPrice = sale.quantity > 0 ? sale.amount / sale.quantity : 0;
                if (sale.discount > 0) totalDiscount += sale.discount;
                return `<tr><td style="padding: 8px; border-bottom: 1px solid #eee;">${product.name} (Sold at ${store?.name || 'Deleted Store'})</td><td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">${sale.quantity || 1}</td><td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">$${unitPrice.toFixed(2)}</td><td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">$${sale.amount.toFixed(2)}</td></tr>`;
            }).join('');
            
            const subtotal = sales.reduce((sum, sale) => sum + (this.getProduct(sale.productId).price * (sale.quantity || 1)), 0);
            const discountHtml = totalDiscount > 0 ? `<div class="total" style="font-weight:normal; font-size: 1em;">Discount: -$${totalDiscount.toFixed(2)}</div>` : '';

            return `<!DOCTYPE html><html><head><style>body{font-family:sans-serif;color:#333}.container{max-width:800px;margin:auto;padding:20px;border:1px solid #eee;box-shadow:0 0 10px rgba(0,0,0,.15)}.header,.details{margin-bottom:40px}.table{width:100%;border-collapse:collapse}.table th{background:#f9f9f9;text-align:left;padding:8px;border-bottom:2px solid #ddd}.total{text-align:right;margin-top:20px;font-size:1.2em;font-weight:bold}</style></head><body><div class="container"><div class="header"><h1>Sales Receipt</h1><p>Receipt ID: RCPT_${Date.now()}</p></div><div class="details"><strong>Generated By:</strong><br>${employee.name} (${employee.position})<br>Date: ${new Date().toLocaleDateString()}</div><table class="table"><thead><tr><th>Item</th><th>Quantity</th><th>Unit Price</th><th>Total</th></tr></thead><tbody>${itemsHtml}</tbody></table><div class="total" style="font-weight:normal; font-size: 1em; margin-top: 20px;">Subtotal: $${subtotal.toFixed(2)}</div>${discountHtml}<div class="total" style="margin-top: 5px;">Total: $${total.toFixed(2)}</div></div></body></html>`;
        },
        async generateAIPlan() {
            const employeeId = document.getElementById('ai-employee-select').value;
            const employee = this.getEmployee(employeeId);
            if (!employee) return;
            const btn = document.getElementById('generate-plan-btn'), loader = document.getElementById('generate-plan-loader');
            btn.disabled = true;
            document.getElementById('generate-plan-text').textContent = 'Analyzing...';
            loader.classList.remove('hidden');
            document.getElementById('ai-plan-output').innerHTML = `<p class="text-light-text-secondary dark:text-dark-text-secondary">Accura AI is analyzing the data...</p>`;
            const revenue = employee.transactions.filter(t => t.type === 'sale').reduce((s, t) => s + t.amount, 0);
            const expenses = employee.transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const profit = revenue - expenses;
            const recentTransactions = employee.transactions.slice(-5).map(t => {
                const desc = t.type === 'sale' ? `Sale of ${this.getProduct(t.productId)?.name}` : t.description;
                return `${t.type.toUpperCase()}: $${t.amount.toFixed(2)} - ${desc}`;
            });
            const plan = await this.mockGeminiAPI(employee.name, revenue, expenses, profit, recentTransactions);
            this.showNotification(`AI profit plan for ${employee.name} generated.`, 'success');
            document.getElementById('ai-plan-output').innerHTML = this.simpleMarkdownToHtml(plan);
            btn.disabled = false;
            document.getElementById('generate-plan-text').textContent = 'Generate Plan';
            loader.classList.add('hidden');
        },
        async mockGeminiAPI(name, revenue, expenses, profit, transactions) {
            return new Promise(resolve => setTimeout(() => {
                const advice = [];
                if (profit < 0) advice.push(`- **Address Negative Profit:** The current net profit is -$${Math.abs(profit).toFixed(2)}. Prioritize cost reduction or boosting high-margin sales immediately.`);
                else advice.push(`- **Leverage Positive Profit:** With a net profit of $${profit.toFixed(2)}, consider reinvesting in top-selling products or marketing efforts to scale up.`);
                if (expenses > revenue * 0.5 && revenue > 0) advice.push(`- **Review High Expenses:** Expenses ($${expenses.toFixed(2)}) are more than 50% of revenue ($${revenue.toFixed(2)}). Conduct a detailed review of all expenses to identify potential savings.`);
                else if (expenses === 0 && revenue > 0) advice.push(`- **Track All Expenses:** No expenses have been recorded. Ensure all business-related costs are logged to get an accurate view of profitability.`);
                else advice.push(`- **Maintain Expense Control:** Expenses are currently well-managed relative to revenue. Continue monitoring to maintain this healthy ratio.`);
                if (transactions.some(t => t.includes('DEAL'))) advice.push(`- **Analyze Deal Performance:** Multiple 'Deal' type sales were recorded. Analyze if these deals are leading to repeat business or if they are impacting overall margin too heavily.`);
                advice.push(`- **Focus on Top Sellers:** Identify which products are sold most frequently and ensure adequate stock levels for them.`);
                const response = `### Profit Plan for ${name}\n\n**1. Key Observations:**\n* **Total Revenue:** $${revenue.toFixed(2)}\n* **Total Expenses:** $${expenses.toFixed(2)}\n* **Net Profit:** $${profit.toFixed(2)}\n\n**2. Actionable Steps:**\n${advice.join('\n')}\n\n**3. Next Steps:**\nFocus on implementing one of these suggestions this week and track the impact on your net profit.`;
                resolve(response.trim());
            }, 1500));
        },
        simpleMarkdownToHtml(md) {
            let html = md.replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold mt-4 mb-2">$1</h3>').replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold mt-5 mb-3">$1</h2>').replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold mt-6 mb-4">$1</h1>').replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>').replace(/^\* (.*$)/gim, '<li class="ml-4">$1</li>');
            html = html.replace(/<\/li>\n<li/gim, '</li><li').replace(/(<li.*<\/li>)/gs, '<ul class="list-disc list-inside space-y-1">$1</ul>').replace(/\n/g, '<br>').replace(/<br><ul/g, '<ul').replace(/ul><br>/g, 'ul>').replace(/<br><h/g, '<h').replace(/h3><br>/g, 'h3>');
            return html;
        }
    };
    app.init();
    window.app = app; 
});
</script>

</body>
</html>
