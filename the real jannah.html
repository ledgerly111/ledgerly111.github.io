<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jannah Quran App</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Noto Naskh Arabic, Inter, and Lora -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;1,400&family=Noto+Naskh+Arabic:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Base font styles */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .arabic-text {
            font-family: 'Noto Naskh Arabic', serif;
            font-size: 1.5rem;
            line-height: 2.8rem;
            user-select: none;
            -webkit-user-select: none; 
        }
        .english-text {
            font-family: 'Lora', serif;
            font-size: 1.2rem;
            line-height: 1.9rem;
        }

        /* --- Theme Styles --- */
        :root {
            --accent-gold: #FBBF24; /* amber-400 */
        }

        /* 1. Paper (The original "White") - Default */
        body.theme-paper {
            --bg-color: #F8F5F1; --text-color: #374151; --card-bg: #FFFFFF; --primary-text: #B45309;
            --secondary-text: #6B7280; --arabic-text-color: #111827; --header-bg: rgba(248, 245, 241, 0.8);
            --icon-color: #374151; --border-color: #E5E7EB; --highlight-text-color: #111827;
        }
        
        /* Other Themes */
        body.theme-midnight {
            --bg-color: #0D1221; --text-color: #E5E7EB; --card-bg: #161D30; --primary-text: #FFFFFF;
            --secondary-text: #9CA3AF; --arabic-text-color: #E5E7EB; --header-bg: rgba(13, 18, 33, 0.8);
            --icon-color: #E5E7EB; --border-color: #374151; --highlight-text-color: #111827;
        }
        body.theme-black {
            --bg-color: #000000; --text-color: #E5E7EB; --card-bg: #1C1C1E; --primary-text: #FFFFFF;
            --secondary-text: #9CA3AF; --arabic-text-color: #E5E7EB; --header-bg: rgba(0, 0, 0, 0.7);
            --icon-color: #E5E7EB; --border-color: #2c2c2e; --highlight-text-color: #111827;
        }
        body.theme-sepia {
            --bg-color: #f4e9d8; --text-color: #433422; --card-bg: #fdf6e9; --primary-text: #5f482c;
            --secondary-text: #8c785d; --arabic-text-color: #433422; --header-bg: rgba(244, 233, 216, 0.8);
            --icon-color: #433422; --border-color: #e4d7c5; --highlight-text-color: #FFFFFF;
        }
        body.theme-green {
            --bg-color: #0f1c14; --text-color: #d1fae5; --card-bg: #11221a; --primary-text: #a7f3d0;
            --secondary-text: #6ee7b7; --arabic-text-color: #d1fae5; --header-bg: rgba(15, 28, 20, 0.8);
            --icon-color: #d1fae5; --border-color: #064e3b; --highlight-text-color: #064e3b;
        }
        body.theme-crimson {
            --bg-color: #450a0a; --text-color: #fef3c7; --card-bg: #5c1a1a; --primary-text: #fde68a;
            --secondary-text: #fef3c7; --arabic-text-color: #fef3c7; --header-bg: rgba(69, 10, 10, 0.8);
            --icon-color: #fef3c7; --border-color: #991b1b; --highlight-text-color: #450a0a;
        }
        
        /* Applying theme variables */
        body { background-color: var(--bg-color); color: var(--text-color); }
        .header { background-color: var(--header-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); }
        .modal-content, .surah-card, .verse-card { background-color: var(--card-bg); border: 1px solid var(--border-color); }
        .surah-name-translit { color: var(--primary-text); }
        .surah-name-arabic { color: var(--arabic-text-color); }
        .surah-metadata { color: var(--secondary-text); }
        .icon { color: var(--icon-color); }
        .arabic-word.highlight { color: var(--accent-gold); }
        
        #word-tooltip {
            position: fixed; background-color: var(--accent-gold); color: var(--highlight-text-color);
            padding: 0.5rem 1rem; border-radius: 8px; font-size: 1.25rem; font-family: 'Inter', sans-serif;
            pointer-events: none; z-index: 100; display: none; box-shadow: 0 4px 14px rgba(0,0,0,0.2); text-align: center;
        }
        
        .verse-card.playing {
            border-color: var(--accent-gold);
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
        }
        .repeat-btn.active, .continuous-play-btn.active {
            color: var(--accent-gold);
        }
    </style>
</head>
<body class="theme-paper">
    <!-- Tooltip and Audio elements added to the body -->
    <div id="word-tooltip"></div>
    <audio id="audio-player" class="hidden"></audio>

    <!-- Modals -->
    <div id="modal-backdrop" class="hidden fixed inset-0 bg-black bg-opacity-70 z-40"></div>
    <div id="color-modal" class="hidden fixed inset-0 z-50 flex justify-center items-center p-4">
        <div class="modal-content p-6 rounded-lg shadow-xl w-full max-w-sm">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold" style="color: var(--primary-text);">Appearance</h2>
                <button class="close-modal-btn p-2 rounded-full hover:bg-gray-500/20">
                    <svg class="icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="color-grid" class="grid grid-cols-3 gap-4"></div>
            <hr class="my-4" style="border-color: var(--border-color);">
            <h3 class="text-lg font-bold mb-2" style="color: var(--primary-text);">Reciter</h3>
            <div id="reciter-list" class="space-y-2"></div>
        </div>
    </div>
    <div id="info-modal" class="hidden fixed inset-0 z-50 flex justify-center items-center p-4">
        <div class="modal-content p-6 rounded-lg shadow-xl w-full max-w-md max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="info-modal-title" class="text-xl font-bold" style="color: var(--primary-text);">Surah Info</h2>
                <button class="close-modal-btn p-2 rounded-full hover:bg-gray-500/20">
                    <svg class="icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="info-modal-content" class="prose dark:prose-invert max-w-none" style="color: var(--text-color);"></div>
        </div>
    </div>
    <div id="ai-modal" class="hidden fixed inset-0 z-50 flex justify-center items-center p-4">
        <div class="modal-content p-6 rounded-lg shadow-xl w-full max-w-md max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold" style="color: var(--primary-text);">Ask Nur</h2>
                <button class="close-modal-btn p-2 rounded-full hover:bg-gray-500/20">
                    <svg class="icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="ai-chat-box" class="flex-grow overflow-y-auto mb-4 space-y-4"></div>
            <div class="flex gap-2">
                <input type="text" id="ai-input" placeholder="Ask a question..." class="flex-grow p-2 rounded-lg border" style="background-color: var(--bg-color); border-color: var(--border-color); color: var(--text-color);">
                <button id="ai-submit-btn" class="p-2 rounded-lg" style="background-color: var(--accent-gold); color: var(--highlight-text-color);">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto max-w-3xl">
        <!-- Header -->
        <header id="header" class="header sticky top-0 z-20 p-4">
            <div class="flex justify-between items-center">
                <button id="back-button" class="hidden p-2 rounded-full hover:bg-gray-500/20">
                    <svg class="icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h1 id="header-title" class="text-2xl font-bold text-center" style="color: var(--primary-text);">The Qur'an</h1>
                <div class="flex items-center gap-2">
                    <button id="ai-btn" class="p-2 rounded-full hover:bg-gray-500/20">
                        <svg class="icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.293 2.293a1 1 0 01-1.414 1.414L12 6.414l-2.293 2.293a1 1 0 01-1.414-1.414L10 5m0 14l2.293-2.293a1 1 0 011.414 1.414L12 17.586l2.293-2.293a1 1 0 011.414 1.414L14 19m-4-5h8m-4-7a3 3 0 013 3v4a3 3 0 11-6 0v-4a3 3 0 013-3z"></path></svg>
                    </button>
                    <button id="info-btn" class="hidden p-2 rounded-full hover:bg-gray-500/20">
                        <svg class="icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>
                    <button id="color-palette-btn" class="p-2 rounded-full hover:bg-gray-500/20">
                        <svg class="icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path></svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="p-4">
            <div id="surah-list-view">
                <div class="mb-4">
                    <input type="text" id="search-bar" placeholder="Search for a Surah..." class="w-full p-3 rounded-lg border" style="background-color: var(--card-bg); border-color: var(--border-color); color: var(--text-color);">
                </div>
                <div id="surah-list-container" class="space-y-3"></div>
            </div>
            <div id="verse-view" class="hidden space-y-4"></div>
        </main>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const surahListContainer = document.getElementById('surah-list-container');
        const versesContainer = document.getElementById('verse-view');
        const surahListView = document.getElementById('surah-list-view');
        const verseView = document.getElementById('verse-view');
        const backButton = document.getElementById('back-button');
        const headerTitle = document.getElementById('header-title');
        const wordTooltip = document.getElementById('word-tooltip');
        const colorPaletteBtn = document.getElementById('color-palette-btn');
        const colorModal = document.getElementById('color-modal');
        const closeModalBtns = document.querySelectorAll('.close-modal-btn');
        const colorGrid = document.getElementById('color-grid');
        const reciterListDiv = document.getElementById('reciter-list');
        const infoBtn = document.getElementById('info-btn');
        const infoModal = document.getElementById('info-modal');
        const infoModalTitle = document.getElementById('info-modal-title');
        const infoModalContent = document.getElementById('info-modal-content');
        const aiBtn = document.getElementById('ai-btn');
        const aiModal = document.getElementById('ai-modal');
        const aiChatBox = document.getElementById('ai-chat-box');
        const aiInput = document.getElementById('ai-input');
        const aiSubmitBtn = document.getElementById('ai-submit-btn');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const audioPlayer = document.getElementById('audio-player');
        const searchBar = document.getElementById('search-bar');

        // --- API Endpoints & Data ---
        const API_URL = (id, reciterId) => `https://api.quran.com/api/v4/verses/by_chapter/${id}?words=true&word_fields=text_uthmani&translations=20&translation_fields=text&audio=${reciterId}&per_page=300`;
        const SURAH_INFO_URL = (id) => `https://api.quran.com/api/v4/chapters/${id}/info`;
        
        const THEMES = [
            { name: 'paper', color: '#F8F5F1', label: 'Paper' },
            { name: 'sepia', color: '#f4e9d8', label: 'Sepia' },
            { name: 'midnight', color: '#0D1221', label: 'Midnight' },
            { name: 'black', color: '#000000', label: 'Pitch Black' },
            { name: 'green', color: '#0f1c14', label: 'Forest' },
            { name: 'crimson', color: '#450a0a', label: 'Crimson' }
        ];
        
        const RECITERS = [
            { id: 7, name: 'Mishary Rashid Alafasy' },
            { id: 1, name: 'Abdul Basit Abdus Samad' },
            { id: 4, name: 'Abdur-Rahman as-Sudais' },
            { id: 2, name: 'Maher Al Muaiqly' },
            { id: 11, name: 'Yasser Ad-Dussary' }
        ];

        // --- State Variables ---
        let currentSurahInfo = null;
        let liveHighlightWord = null;
        let tapHighlightWord = null;
        let tapTimer = null;
        let isSwiping = false;
        let currentlyPlaying = { button: null, card: null };
        let selectedReciterId = 7;
        let audioQueue = [];
        let currentQueueIndex = 0;
        let repeatCount = 0;

        // --- Main Initialization ---
        function initializeApp() {
            loadSavedSettings();
            const surahList = getEmbeddedSurahList();
            populateSurahList(surahList);
            populateAppearanceModal();
            showSurahListView();
        }
        
        // --- View Management ---
        function showSurahListView() {
            surahListView.classList.remove('hidden');
            verseView.classList.add('hidden');
            backButton.classList.add('hidden');
            infoBtn.classList.add('hidden');
            colorPaletteBtn.classList.remove('hidden');
            aiBtn.classList.remove('hidden');
            headerTitle.textContent = "The Qur'an";
            stopAudio();
            clearTapHighlight();
            hideTooltip();
        }
        
        function showVerseView(surahName) {
            surahListView.classList.add('hidden');
            verseView.classList.remove('hidden');
            backButton.classList.remove('hidden');
            infoBtn.classList.remove('hidden');
            colorPaletteBtn.classList.remove('hidden');
            aiBtn.classList.remove('hidden');
            headerTitle.textContent = surahName;
        }

        // --- UI Population Functions ---
        function populateSurahList(surahList) {
            surahListContainer.innerHTML = ''; 
            surahList.forEach((surah) => {
                const card = document.createElement('div');
                card.className = 'surah-card p-4 rounded-lg flex items-center gap-4 cursor-pointer transition-transform transform hover:scale-105';
                card.dataset.surahId = surah.id;
                card.dataset.surahName = surah.transliteration;
                card.innerHTML = `
                    <div class="relative">
                        <svg width="40" height="40" viewBox="0 0 36 36" class="fill-current" style="color: var(--accent-gold);">
                            <path d="M18,2.1C9.2,2.1,2.1,9.2,2.1,18S9.2,33.9,18,33.9,33.9,26.8,33.9,18,26.8,2.1,18,2.1Z"></path>
                        </svg>
                        <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 font-bold text-sm" style="color: var(--highlight-text-color);">${surah.id}</span>
                    </div>
                    <div class="flex-grow">
                        <p class="font-bold text-lg surah-name-translit">${surah.transliteration}</p>
                        <p class="text-sm surah-metadata">${surah.total_verses} verses • ${surah.type}</p>
                    </div>
                    <div class="text-right flex-shrink-0">
                         <p class="font-bold text-xl surah-name-arabic">${surah.name}</p>
                    </div>
                `;
                surahListContainer.appendChild(card);
            });
        }

        async function displaySurah(surahId, surahName) {
            showVerseView(surahName);
            versesContainer.innerHTML = `<p class="text-center p-10">Loading Surah...</p>`;
            
            try {
                const [verseResponse, infoResponse] = await Promise.all([
                    fetch(API_URL(surahId, selectedReciterId)),
                    fetch(SURAH_INFO_URL(surahId))
                ]);

                if (!verseResponse.ok) throw new Error(`Failed to load verses for Surah ${surahId}`);
                if (!infoResponse.ok) throw new Error(`Failed to load info for Surah ${surahId}`);
                
                const verseData = await verseResponse.json();
                const infoData = await infoResponse.json();
                currentSurahInfo = infoData.chapter_info;
                
                versesContainer.innerHTML = ''; 

                verseData.verses.forEach(verse => {
                    const arabicTextHtml = verse.words.map(word => 
                        `<span class="arabic-word cursor-pointer" data-translation="${word.translation.text}">${word.text_uthmani}</span>`
                    ).join(' ');

                    const fullVerseTranslation = verse.translations[0]?.text.replace(/<[^>]*>/g, '') || '';
                    const audioUrl = verse.audio.url;

                    const verseCard = document.createElement('div');
                    verseCard.id = `verse-${verse.verse_key}`;
                    verseCard.className = 'verse-card p-4 rounded-lg';
                    verseCard.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-sm font-bold px-2 py-1 rounded-md" style="background-color: var(--accent-gold); color: var(--highlight-text-color);">${verse.verse_key}</span>
                        </div>
                        <p class="text-right arabic-text" dir="rtl">${arabicTextHtml}</p>
                        <p class="mt-4 english-text">${fullVerseTranslation}</p>
                    `;
                    versesContainer.appendChild(verseCard);
                });
                
            } catch (error) {
                console.error("Error displaying Surah:", error);
                versesContainer.innerHTML = `<p class="text-center text-red-500">Error loading Surah. Please try again.</p>`;
            }
        }
        
        function populateAppearanceModal() {
            populateColorModal();
            populateReciterModal();
        }

        function populateColorModal() {
            colorGrid.innerHTML = '';
            const currentThemeName = document.body.className.replace('theme-', '');
            THEMES.forEach(theme => {
                const swatchWrapper = document.createElement('div');
                swatchWrapper.className = 'flex flex-col items-center gap-2';
                const swatch = document.createElement('button');
                swatch.className = 'w-12 h-12 rounded-full border-4 transition-all';
                swatch.style.backgroundColor = theme.color;
                swatch.style.borderColor = theme.name === currentThemeName ? 'var(--accent-gold)' : 'var(--border-color)';
                swatch.dataset.theme = theme.name;
                swatch.setAttribute('aria-label', theme.label);

                const label = document.createElement('p');
                label.className = 'text-xs';
                label.textContent = theme.label;
                
                swatchWrapper.appendChild(swatch);
                swatchWrapper.appendChild(label);
                colorGrid.appendChild(swatchWrapper);
            });
        }
        
        function populateReciterModal() {
            reciterListDiv.innerHTML = '';
            RECITERS.forEach(reciter => {
                const radioWrapper = document.createElement('div');
                radioWrapper.className = 'flex items-center';
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.id = `reciter-${reciter.id}`;
                radio.name = 'reciter';
                radio.value = reciter.id;
                radio.className = 'w-4 h-4 text-amber-500 bg-gray-100 border-gray-300 focus:ring-amber-500 dark:focus:ring-amber-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600';
                if (reciter.id === selectedReciterId) {
                    radio.checked = true;
                }
                
                const label = document.createElement('label');
                label.htmlFor = `reciter-${reciter.id}`;
                label.textContent = reciter.name;
                label.className = 'ml-2 text-sm font-medium';
                
                radioWrapper.appendChild(radio);
                radioWrapper.appendChild(label);
                reciterListDiv.appendChild(radioWrapper);
            });
        }

        // --- Interactivity ---
        backButton.addEventListener('click', showSurahListView);
        colorPaletteBtn.addEventListener('click', () => {
            modalBackdrop.classList.remove('hidden');
            colorModal.classList.remove('hidden');
        });
        infoBtn.addEventListener('click', () => {
            if (currentSurahInfo) {
                infoModalTitle.textContent = `About ${currentSurahInfo.transliteration}`;
                infoModalContent.innerHTML = `
                    <p class="mb-2"><strong>Source:</strong> ${currentSurahInfo.source}</p>
                    <div class="prose-p:my-2">${currentSurahInfo.short_text}</div>
                    <hr class="my-4 border-[var(--border-color)]">
                    <div class="prose-p:my-2">${currentSurahInfo.text}</div>
                `;
                modalBackdrop.classList.remove('hidden');
                infoModal.classList.remove('hidden');
            }
        });
        aiBtn.addEventListener('click', () => {
            modalBackdrop.classList.remove('hidden');
            aiModal.classList.remove('hidden');
        });

        closeModalBtns.forEach(btn => btn.addEventListener('click', () => {
            colorModal.classList.add('hidden');
            infoModal.classList.add('hidden');
            aiModal.classList.add('hidden');
            modalBackdrop.classList.add('hidden');
        }));

        colorGrid.addEventListener('click', (e) => {
            const target = e.target.closest('[data-theme]');
            if (target) setTheme(target.dataset.theme);
        });
        
        reciterListDiv.addEventListener('change', (e) => {
            if(e.target.name === 'reciter') {
                selectedReciterId = parseInt(e.target.value);
                localStorage.setItem('quranAppReciter', selectedReciterId);
                stopAudio();
            }
        });

        surahListContainer.addEventListener('click', (e) => {
            const surahCard = e.target.closest('.surah-card');
            if (surahCard) {
                const surahId = parseInt(surahCard.dataset.surahId);
                const surahName = surahCard.dataset.surahName;
                displaySurah(surahId, surahName);
            }
        });
        
        searchBar.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const allSurahCards = surahListContainer.querySelectorAll('.surah-card');
            allSurahCards.forEach(card => {
                const name = card.dataset.surahName.toLowerCase();
                const arabicName = card.querySelector('.surah-name-arabic').textContent.toLowerCase();
                if (name.includes(query) || arabicName.includes(query)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        });

        // --- Audio Controls ---
        function playAudio(button, card, url) {
            stopAudio(false);
            audioPlayer.src = `https://verses.quran.com/${url}`;
            audioPlayer.play().catch(e => console.error("Audio play failed:", e));
            button.innerHTML = `<svg class="icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            card.classList.add('playing');
            currentlyPlaying = { button, card };
        }

        function stopAudio(clearQueue = true) {
            audioPlayer.pause();
            audioPlayer.src = "";
            if (currentlyPlaying.button) {
                currentlyPlaying.button.innerHTML = `<svg class="icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            }
            if (currentlyPlaying.card) {
                currentlyPlaying.card.classList.remove('playing');
            }
            currentlyPlaying = { button: null, card: null };
            if (clearQueue) {
                audioQueue = [];
                currentQueueIndex = 0;
                repeatCount = 0;
            }
        }
        
        audioPlayer.addEventListener('ended', stopAudio);
        
        versesContainer.addEventListener('click', (e) => {
            const playBtn = e.target.closest('.play-pause-btn');
            if (playBtn) {
                const card = playBtn.closest('.verse-card');
                const url = playBtn.dataset.audioUrl;
                if (currentlyPlaying.button === playBtn) {
                    if (audioPlayer.paused) audioPlayer.play();
                    else audioPlayer.pause();
                } else {
                    playAudio(playBtn, card, url);
                }
            }
        });

        // --- Touch Highlight Logic ---
        const showTooltip = (element) => {
            const translation = element.dataset.translation.replace(/<[^>]*>/g, '');
            wordTooltip.textContent = translation;
            wordTooltip.style.display = 'block';
            const rect = element.getBoundingClientRect();
            wordTooltip.style.left = `${rect.left + rect.width / 2 - wordTooltip.offsetWidth / 2}px`;
            wordTooltip.style.top = `${rect.top - wordTooltip.offsetHeight - 8}px`; 
        };

        const hideTooltip = () => wordTooltip.style.display = 'none';

        const clearTapHighlight = () => {
            if (tapTimer) clearTimeout(tapTimer);
            if (tapHighlightWord) tapHighlightWord.classList.remove('highlight');
            tapTimer = null;
            tapHighlightWord = null;
        };

        versesContainer.addEventListener('touchstart', (e) => {
            isSwiping = false; 
            clearTapHighlight();
            if(!audioPlayer.paused && audioQueue.length === 0) audioPlayer.pause();
        }, { passive: true });

        versesContainer.addEventListener('touchmove', (e) => {
            isSwiping = true;
            const touch = e.touches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);

            if (liveHighlightWord && liveHighlightWord !== element) {
                liveHighlightWord.classList.remove('highlight');
            }

            if (element && element.classList.contains('arabic-word')) {
                element.classList.add('highlight');
                liveHighlightWord = element;
                showTooltip(element);
            } else {
                hideTooltip();
                if (liveHighlightWord) {
                    liveHighlightWord.classList.remove('highlight');
                    liveHighlightWord = null;
                }
            }
        }, { passive: true });

        versesContainer.addEventListener('touchend', (e) => {
            if (isSwiping) {
                if (liveHighlightWord) {
                    liveHighlightWord.classList.remove('highlight');
                    liveHighlightWord = null;
                }
                hideTooltip();
            } 
            else {
                const targetElement = e.target.closest('.arabic-word');
                if (targetElement) {
                    tapHighlightWord = targetElement;
                    tapHighlightWord.classList.add('highlight');
                    showTooltip(tapHighlightWord);

                    tapTimer = setTimeout(() => {
                        hideTooltip();
                        if (tapHighlightWord) {
                            tapHighlightWord.classList.remove('highlight');
                            tapHighlightWord = null;
                        }
                    }, 7000);
                }
            }
            isSwiping = false; 
        });
        
        versesContainer.addEventListener('touchcancel', () => {
             if (liveHighlightWord) {
                liveHighlightWord.classList.remove('highlight');
                liveHighlightWord = null;
            }
            hideTooltip();
            isSwiping = false;
        });

        // --- Theme Management ---
        function setTheme(themeName) {
            document.body.className = `theme-${themeName}`;
            localStorage.setItem('quranAppTheme', themeName);
            populateAppearanceModal(); 
        }

        function loadSavedSettings() {
            const savedTheme = localStorage.getItem('quranAppTheme') || 'paper';
            setTheme(savedTheme);
            selectedReciterId = parseInt(localStorage.getItem('quranAppReciter')) || 7;
        }

        // --- AI Chat Logic ---
        aiSubmitBtn.addEventListener('click', async () => {
            const userInput = aiInput.value.trim();
            if (!userInput) return;

            addMessageToChatBox('You', userInput);
            aiInput.value = '';
            addMessageToChatBox('Nur', 'Thinking...', true);

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: `You are Nur, a helpful and knowledgeable Islamic assistant. Answer the following question based on the principles of the Quran and Sunnah, in a respectful and informative tone. Question: ${userInput}` }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                let aiResponse = "Sorry, I couldn't process that. Please try again.";
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    aiResponse = result.candidates[0].content.parts[0].text;
                }
                updateLastMessage('Nur', aiResponse);

            } catch (error) {
                console.error("AI Error:", error);
                updateLastMessage('Nur', "Sorry, there was an error connecting to the AI service.");
            }
        });

        function addMessageToChatBox(sender, message, isLoading = false) {
            const messageDiv = document.createElement('div');
            const senderSpan = document.createElement('span');
            senderSpan.className = 'font-bold';
            senderSpan.textContent = `${sender}: `;
            
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            if (isLoading) {
                messageSpan.className = 'italic';
            }

            messageDiv.appendChild(senderSpan);
            messageDiv.appendChild(messageSpan);
            aiChatBox.appendChild(messageDiv);
            aiChatBox.scrollTop = aiChatBox.scrollHeight;
        }

        function updateLastMessage(sender, message) {
            const lastMessageDiv = aiChatBox.lastChild;
            if(lastMessageDiv) {
                lastMessageDiv.innerHTML = '';
                const senderSpan = document.createElement('span');
                senderSpan.className = 'font-bold';
                senderSpan.textContent = `${sender}: `;
                
                const messageSpan = document.createElement('span');
                messageSpan.textContent = message;

                lastMessageDiv.appendChild(senderSpan);
                lastMessageDiv.appendChild(messageSpan);
            }
        }


        // --- Start the App ---
        initializeApp();

        function getEmbeddedSurahList() {
            return [
                {"id":1,"name":"الفاتحة","transliteration":"Al-Fatihah","translation":"The Opener","type":"Meccan","total_verses":7},
                {"id":2,"name":"البقرة","transliteration":"Al-Baqarah","translation":"The Cow","type":"Medinan","total_verses":286},
                {"id":3,"name":"آل عمران","transliteration":"Aal-E-Imran","translation":"The Family of Imran","type":"Medinan","total_verses":200},
                {"id":4,"name":"النساء","transliteration":"An-Nisa","translation":"The Women","type":"Medinan","total_verses":176},
                {"id":5,"name":"المائدة","transliteration":"Al-Ma'idah","translation":"The Table Spread","type":"Medinan","total_verses":120},
                {"id":6,"name":"الأنعام","transliteration":"Al-An'am","translation":"The Cattle","type":"Meccan","total_verses":165},
                {"id":7,"name":"الأعراف","transliteration":"Al-A'raf","translation":"The Heights","type":"Meccan","total_verses":206},
                {"id":8,"name":"الأنفال","transliteration":"Al-Anfal","translation":"The Spoils of War","type":"Medinan","total_verses":75},
                {"id":9,"name":"التوبة","transliteration":"At-Tawbah","translation":"The Repentance","type":"Medinan","total_verses":129},
                {"id":10,"name":"يونس","transliteration":"Yunus","translation":"Jonah","type":"Meccan","total_verses":109},
                {"id":11,"name":"هود","transliteration":"Hud","translation":"Hud","type":"Meccan","total_verses":123},
                {"id":12,"name":"يوسف","transliteration":"Yusuf","translation":"Joseph","type":"Meccan","total_verses":111},
                {"id":13,"name":"الرعد","transliteration":"Ar-Ra'd","translation":"The Thunder","type":"Medinan","total_verses":43},
                {"id":14,"name":"ابراهيم","transliteration":"Ibrahim","translation":"Abraham","type":"Meccan","total_verses":52},
                {"id":15,"name":"الحجر","transliteration":"Al-Hijr","translation":"The Rocky Tract","type":"Meccan","total_verses":99},
                {"id":16,"name":"النحل","transliteration":"An-Nahl","translation":"The Bee","type":"Meccan","total_verses":128},
                {"id":17,"name":"الإسراء","transliteration":"Al-Isra","translation":"The Night Journey","type":"Meccan","total_verses":111},
                {"id":18,"name":"الكهف","transliteration":"Al-Kahf","translation":"The Cave","type":"Meccan","total_verses":110},
                {"id":19,"name":"مريم","transliteration":"Maryam","translation":"Mary","type":"Meccan","total_verses":98},
                {"id":20,"name":"طه","transliteration":"Taha","translation":"Ta-Ha","type":"Meccan","total_verses":135},
                {"id":21,"name":"الأنبياء","transliteration":"Al-Anbiya","translation":"The Prophets","type":"Meccan","total_verses":112},
                {"id":22,"name":"الحج","transliteration":"Al-Hajj","translation":"The Pilgrimage","type":"Medinan","total_verses":78},
                {"id":23,"name":"المؤمنون","transliteration":"Al-Mu'minun","translation":"The Believers","type":"Meccan","total_verses":118},
                {"id":24,"name":"النور","transliteration":"An-Nur","translation":"The Light","type":"Medinan","total_verses":64},
                {"id":25,"name":"الفرقان","transliteration":"Al-Furqan","translation":"The Criterion","type":"Meccan","total_verses":77},
                {"id":26,"name":"الشعراء","transliteration":"Ash-Shu'ara","translation":"The Poets","type":"Meccan","total_verses":227},
                {"id":27,"name":"النمل","transliteration":"An-Naml","translation":"The Ant","type":"Meccan","total_verses":93},
                {"id":28,"name":"القصص","transliteration":"Al-Qasas","translation":"The Stories","type":"Meccan","total_verses":88},
                {"id":29,"name":"العنكبوت","transliteration":"Al-'Ankabut","translation":"The Spider","type":"Meccan","total_verses":69},
                {"id":30,"name":"الروم","transliteration":"Ar-Rum","translation":"The Romans","type":"Meccan","total_verses":60},
                {"id":31,"name":"لقمان","transliteration":"Luqman","translation":"Luqman","type":"Meccan","total_verses":34},
                {"id":32,"name":"السجدة","transliteration":"As-Sajdah","translation":"The Prostration","type":"Meccan","total_verses":30},
                {"id":33,"name":"الأحزاب","transliteration":"Al-Ahzab","translation":"The Combined Forces","type":"Medinan","total_verses":73},
                {"id":34,"name":"سبإ","transliteration":"Saba","translation":"Sheba","type":"Meccan","total_verses":54},
                {"id":35,"name":"فاطر","transliteration":"Fatir","translation":"Originator","type":"Meccan","total_verses":45},
                {"id":36,"name":"يس","transliteration":"Ya-Sin","translation":"Ya Sin","type":"Meccan","total_verses":83},
                {"id":37,"name":"الصافات","transliteration":"As-Saffat","translation":"Those who set the Ranks","type":"Meccan","total_verses":182},
                {"id":38,"name":"ص","transliteration":"Sad","translation":"The Letter 'Saad'","type":"Meccan","total_verses":88},
                {"id":39,"name":"الزمر","transliteration":"Az-Zumar","translation":"The Troops","type":"Meccan","total_verses":75},
                {"id":40,"name":"غافر","transliteration":"Ghafir","translation":"The Forgiver","type":"Meccan","total_verses":85},
                {"id":41,"name":"فصلت","transliteration":"Fussilat","translation":"Explained in Detail","type":"Meccan","total_verses":54},
                {"id":42,"name":"الشورى","transliteration":"Ash-Shuraa","translation":"The Consultation","type":"Meccan","total_verses":53},
                {"id":43,"name":"الزخرف","transliteration":"Az-Zukhruf","translation":"The Ornaments of Gold","type":"Meccan","total_verses":89},
                {"id":44,"name":"الدخان","transliteration":"Ad-Dukhan","translation":"The Smoke","type":"Meccan","total_verses":59},
                {"id":45,"name":"الجاثية","transliteration":"Al-Jathiyah","translation":"The Crouching","type":"Meccan","total_verses":37},
                {"id":46,"name":"الأحقاف","transliteration":"Al-Ahqaf","translation":"The Wind-Curved Sandhills","type":"Meccan","total_verses":35},
                {"id":47,"name":"محمد","transliteration":"Muhammad","translation":"Muhammad","type":"Medinan","total_verses":38},
                {"id":48,"name":"الفتح","transliteration":"Al-Fath","translation":"The Victory","type":"Medinan","total_verses":29},
                {"id":49,"name":"الحجرات","transliteration":"Al-Hujurat","translation":"The Rooms","type":"Medinan","total_verses":18},
                {"id":50,"name":"ق","transliteration":"Qaf","translation":"The Letter 'Qaf'","type":"Meccan","total_verses":45},
                {"id":51,"name":"الذاريات","transliteration":"Adh-Dhariyat","translation":"The Winnowing Winds","type":"Meccan","total_verses":60},
                {"id":52,"name":"الطور","transliteration":"At-Tur","translation":"The Mount","type":"Meccan","total_verses":49},
                {"id":53,"name":"النجم","transliteration":"An-Najm","translation":"The Star","type":"Meccan","total_verses":62},
                {"id":54,"name":"القمر","transliteration":"Al-Qamar","translation":"The Moon","type":"Meccan","total_verses":55},
                {"id":55,"name":"الرحمن","transliteration":"Ar-Rahman","translation":"The Beneficent","type":"Medinan","total_verses":78},
                {"id":56,"name":"الواقعة","transliteration":"Al-Waqi'ah","translation":"The Inevitable","type":"Meccan","total_verses":96},
                {"id":57,"name":"الحديد","transliteration":"Al-Hadid","translation":"The Iron","type":"Medinan","total_verses":29},
                {"id":58,"name":"المجادلة","transliteration":"Al-Mujadila","translation":"The Pleading Woman","type":"Medinan","total_verses":22},
                {"id":59,"name":"الحشر","transliteration":"Al-Hashr","translation":"The Exile","type":"Medinan","total_verses":24},
                {"id":60,"name":"الممتحنة","transliteration":"Al-Mumtahanah","translation":"She that is to be examined","type":"Medinan","total_verses":13},
                {"id":61,"name":"الصف","transliteration":"As-Saf","translation":"The Ranks","type":"Medinan","total_verses":14},
                {"id":62,"name":"الجمعة","transliteration":"Al-Jumu'ah","translation":"The Congregation, Friday","type":"Medinan","total_verses":11},
                {"id":63,"name":"المنافقون","transliteration":"Al-Munafiqun","translation":"The Hypocrites","type":"Medinan","total_verses":11},
                {"id":64,"name":"التغابن","transliteration":"At-Taghabun","translation":"The Mutual Disillusion","type":"Medinan","total_verses":18},
                {"id":65,"name":"الطلاق","transliteration":"At-Talaq","translation":"The Divorce","type":"Medinan","total_verses":12},
                {"id":66,"name":"التحريم","transliteration":"At-Tahrim","translation":"The Prohibition","type":"Medinan","total_verses":12},
                {"id":67,"name":"الملك","transliteration":"Al-Mulk","translation":"The Sovereignty","type":"Meccan","total_verses":30},
                {"id":68,"name":"القلم","transliteration":"Al-Qalam","translation":"The Pen","type":"Meccan","total_verses":52},
                {"id":69,"name":"الحاقة","transliteration":"Al-Haqqah","translation":"The Reality","type":"Meccan","total_verses":52},
                {"id":70,"name":"المعارج","transliteration":"Al-Ma'arij","translation":"The Ascending Stairways","type":"Meccan","total_verses":44},
                {"id":71,"name":"نوح","transliteration":"Nuh","translation":"Noah","type":"Meccan","total_verses":28},
                {"id":72,"name":"الجن","transliteration":"Al-Jinn","translation":"The Jinn","type":"Meccan","total_verses":28},
                {"id":73,"name":"المزمل","transliteration":"Al-Muzzammil","translation":"The Enshrouded One","type":"Meccan","total_verses":20},
                {"id":74,"name":"المدثر","transliteration":"Al-Muddaththir","translation":"The Cloaked One","type":"Meccan","total_verses":56},
                {"id":75,"name":"القيامة","transliteration":"Al-Qiyamah","translation":"The Resurrection","type":"Meccan","total_verses":40},
                {"id":76,"name":"الانسان","transliteration":"Al-Insan","translation":"The Man","type":"Medinan","total_verses":31},
                {"id":77,"name":"المرسلات","transliteration":"Al-Mursalat","translation":"The Emissaries","type":"Meccan","total_verses":50},
                {"id":78,"name":"النبإ","transliteration":"An-Naba","translation":"The Tidings","type":"Meccan","total_verses":40},
                {"id":79,"name":"النازعات","transliteration":"An-Nazi'at","translation":"Those who drag forth","type":"Meccan","total_verses":46},
                {"id":80,"name":"عبس","transliteration":"'Abasa","translation":"He Frowned","type":"Meccan","total_verses":42},
                {"id":81,"name":"التكوير","transliteration":"At-Takwir","translation":"The Overthrowing","type":"Meccan","total_verses":29},
                {"id":82,"name":"الإنفطار","transliteration":"Al-Infitar","translation":"The Cleaving","type":"Meccan","total_verses":19},
                {"id":83,"name":"المطففين","transliteration":"Al-Mutaffifin","translation":"The Defrauding","type":"Meccan","total_verses":36},
                {"id":84,"name":"الإنشقاق","transliteration":"Al-Inshiqaq","translation":"The Splitting Asunder","type":"Meccan","total_verses":25},
                {"id":85,"name":"البروج","transliteration":"Al-Buruj","translation":"The Mansions of the Stars","type":"Meccan","total_verses":22},
                {"id":86,"name":"الطارق","transliteration":"At-Tariq","translation":"The Nightcommer","type":"Meccan","total_verses":17},
                {"id":87,"name":"الأعلى","transliteration":"Al-A'la","translation":"The Most High","type":"Meccan","total_verses":19},
                {"id":88,"name":"الغاشية","transliteration":"Al-Ghashiyah","translation":"The Overwhelming","type":"Meccan","total_verses":26},
                {"id":89,"name":"الفجر","transliteration":"Al-Fajr","translation":"The Dawn","type":"Meccan","total_verses":30},
                {"id":90,"name":"البلد","transliteration":"Al-Balad","translation":"The City","type":"Meccan","total_verses":20},
                {"id":91,"name":"الشمس","transliteration":"Ash-Shams","translation":"The Sun","type":"Meccan","total_verses":15},
                {"id":92,"name":"الليل","transliteration":"Al-Layl","translation":"The Night","type":"Meccan","total_verses":21},
                {"id":93,"name":"الضحى","transliteration":"Ad-Duhaa","translation":"The Morning Hours","type":"Meccan","total_verses":11},
                {"id":94,"name":"الشرح","transliteration":"Ash-Sharh","translation":"The Relief","type":"Meccan","total_verses":8},
                {"id":95,"name":"التين","transliteration":"At-Tin","translation":"The Fig","type":"Meccan","total_verses":8},
                {"id":96,"name":"العلق","transliteration":"Al-'Alaq","translation":"The Clot","type":"Meccan","total_verses":19},
                {"id":97,"name":"القدر","transliteration":"Al-Qadr","translation":"The Power","type":"Meccan","total_verses":5},
                {"id":98,"name":"البينة","transliteration":"Al-Bayyinah","translation":"The Clear Proof","type":"Medinan","total_verses":8},
                {"id":99,"name":"الزلزلة","transliteration":"Az-Zalzalah","translation":"The Earthquake","type":"Medinan","total_verses":8},
                {"id":100,"name":"العاديات","transliteration":"Al-'Adiyat","translation":"The Courser","type":"Meccan","total_verses":11},
                {"id":101,"name":"القارعة","transliteration":"Al-Qari'ah","translation":"The Calamity","type":"Meccan","total_verses":11},
                {"id":102,"name":"التكاثر","transliteration":"At-Takathur","translation":"The Rivalry in world increase","type":"Meccan","total_verses":8},
                {"id":103,"name":"العصر","transliteration":"Al-'Asr","translation":"The Declining Day","type":"Meccan","total_verses":3},
                {"id":104,"name":"الهمزة","transliteration":"Al-Humazah","translation":"The Traducer","type":"Meccan","total_verses":9},
                {"id":105,"name":"الفيل","transliteration":"Al-Fil","translation":"The Elephant","type":"Meccan","total_verses":5},
                {"id":106,"name":"قريش","transliteration":"Quraysh","translation":"Quraysh","type":"Meccan","total_verses":4},
                {"id":107,"name":"الماعون","transliteration":"Al-Ma'un","translation":"The Small kindnesses","type":"Meccan","total_verses":7},
                {"id":108,"name":"الكوثر","transliteration":"Al-Kawthar","translation":"The Abundance","type":"Meccan","total_verses":3},
                {"id":109,"name":"الكافرون","transliteration":"Al-Kafirun","translation":"The Disbelievers","type":"Meccan","total_verses":6},
                {"id":110,"name":"النصر","transliteration":"An-Nasr","translation":"The Divine Support","type":"Medinan","total_verses":3},
                {"id":111,"name":"المسد","transliteration":"Al-Masad","translation":"The Palm Fiber","type":"Meccan","total_verses":5},
                {"id":112,"name":"الإخلاص","transliteration":"Al-Ikhlas","translation":"The Sincerity","type":"Meccan","total_verses":4},
                {"id":113,"name":"الفلق","transliteration":"Al-Falaq","translation":"The Daybreak","type":"Meccan","total_verses":5},
                {"id":114,"name":"الناس","transliteration":"An-Nas","translation":"Mankind","type":"Meccan","total_verses":6}
            ];
        }
    });
    </script>
</body>
</html>
