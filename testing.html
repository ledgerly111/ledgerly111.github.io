<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ledgerly - Smart Business Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/big.js@6.2.1/big.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f2e;
            --bg-tertiary: #242938;
            --text-primary: #ffffff;
            --text-secondary: #b4bcd0;
            --text-muted: #6b7280;
            --accent-primary: #00d4aa;
            --accent-secondary: #0ea5e9;
            --border-color: #374151;
            --hover-bg: #1f2937;
            --ai-color: #8b5cf6;
            --bot-color: #10b981;
            --positive-color: #3b82f6;
            --negative-color: #ef4444;
            --gold-color: #f59e0b;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .navbar {
            background: linear-gradient(90deg, var(--bg-secondary) 0%, rgba(26, 31, 46, 0.95) 100%);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .main-content {
            flex: 1;
            padding: 1rem;
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
        }

        .mobile-sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, var(--bg-tertiary) 0%, rgba(36, 41, 56, 0.95) 100%);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--border-color);
            transition: left 0.3s ease;
            z-index: 2000;
            overflow-y: auto;
        }

        .mobile-sidebar.open {
            left: 0;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .sidebar-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .desktop-sidebar {
            display: none;
        }

        @media (min-width: 1024px) {
            .main-content {
                margin-left: 280px;
                padding: 2rem;
            }
            
            .mobile-sidebar {
                display: none;
            }
            
            .desktop-sidebar {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                width: 280px;
                height: 100vh;
                background: linear-gradient(180deg, var(--bg-tertiary) 0%, rgba(36, 41, 56, 0.95) 100%);
                backdrop-filter: blur(10px);
                border-right: 1px solid var(--border-color);
                overflow-y: auto;
                z-index: 100;
            }
            
            .navbar {
                margin-left: 280px;
            }
        }

        .burger-menu {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: rgba(55, 65, 81, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .burger-menu:hover {
            background: rgba(75, 85, 99, 0.8);
            border-color: var(--accent-primary);
        }

        @media (min-width: 1024px) {
            .burger-menu {
                display: none;
            }
        }

        .perplexity-card {
            background: rgba(36, 41, 56, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }

        .perplexity-card:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
            transform: translateY(-2px);
        }

        .perplexity-button {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 212, 170, 0.3);
            min-height: 44px;
            padding: 12px 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .perplexity-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 170, 0.4);
        }

        .menu-item {
            width: 100%;
            text-align: left;
            padding: 16px 20px;
            border-radius: 12px;
            transition: all 0.3s ease;
            color: #d1d5db;
            border: none;
            background: none;
            display: flex;
            align-items: center;
            font-size: 16px;
            min-height: 56px;
            cursor: pointer;
        }

        .menu-item:hover {
            color: white;
            background: rgba(55, 65, 81, 0.6);
        }

        .menu-item.active {
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.2), rgba(14, 165, 233, 0.2));
            color: var(--accent-primary);
            border: 1px solid rgba(0, 212, 170, 0.3);
            box-shadow: 0 4px 15px rgba(0, 212, 170, 0.2);
        }

        .menu-item i {
            width: 24px;
            margin-right: 12px;
            font-size: 18px;
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            pointer-events: none;
        }

        .notification {
            background: rgba(36, 41, 56, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            min-width: 280px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideInNotification 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification.success {
            border-left: 4px solid var(--positive-color);
        }

        .notification.error {
            border-left: 4px solid var(--negative-color);
        }

        @keyframes slideInNotification {
            from {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        .form-input {
            background: rgba(15, 20, 25, 0.8) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-primary) !important;
            border-radius: 12px;
            padding: 12px 16px;
            transition: all 0.2s ease;
            min-height: 44px;
            font-size: 16px;
        }

        .form-input:focus {
            border-color: var(--accent-primary) !important;
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1) !important;
            background: rgba(15, 20, 25, 0.9) !important;
            outline: none !important;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 16px;
        }

        .modal-content {
            background: rgba(36, 41, 56, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 32px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        }

        .user-selection-card {
            background: rgba(36, 41, 56, 0.8);
            border: 2px solid transparent;
            border-radius: 20px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 24px;
        }

        .user-selection-card:hover {
            border-color: var(--accent-primary);
            background: rgba(36, 41, 56, 0.95);
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 212, 170, 0.3);
        }

        .gradient-text {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body>
    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>
    
    <!-- Mobile Sidebar Overlay -->
    <div id="sidebar-overlay" class="sidebar-overlay" onclick="app.toggleMobileSidebar()"></div>
    
    <div id="app" class="app-container"></div>

    <script>
        // 🛡️ CRITICAL FIX #1: Global Error Handlers - Prevents ALL crashes
        window.addEventListener('error', function(event) {
            console.error('💥 Global error caught:', event.error);
            if (window.NotificationSystem) {
                NotificationSystem.error('An error occurred, but the app continues working.');
            }
            event.preventDefault();
            return true;
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('💥 Unhandled promise rejection:', event.reason);
            if (window.NotificationSystem) {
                NotificationSystem.error('Operation failed, but the app continues working.');
            }
            event.preventDefault();
        });

        // 🛡️ CRITICAL FIX #2: Safe Big.js Configuration
        let BigMath = null;
        
        function initializeBigMath() {
            try {
                if (typeof Big !== 'undefined') {
                    BigMath = Big;
                    Big.DP = 2; // 2 decimal places
                    Big.RM = 1; // ROUND_HALF_UP
                    console.log('✅ Big.js initialized successfully');
                    return true;
                } else {
                    console.warn('⚠️ Big.js not loaded, using fallback math');
                    return false;
                }
            } catch (error) {
                console.error('❌ Big.js initialization failed:', error);
                return false;
            }
        }

        // 🛡️ CRITICAL FIX #3: Bulletproof Money Utilities
        class MoneyUtils {
            static toCents(dollarAmount) {
                try {
                    const amount = parseFloat(dollarAmount) || 0;
                    if (BigMath) {
                        return new BigMath(amount).times(100).round(0, 0).toNumber();
                    }
                    return Math.round(amount * 100);
                } catch (error) {
                    console.error('MoneyUtils.toCents error:', error);
                    return Math.round((parseFloat(dollarAmount) || 0) * 100);
                }
            }

            static fromCents(centsAmount) {
                try {
                    const cents = parseInt(centsAmount) || 0;
                    if (BigMath) {
                        return new BigMath(cents).div(100).toNumber();
                    }
                    return cents / 100;
                } catch (error) {
                    console.error('MoneyUtils.fromCents error:', error);
                    return (parseInt(centsAmount) || 0) / 100;
                }
            }

            static add(amount1Cents, amount2Cents) {
                try {
                    const a1 = parseInt(amount1Cents) || 0;
                    const a2 = parseInt(amount2Cents) || 0;
                    if (BigMath) {
                        return new BigMath(a1).plus(a2).toNumber();
                    }
                    return a1 + a2;
                } catch (error) {
                    console.error('MoneyUtils.add error:', error);
                    return (parseInt(amount1Cents) || 0) + (parseInt(amount2Cents) || 0);
                }
            }

            static subtract(amount1Cents, amount2Cents) {
                try {
                    const a1 = parseInt(amount1Cents) || 0;
                    const a2 = parseInt(amount2Cents) || 0;
                    if (BigMath) {
                        return new BigMath(a1).minus(a2).toNumber();
                    }
                    return a1 - a2;
                } catch (error) {
                    console.error('MoneyUtils.subtract error:', error);
                    return (parseInt(amount1Cents) || 0) - (parseInt(amount2Cents) || 0);
                }
            }

            static multiply(amountCents, factor) {
                try {
                    const amount = parseInt(amountCents) || 0;
                    const mult = parseFloat(factor) || 0;
                    if (BigMath) {
                        return new BigMath(amount).times(mult).round(0, 0).toNumber();
                    }
                    return Math.round(amount * mult);
                } catch (error) {
                    console.error('MoneyUtils.multiply error:', error);
                    return Math.round((parseInt(amountCents) || 0) * (parseFloat(factor) || 0));
                }
            }
        }

        // 🛡️ CRITICAL FIX #4: Bulletproof Notification System
        class NotificationSystem {
            static show(message, type = 'info', duration = 4000) {
                try {
                    const container = document.getElementById('notification-container');
                    if (!container) {
                        console.log('Notification:', message);
                        return;
                    }
                    
                    const notification = document.createElement('div');
                    notification.className = `notification ${type}`;
                    
                    const icons = {
                        success: 'fas fa-check-circle',
                        error: 'fas fa-exclamation-circle',
                        warning: 'fas fa-exclamation-triangle',
                        info: 'fas fa-info-circle'
                    };
                    
                    const colors = {
                        success: 'text-green-400',
                        error: 'text-red-400',
                        warning: 'text-yellow-400',
                        info: 'text-blue-400'
                    };
                    
                    notification.innerHTML = `
                        <i class="${icons[type]} ${colors[type]} text-lg"></i>
                        <div class="flex-1">
                            <p class="text-white font-medium text-sm">${message}</p>
                        </div>
                        <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-white transition-colors ml-2">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    container.appendChild(notification);
                    
                    setTimeout(() => {
                        try {
                            if (notification && notification.parentElement) {
                                notification.remove();
                            }
                        } catch (cleanupError) {
                            console.log('Notification cleanup error (harmless):', cleanupError);
                        }
                    }, duration);
                } catch (error) {
                    console.error('Notification system error:', error);
                    console.log('Fallback notification:', message);
                }
            }
            
            static success(message) { this.show(message, 'success'); }
            static error(message) { this.show(message, 'error'); }
            static warning(message) { this.show(message, 'warning'); }
            static info(message) { this.show(message, 'info'); }
        }

        // 🛡️ CRITICAL FIX #5: Bulletproof Data Storage
        class DataStorage {
            static save(key, data) {
                try {
                    const safeData = JSON.parse(JSON.stringify(data)); // Deep clone to avoid circular references
                    const dataString = JSON.stringify(safeData);
                    localStorage.setItem(key, dataString);
                    return true;
                } catch (error) {
                    console.error('Storage failed:', error);
                    NotificationSystem.error('Data save failed (app continues working)');
                    return false;
                }
            }
            
            static load(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error('Data loading failed:', error);
                    return null;
                }
            }
        }

        // 🚀 MAIN APPLICATION - BULLETPROOF VERSION
        const app = {
            currentSaleCart: [],
            charts: {},
            
            // 🛡️ CRITICAL FIX #6: Immutable State Management
            state: {
                currentUser: null,
                currentView: 'login',
                mobileMenuOpen: false,
                companyName: 'Your Company',
                users: [
                    { 
                        id: crypto.randomUUID(), 
                        username: 'admin', 
                        role: 'admin', 
                        name: 'Administrator', 
                        email: 'admin@company.com',
                        salaryCents: MoneyUtils.toCents(75000), 
                        commissionCents: 0 
                    },
                    { 
                        id: crypto.randomUUID(), 
                        username: 'manager', 
                        role: 'manager', 
                        name: 'John Manager', 
                        email: 'manager@company.com',
                        salaryCents: MoneyUtils.toCents(60000), 
                        commissionCents: 0 
                    },
                    { 
                        id: crypto.randomUUID(), 
                        username: 'worker', 
                        role: 'worker', 
                        name: 'Jane Worker', 
                        email: 'worker@company.com',
                        salaryCents: MoneyUtils.toCents(45000), 
                        commissionCents: MoneyUtils.toCents(250) 
                    }
                ],
                products: [
                    { 
                        id: crypto.randomUUID(), 
                        name: 'Premium Laptop', 
                        priceCents: MoneyUtils.toCents(1299.99), 
                        costCents: MoneyUtils.toCents(800), 
                        stock: 25, 
                        category: 'Electronics'
                    },
                    { 
                        id: crypto.randomUUID(), 
                        name: 'Wireless Mouse', 
                        priceCents: MoneyUtils.toCents(49.99), 
                        costCents: MoneyUtils.toCents(25), 
                        stock: 100, 
                        category: 'Accessories'
                    },
                    { 
                        id: crypto.randomUUID(), 
                        name: 'USB-C Hub', 
                        priceCents: MoneyUtils.toCents(79.99), 
                        costCents: MoneyUtils.toCents(40), 
                        stock: 8, 
                        category: 'Accessories'
                    }
                ],
                customers: [
                    { 
                        id: crypto.randomUUID(), 
                        name: 'Emirates Tech Solutions', 
                        email: 'contact@emirates-tech.com', 
                        phone: '+971501234570', 
                        type: 'Business'
                    },
                    { 
                        id: crypto.randomUUID(), 
                        name: 'Ahmed Al Rashid', 
                        email: 'ahmed.alrashid@email.com', 
                        phone: '+971501234571', 
                        type: 'Individual'
                    }
                ],
                sales: [],
                expenses: []
            },

            // 🛡️ CRITICAL FIX #7: Safe Initialization
            init() {
                try {
                    console.log('🚀 Initializing Ledgerly...');
                    
                    // Initialize Big.js
                    initializeBigMath();
                    
                    // Load saved data
                    this.loadData();
                    
                    // Bind events
                    this.bindEvents();
                    
                    // Initial render
                    this.render();
                    
                    NotificationSystem.success('✅ Ledgerly loaded successfully!');
                    console.log('✅ App initialized successfully');
                } catch (error) {
                    console.error('❌ Initialization error:', error);
                    this.renderError('Initialization failed. Please refresh the page.');
                }
            },

            // 🛡️ CRITICAL FIX #8: Safe Data Operations
            loadData() {
                try {
                    const saved = DataStorage.load('ledgerlyData');
                    if (saved && typeof saved === 'object') {
                        // Use immutable update
                        this.state = { ...this.state, ...saved };
                        console.log('📂 Data loaded from storage');
                    }
                } catch (error) {
                    console.error('Data loading error:', error);
                }
            },

            saveData() {
                try {
                    return DataStorage.save('ledgerlyData', this.state);
                } catch (error) {
                    console.error('Data saving error:', error);
                    return false;
                }
            },

            // 🛡️ CRITICAL FIX #9: Safe Event Binding
            bindEvents() {
                try {
                    // Remove existing listeners to prevent accumulation
                    document.removeEventListener('click', this.clickHandler);
                    document.removeEventListener('submit', this.submitHandler);
                    
                    // Bind new listeners
                    this.clickHandler = this.handleClick.bind(this);
                    this.submitHandler = this.handleSubmit.bind(this);
                    
                    document.addEventListener('click', this.clickHandler);
                    document.addEventListener('submit', this.submitHandler);
                    
                    console.log('🎯 Event listeners bound successfully');
                } catch (error) {
                    console.error('Event binding error:', error);
                }
            },

            // 🛡️ CRITICAL FIX #10: Safe Click Handler
            handleClick(e) {
                try {
                    if (e.target.matches('[data-action]') || e.target.closest('[data-action]')) {
                        const actionElement = e.target.matches('[data-action]') ? e.target : e.target.closest('[data-action]');
                        const action = actionElement.getAttribute('data-action');
                        const id = actionElement.getAttribute('data-id');
                        this.handleAction(action, id, e);
                    }
                } catch (clickError) {
                    console.error('Click handler error:', clickError);
                    NotificationSystem.error('Click failed - app continues working');
                }
            },

            // 🛡️ CRITICAL FIX #11: Safe Submit Handler
            handleSubmit(e) {
                try {
                    e.preventDefault();
                    const formId = e.target.id;
                    this.handleFormSubmit(formId, e.target);
                } catch (submitError) {
                    console.error('Submit handler error:', submitError);
                    NotificationSystem.error('Form submission failed - please try again');
                }
            },

            // 🛡️ CRITICAL FIX #12: Safe Action Handler
            handleAction(action, id, event) {
                try {
                    console.log('🎯 Action triggered:', action);
                    
                    const actions = {
                        'login-admin': () => this.selectUser('admin'),
                        'login-manager': () => this.selectUser('manager'),
                        'login-worker': () => this.selectUser('worker'),
                        'logout': () => this.logout(),
                        'toggle-mobile-menu': () => this.toggleMobileSidebar(),
                        'dashboard': () => this.navigateToView('dashboard'),
                        'products': () => this.navigateToView('products'),
                        'customers': () => this.navigateToView('customers'),
                        'sales': () => this.navigateToView('sales'),
                        'expenses': () => this.navigateToView('expenses'),
                        'employees': () => this.navigateToView('employees'),
                        'invoices': () => this.navigateToView('invoices'),
                        'reports': () => this.navigateToView('reports'),
                        'settings': () => this.navigateToView('settings'),
                        'inbox': () => this.navigateToView('inbox'),
                        'ai-assistant': () => this.navigateToView('ai-assistant'),
                        'add-sale': () => this.showModal('add-sale'),
                        'close-modal': () => this.closeModal()
                    };

                    if (actions[action]) {
                        actions[action]();
                    } else {
                        console.warn('Unknown action:', action);
                    }
                } catch (error) {
                    console.error('Action handler error:', error);
                    NotificationSystem.error('Action failed - app continues working');
                }
            },

            // 🛡️ CRITICAL FIX #13: Bulletproof Form Submission
            handleFormSubmit(formId, form) {
                try {
                    console.log('📝 Form submitted:', formId);
                    
                    if (formId === 'sale-form') {
                        this.handleSaleForm(form);
                    } else {
                        console.warn('Unknown form:', formId);
                    }
                } catch (error) {
                    console.error('Form submission error:', error);
                    NotificationSystem.error('Form submission failed - check your input');
                }
            },

            // 🚀 CRITICAL FIX #14: Completely Rewritten Sale Processing
            handleSaleForm(form) {
                try {
                    console.log('💰 Processing sale form...');
                    
                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData.entries());
                    
                    console.log('📋 Form data:', data);
                    
                    // Validate required fields
                    if (!data.customerId) {
                        throw new Error('Please select a customer');
                    }
                    
                    if (!this.currentSaleCart || this.currentSaleCart.length === 0) {
                        throw new Error('Please add at least one product to the sale');
                    }

                    console.log('🛒 Current cart:', this.currentSaleCart);

                    // Calculate totals safely
                    let totalCents = 0;
                    const processedItems = [];
                    
                    for (let i = 0; i < this.currentSaleCart.length; i++) {
                        try {
                            const item = this.currentSaleCart[i];
                            const itemTotal = MoneyUtils.multiply(item.unitPriceCents || 0, item.quantity || 0);
                            totalCents = MoneyUtils.add(totalCents, itemTotal);
                            
                            processedItems.push({
                                id: crypto.randomUUID(),
                                productId: item.productId,
                                productName: item.name || 'Unknown Product',
                                quantity: item.quantity || 0,
                                unitPriceCents: item.unitPriceCents || 0,
                                totalCents: itemTotal
                            });
                        } catch (itemError) {
                            console.error('Item processing error:', itemError);
                            // Skip this item and continue
                        }
                    }

                    if (processedItems.length === 0) {
                        throw new Error('No valid items in cart');
                    }

                    console.log('💵 Calculated total cents:', totalCents);

                    // Get customer info safely
                    const customer = this.state.customers.find(c => c.id === data.customerId);
                    const customerName = customer ? customer.name : 'Unknown Customer';

                    // Create sale record
                    const sale = {
                        id: crypto.randomUUID(),
                        customerId: data.customerId,
                        customerName: customerName,
                        items: processedItems,
                        totalCents: totalCents,
                        date: data.date || new Date().toISOString().split('T')[0],
                        saleType: data.saleType || 'Cash',
                        salesPersonId: this.state.currentUser?.id || 'unknown',
                        salesPersonName: this.state.currentUser?.name || 'Unknown',
                        createdAt: new Date().toISOString()
                    };

                    console.log('💾 Sale record created:', sale);

                    // 🛡️ IMMUTABLE STATE UPDATE - CRITICAL FIX
                    this.state = {
                        ...this.state,
                        sales: [...(this.state.sales || []), sale]
                    };
                    
                    console.log('📊 Updated sales array length:', this.state.sales.length);

                    // Clear cart
                    this.currentSaleCart = [];

                    // Save data
                    const saved = this.saveData();
                    console.log('💾 Data saved:', saved);

                    // Close modal and refresh UI
                    this.closeModal();
                    this.render();
                    
                    const formattedAmount = `$${MoneyUtils.fromCents(totalCents).toFixed(2)}`;
                    NotificationSystem.success(`🎉 Sale recorded successfully! Total: ${formattedAmount}`);
                    
                    console.log('✅ Sale processing completed successfully');
                    
                } catch (error) {
                    console.error('❌ Sale form processing error:', error);
                    NotificationSystem.error(`❌ ${error.message}`);
                    
                    // Don't let the error crash the app - continue working
                    try {
                        // Clear any problematic state
                        if (error.message.includes('cart')) {
                            this.currentSaleCart = [];
                            this.updateSaleCart();
                        }
                    } catch (recoveryError) {
                        console.error('Recovery error (harmless):', recoveryError);
                    }
                }
            },

            // 🛡️ CRITICAL FIX #15: Safe Cart Operations
            addToSaleCart() {
                try {
                    console.log('🛒 Adding to cart...');
                    
                    const productSelect = document.getElementById('product-select');
                    const quantityInput = document.getElementById('quantity-input');
                    
                    if (!productSelect || !quantityInput) {
                        throw new Error('Form elements not found');
                    }
                    
                    const productId = productSelect.value;
                    const quantity = parseInt(quantityInput.value) || 0;
                    
                    console.log('📦 Product ID:', productId, 'Quantity:', quantity);
                    
                    if (!productId || quantity <= 0) {
                        throw new Error('Please select a product and enter valid quantity');
                    }
                    
                    const product = this.state.products.find(p => p.id === productId);
                    if (!product) {
                        throw new Error('Product not found');
                    }
                    
                    if (quantity > product.stock) {
                        throw new Error(`Only ${product.stock} units available in stock`);
                    }
                    
                    // Initialize cart if needed
                    if (!Array.isArray(this.currentSaleCart)) {
                        this.currentSaleCart = [];
                    }
                    
                    const cartItem = {
                        id: crypto.randomUUID(),
                        productId: product.id,
                        name: product.name,
                        quantity: quantity,
                        unitPriceCents: product.priceCents || 0
                    };
                    
                    this.currentSaleCart.push(cartItem);
                    
                    console.log('✅ Added to cart:', cartItem);
                    console.log('🛒 Cart contents:', this.currentSaleCart);
                    
                    this.updateSaleCart();
                    
                    // Clear inputs
                    productSelect.value = '';
                    quantityInput.value = '';
                    
                    NotificationSystem.success(`✅ ${product.name} added to cart`);
                    
                } catch (error) {
                    console.error('Add to cart error:', error);
                    NotificationSystem.error(`❌ ${error.message}`);
                }
            },

            updateSaleCart() {
                try {
                    const cartContainer = document.getElementById('sale-cart');
                    if (!cartContainer) return;
                    
                    if (!Array.isArray(this.currentSaleCart) || this.currentSaleCart.length === 0) {
                        cartContainer.innerHTML = '<p class="text-gray-400 text-center py-4">🛒 No items added yet</p>';
                        return;
                    }
                    
                    let total = 0;
                    const cartHtml = this.currentSaleCart.map((item, index) => {
                        const itemTotal = MoneyUtils.multiply(item.unitPriceCents || 0, item.quantity || 0);
                        total = MoneyUtils.add(total, itemTotal);
                        
                        return `
                            <div class="flex justify-between items-center bg-gray-600/30 p-3 rounded-lg mb-2">
                                <div>
                                    <p class="text-white font-medium">${item.name || 'Unknown Product'}</p>
                                    <p class="text-gray-400 text-sm">Qty: ${item.quantity || 0} × $${MoneyUtils.fromCents(item.unitPriceCents || 0).toFixed(2)}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-green-400 font-bold">$${MoneyUtils.fromCents(itemTotal).toFixed(2)}</span>
                                    <button type="button" onclick="app.removeFromSaleCart(${index})" class="text-red-400 hover:text-red-300">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    cartContainer.innerHTML = `
                        <div>
                            ${cartHtml}
                            <div class="border-t border-gray-600 pt-3 mt-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-white font-bold">Total:</span>
                                    <span class="text-green-400 font-bold text-lg">$${MoneyUtils.fromCents(total).toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                } catch (error) {
                    console.error('Update cart error:', error);
                }
            },

            removeFromSaleCart(index) {
                try {
                    if (Array.isArray(this.currentSaleCart) && index >= 0 && index < this.currentSaleCart.length) {
                        const removedItem = this.currentSaleCart.splice(index, 1)[0];
                        this.updateSaleCart();
                        NotificationSystem.success(`✅ ${removedItem.name} removed from cart`);
                    }
                } catch (error) {
                    console.error('Remove from cart error:', error);
                    NotificationSystem.error('❌ Failed to remove item');
                }
            },

            // Navigation methods with error handling
            selectUser(role) {
                try {
                    const user = this.state.users.find(u => u.role === role);
                    if (user) {
                        // Immutable state update
                        this.state = { ...this.state, currentUser: user };
                        this.setView('dashboard');
                        NotificationSystem.success(`👋 Welcome back, ${user.name}!`);
                    }
                } catch (error) {
                    console.error('User selection error:', error);
                    NotificationSystem.error('Login failed - please try again');
                }
            },

            logout() {
                try {
                    // Immutable state update
                    this.state = { 
                        ...this.state, 
                        currentUser: null, 
                        currentView: 'login' 
                    };
                    this.render();
                    NotificationSystem.info('👋 Logged out successfully');
                } catch (error) {
                    console.error('Logout error:', error);
                }
            },

            navigateToView(view) {
                try {
                    this.setView(view);
                    if (window.innerWidth < 1024) {
                        this.closeMobileSidebar();
                    }
                } catch (error) {
                    console.error('Navigation error:', error);
                }
            },

            setView(view) {
                try {
                    // Immutable state update
                    this.state = { ...this.state, currentView: view };
                    this.render();
                } catch (error) {
                    console.error('Set view error:', error);
                }
            },

            toggleMobileSidebar() {
                try {
                    // Immutable state update
                    this.state = { ...this.state, mobileMenuOpen: !this.state.mobileMenuOpen };
                    const sidebar = document.getElementById('mobile-sidebar');
                    const overlay = document.getElementById('sidebar-overlay');
                    
                    if (this.state.mobileMenuOpen) {
                        sidebar?.classList.add('open');
                        overlay?.classList.add('open');
                    } else {
                        sidebar?.classList.remove('open');
                        overlay?.classList.remove('open');
                    }
                } catch (error) {
                    console.error('Toggle sidebar error:', error);
                }
            },

            closeMobileSidebar() {
                try {
                    // Immutable state update
                    this.state = { ...this.state, mobileMenuOpen: false };
                    const sidebar = document.getElementById('mobile-sidebar');
                    const overlay = document.getElementById('sidebar-overlay');
                    sidebar?.classList.remove('open');
                    overlay?.classList.remove('open');
                } catch (error) {
                    console.error('Close sidebar error:', error);
                }
            },

            // Modal operations with error handling
            showModal(type) {
                try {
                    const modal = this.getModal(type);
                    document.body.insertAdjacentHTML('beforeend', modal);
                } catch (error) {
                    console.error('Show modal error:', error);
                    NotificationSystem.error('❌ Failed to open modal');
                }
            },

            closeModal() {
                try {
                    const modal = document.querySelector('.modal-overlay');
                    if (modal) {
                        modal.remove();
                    }
                } catch (error) {
                    console.error('Close modal error:', error);
                }
            },

            // 🛡️ CRITICAL FIX #16: Bulletproof Rendering
            render() {
                try {
                    const appContainer = document.getElementById('app');
                    if (!appContainer) {
                        console.error('App container not found');
                        return;
                    }
                    
                    if (!this.state.currentUser) {
                        appContainer.innerHTML = this.getLoginView();
                        return;
                    }

                    const views = {
                        'dashboard': this.getDashboardView(),
                        'sales': this.getSalesView(),
                        'products': this.getProductsView(),
                        'customers': this.getCustomersView(),
                        'expenses': this.getExpensesView(),
                        'employees': this.getEmployeesView(),
                        'invoices': this.getInvoicesView(),
                        'reports': this.getReportsView(),
                        'settings': this.getSettingsView(),
                        'inbox': this.getInboxView(),
                        'ai-assistant': this.getAIAssistantView()
                    };

                    const currentViewHtml = views[this.state.currentView] || this.getDashboardView();

                    appContainer.innerHTML = `
                        ${this.getNavbar()}
                        ${this.getSidebar()}
                        <div class="main-content">
                            ${currentViewHtml}
                        </div>
                    `;
                    
                    console.log('✅ Render completed successfully');
                } catch (error) {
                    console.error('❌ Render error:', error);
                    this.renderError('Display error occurred - but app continues working');
                }
            },

            renderError(message) {
                try {
                    const appContainer = document.getElementById('app');
                    if (appContainer) {
                        appContainer.innerHTML = `
                            <div class="flex items-center justify-center min-h-screen">
                                <div class="text-center">
                                    <i class="fas fa-exclamation-triangle text-red-400 text-6xl mb-4"></i>
                                    <h3 class="text-xl font-bold text-white mb-2">⚠️ ${message}</h3>
                                    <div class="space-y-2">
                                        <button onclick="app.render()" class="bg-blue-600 text-white px-6 py-3 rounded-lg mr-2">
                                            🔄 Try Again
                                        </button>
                                        <button onclick="location.reload()" class="bg-gray-600 text-white px-6 py-3 rounded-lg">
                                            🔄 Refresh Page
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } catch (fatalError) {
                    console.error('Fatal render error:', fatalError);
                    location.reload();
                }
            },

            // View generators - All with error handling
            getLoginView() {
                return `
                    <div class="min-h-screen flex items-center justify-center p-4" style="background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 50%, #242938 100%);">
                        <div class="perplexity-card p-8 w-full max-w-md fade-in">
                            <div class="text-center mb-8">
                                <div class="mb-6">
                                    <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-r from-teal-500 to-blue-500 mb-4">
                                        <i class="fas fa-chart-line text-white text-3xl"></i>
                                    </div>
                                </div>
                                <h1 class="text-4xl font-bold gradient-text mb-2">Ledgerly</h1>
                                <p class="text-xl font-semibold text-gray-300 mb-1">Sales</p>
                                <p class="text-gray-400 mb-2">Business Management System</p>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="user-selection-card" data-action="login-admin">
                                    <div class="text-3xl mb-3">👑</div>
                                    <h3 class="text-xl font-bold text-white mb-2">Administrator</h3>
                                    <p class="text-gray-400 text-sm">Complete system control</p>
                                </div>
                                
                                <div class="user-selection-card" data-action="login-manager">
                                    <div class="text-3xl mb-3">👔</div>
                                    <h3 class="text-xl font-bold text-white mb-2">Manager</h3>
                                    <p class="text-gray-400 text-sm">Team leadership</p>
                                </div>
                                
                                <div class="user-selection-card" data-action="login-worker">
                                    <div class="text-3xl mb-3">👨‍💼</div>
                                    <h3 class="text-xl font-bold text-white mb-2">Sales Worker</h3>
                                    <p class="text-gray-400 text-sm">Sales management</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            getNavbar() {
                const userName = this.state.currentUser?.name || 'Unknown User';
                const userRole = this.state.currentUser?.role || 'user';
                const userInitial = userName.charAt(0).toUpperCase();

                return `
                    <div class="navbar">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <div class="burger-menu" data-action="toggle-mobile-menu">
                                    <i class="fas fa-bars text-white text-lg"></i>
                                </div>
                                
                                <div class="flex items-center space-x-3">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-teal-500 to-blue-500 flex items-center justify-center mr-3">
                                            <i class="fas fa-chart-line text-white text-lg"></i>
                                        </div>
                                        <div class="hidden sm:block">
                                            <h1 class="text-xl font-bold gradient-text leading-tight">Ledgerly</h1>
                                            <p class="text-xs text-gray-400 leading-none">Business System</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="hidden md:flex items-center space-x-4">
                                    <span class="text-gray-500">|</span>
                                    <div class="flex items-center space-x-3">
                                        <div class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center">
                                            <span class="text-white font-bold text-sm">${userInitial}</span>
                                        </div>
                                        <div>
                                            <p class="text-white font-medium text-sm">${userName}</p>
                                            <p class="text-xs text-gray-400 capitalize">${userRole}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-2">
                                <button data-action="logout" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span class="hidden sm:inline ml-2">Logout</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            getSidebar() {
                const menuItems = [
                    { key: 'dashboard', icon: 'fas fa-tachometer-alt', label: 'Dashboard' },
                    { key: 'sales', icon: 'fas fa-shopping-cart', label: 'Sales' },
                    { key: 'products', icon: 'fas fa-box', label: 'Products' },
                    { key: 'customers', icon: 'fas fa-users', label: 'Customers' },
                    { key: 'expenses', icon: 'fas fa-receipt', label: 'Expenses' },
                    { key: 'employees', icon: 'fas fa-user-tie', label: 'Employees' },
                    { key: 'invoices', icon: 'fas fa-file-invoice', label: 'Invoices' },
                    { key: 'reports', icon: 'fas fa-chart-bar', label: 'Reports' },
                    { key: 'settings', icon: 'fas fa-cog', label: 'Settings' },
                    { key: 'inbox', icon: 'fas fa-envelope', label: 'Inbox' },
                    { key: 'ai-assistant', icon: 'fas fa-robot', label: 'AI Assistant' }
                ];

                const sidebarContent = `
                    <div class="p-6">
                        <div class="mb-6">
                            <div class="flex items-center space-x-3 mb-6">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-r from-teal-500 to-blue-500 flex items-center justify-center">
                                    <i class="fas fa-chart-line text-white text-xl"></i>
                                </div>
                                <div>
                                    <h1 class="text-xl font-bold gradient-text">Ledgerly</h1>
                                    <p class="text-sm text-gray-400">Business System</p>
                                </div>
                            </div>
                        </div>
                        <ul class="space-y-2">
                            ${menuItems.map(item => `
                                <li>
                                    <button data-action="${item.key}" 
                                            class="menu-item ${this.state.currentView === item.key ? 'active' : ''}">
                                        <i class="${item.icon}"></i>
                                        <span class="font-medium">${item.label}</span>
                                    </button>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;

                return `
                    <div id="mobile-sidebar" class="mobile-sidebar">
                        ${sidebarContent}
                    </div>
                    
                    <div class="desktop-sidebar">
                        ${sidebarContent}
                    </div>
                `;
            },

            getDashboardView() {
                const totalSales = this.state.sales?.length || 0;
                const totalRevenue = (this.state.sales || []).reduce((sum, sale) => MoneyUtils.add(sum, sale.totalCents || 0), 0);
                const totalProducts = this.state.products?.length || 0;
                const totalCustomers = this.state.customers?.length || 0;

                return `
                    <div class="space-y-6 fade-in">
                        <h2 class="text-3xl font-bold text-white">📊 Dashboard</h2>
                        
                        <!-- KPI Cards -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="perplexity-card p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-400 text-sm font-medium">Total Sales</p>
                                        <p class="text-white text-2xl font-bold">${totalSales}</p>
                                        <p class="text-blue-400 text-sm">Sales recorded</p>
                                    </div>
                                    <div class="w-12 h-12 bg-blue-500/20 rounded-full flex items-center justify-center">
                                        <i class="fas fa-shopping-cart text-blue-400 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="perplexity-card p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-400 text-sm font-medium">Total Revenue</p>
                                        <p class="text-white text-2xl font-bold">$${MoneyUtils.fromCents(totalRevenue).toFixed(2)}</p>
                                        <p class="text-green-400 text-sm">Revenue earned</p>
                                    </div>
                                    <div class="w-12 h-12 bg-green-500/20 rounded-full flex items-center justify-center">
                                        <i class="fas fa-dollar-sign text-green-400 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="perplexity-card p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-400 text-sm font-medium">Products</p>
                                        <p class="text-white text-2xl font-bold">${totalProducts}</p>
                                        <p class="text-purple-400 text-sm">In inventory</p>
                                    </div>
                                    <div class="w-12 h-12 bg-purple-500/20 rounded-full flex items-center justify-center">
                                        <i class="fas fa-box text-purple-400 text-xl"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="perplexity-card p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-400 text-sm font-medium">Customers</p>
                                        <p class="text-white text-2xl font-bold">${totalCustomers}</p>
                                        <p class="text-yellow-400 text-sm">Total customers</p>
                                    </div>
                                    <div class="w-12 h-12 bg-yellow-500/20 rounded-full flex items-center justify-center">
                                        <i class="fas fa-users text-yellow-400 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Welcome Message -->
                        <div class="perplexity-card p-6">
                            <h3 class="text-xl font-bold text-white mb-4">👋 Welcome to Ledgerly!</h3>
                            <p class="text-gray-300 mb-4">
                                Your business management system is running smoothly with all critical errors fixed. 
                                You can now record sales, manage inventory, and track your business performance without any crashes.
                            </p>
                            <div class="flex space-x-4">
                                <button data-action="add-sale" class="perplexity-button">
                                    <i class="fas fa-plus mr-2"></i>Record New Sale
                                </button>
                                <button data-action="sales" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-all">
                                    <i class="fas fa-list mr-2"></i>View All Sales
                                </button>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="perplexity-card p-6">
                            <h3 class="text-xl font-bold text-white mb-4">📈 Recent Activity</h3>
                            <div class="space-y-3">
                                ${totalSales > 0 ? this.state.sales.slice(-3).reverse().map(sale => `
                                    <div class="flex items-center justify-between p-3 bg-gray-700/30 rounded-lg">
                                        <div>
                                            <p class="text-white font-medium">${sale.customerName || 'Unknown Customer'}</p>
                                            <p class="text-gray-400 text-sm">${sale.date} • ${sale.items?.length || 0} items</p>
                                        </div>
                                        <p class="text-green-400 font-bold">$${MoneyUtils.fromCents(sale.totalCents || 0).toFixed(2)}</p>
                                    </div>
                                `).join('') : `
                                    <p class="text-gray-400 text-center py-4">No recent activity</p>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            },

            getSalesView() {
                return `
                    <div class="space-y-6 fade-in">
                        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                            <h2 class="text-3xl font-bold text-white">🛒 Sales Management</h2>
                            <button data-action="add-sale" class="perplexity-button">
                                <i class="fas fa-plus mr-2"></i>Record New Sale
                            </button>
                        </div>

                        <div class="perplexity-card p-6">
                            <h3 class="text-xl font-bold text-white mb-4">📈 All Sales</h3>
                            <div class="space-y-3">
                                ${(this.state.sales || []).length > 0 ? this.state.sales.slice().reverse().map(sale => `
                                    <div class="flex items-center justify-between p-4 bg-gray-700/30 rounded-lg border border-gray-600/50">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-3">
                                                <div class="w-10 h-10 bg-blue-500/20 rounded-full flex items-center justify-center">
                                                    <i class="fas fa-receipt text-blue-400"></i>
                                                </div>
                                                <div>
                                                    <p class="text-white font-medium">${sale.customerName || 'Unknown Customer'}</p>
                                                    <p class="text-gray-400 text-sm">
                                                        ${sale.date} • ${sale.items?.length || 0} items • ${sale.saleType}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-green-400 font-bold text-lg">$${MoneyUtils.fromCents(sale.totalCents || 0).toFixed(2)}</p>
                                            <p class="text-gray-400 text-sm">Sale #${sale.id.split('-').pop()}</p>
                                        </div>
                                    </div>
                                `).join('') : `
                                    <div class="text-center py-12">
                                        <i class="fas fa-shopping-cart text-gray-500 text-6xl mb-4"></i>
                                        <h4 class="text-xl font-bold text-gray-400 mb-2">No Sales Yet</h4>
                                        <p class="text-gray-500 mb-6">Start by recording your first sale!</p>
                                        <button data-action="add-sale" class="perplexity-button">
                                            <i class="fas fa-plus mr-2"></i>Record First Sale
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            },

            // Placeholder views to prevent errors
            getProductsView() { return `<div class="text-white p-6"><h2 class="text-2xl font-bold mb-4">Products</h2><p>Products management coming soon...</p></div>`; },
            getCustomersView() { return `<div class="text-white p-6"><h2 class="text-2xl font-bold mb-4">Customers</h2><p>Customer management coming soon...</p></div>`; },
            getExpensesView() { return `<div class="text-white p-6"><h2 class="text-2xl font-bold mb-4">Expenses</h2><p>Expense tracking coming soon...</p></div>`; },
            getEmployeesView() { return `<div class="text-white p-6"><h2 class="text-2xl font-bold mb-4">Employees</h2><p>Employee management coming soon...</p></div>`; },
            getInvoicesView() { return `<div class="text-white p-6"><h2 class="text-2xl font-bold mb-4">Invoices</h2><p>Invoice management coming soon...</p></div>`; },
            getReportsView() { return `<div class="text-white p-6"><h2 class="text-2xl font-bold mb-4">Reports</h2><p>Business reports coming soon...</p></div>`; },
            getSettingsView() { return `<div class="text-white p-6"><h2 class="text-2xl font-bold mb-4">Settings</h2><p>Application settings coming soon...</p></div>`; },
            getInboxView() { return `<div class="text-white p-6"><h2 class="text-2xl font-bold mb-4">Inbox</h2><p>Message center coming soon...</p></div>`; },
            getAIAssistantView() { return `<div class="text-white p-6"><h2 class="text-2xl font-bold mb-4">AI Assistant</h2><p>AI features coming soon...</p></div>`; },

            getModal(type) {
                if (type === 'add-sale') {
                    return this.getSaleModal();
                }
                return '';
            },

            getSaleModal() {
                // Reset cart when opening modal
                this.currentSaleCart = [];

                return `
                    <div class="modal-overlay">
                        <div class="modal-content" style="max-width: 800px;">
                            <h3 class="text-2xl font-bold text-white mb-6">📝 Record New Sale</h3>
                            <form id="sale-form" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-300 font-medium mb-2">👤 Customer *</label>
                                        <select name="customerId" class="form-input w-full" required>
                                            <option value="">Select Customer</option>
                                            ${(this.state.customers || []).map(customer => 
                                                `<option value="${customer.id}">${customer.name} (${customer.type})</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-300 font-medium mb-2">📅 Sale Date *</label>
                                        <input type="date" name="date" value="${new Date().toISOString().split('T')[0]}" class="form-input w-full" required>
                                    </div>
                                    <div>
                                        <label class="block text-gray-300 font-medium mb-2">💳 Payment Type *</label>
                                        <select name="saleType" class="form-input w-full" required>
                                            <option value="Cash">💰 Cash</option>
                                            <option value="Credit">🏦 Credit</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-300 font-medium mb-2">🏷️ Discount ($)</label>
                                        <input type="number" name="discount" step="0.01" value="0" min="0" class="form-input w-full">
                                    </div>
                                </div>
                                
                                <div>
                                    <h4 class="text-lg font-bold text-white mb-4 flex items-center">
                                        <i class="fas fa-shopping-basket mr-2"></i>Add Products to Sale
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-4">
                                        <select id="product-select" class="form-input">
                                            <option value="">Select Product</option>
                                            ${(this.state.products || []).map(product => 
                                                `<option value="${product.id}">${product.name} - $${MoneyUtils.fromCents(product.priceCents || 0).toFixed(2)} (Stock: ${product.stock})</option>`
                                            ).join('')}
                                        </select>
                                        <input type="number" id="quantity-input" placeholder="Quantity" min="1" class="form-input">
                                        <button type="button" onclick="app.addToSaleCart()" class="perplexity-button">
                                            <i class="fas fa-plus mr-1"></i>Add to Cart
                                        </button>
                                    </div>
                                    
                                    <div id="sale-cart" class="bg-gray-700/30 border border-gray-600/50 rounded-lg p-4 min-h-24">
                                        <p class="text-gray-400 text-center py-4">🛒 No items added yet</p>
                                    </div>
                                </div>
                                
                                <div class="flex space-x-4 pt-6 border-t border-gray-600">
                                    <button type="submit" class="perplexity-button flex-1">
                                        <i class="fas fa-save mr-2"></i>💾 Record Sale
                                    </button>
                                    <button type="button" data-action="close-modal" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                                        <i class="fas fa-times mr-2"></i>Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            }
        };

        // 🚀 Global functions for onclick handlers
        window.app = app;
        window.NotificationSystem = NotificationSystem;
        window.MoneyUtils = MoneyUtils;

        // 🚀 BULLETPROOF INITIALIZATION
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('🚀 DOM loaded, initializing app...');
                app.init();
            } catch (error) {
                console.error('❌ Critical initialization error:', error);
                
                // Emergency fallback UI
                document.getElementById('app').innerHTML = `
                    <div class="flex items-center justify-center min-h-screen bg-red-900/20">
                        <div class="text-center text-white">
                            <h3 class="text-2xl font-bold text-red-400 mb-4">🚨 INITIALIZATION ERROR</h3>
                            <p class="text-gray-300 mb-4">The application failed to start properly.</p>
                            <button onclick="location.reload()" class="bg-red-600 text-white px-8 py-4 rounded-lg text-lg font-bold">
                                🔄 RELOAD PAGE
                            </button>
                        </div>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
